<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>××¢×¨×›×ª × ×™×”×•×œ ×˜×•×¨× ×™×¨ ×©×©-×‘×© (×”×¨××©×•×Ÿ ×œ-3) ×œ-16 ×©×—×§× ×™×</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ×”×’×“×¨×•×ª ×’×•×¤×Ÿ ×•×¨×§×¢ ×›×œ×œ×™ - ×¡×›××” ×× ×¨×’×˜×™×ª ××¢×•×“×›× ×ª */
body {
Â  Â  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
Â  Â  background-color: #0F172A; /* Dark Slate Blue - ×›×—×•×œ ×¦×™ ×œ×™×œ×” */
Â  Â  color: #f3f4f6; /* Light text for contrast */
Â  Â  padding: 1rem;
}

/* ×¡×’× ×•×Ÿ ×›×¤×ª×•×¨×™× ××™×•×—×“ ×œ××©×—×§×™×•×ª - ×‘×•×œ×˜×•×ª ×•×“×™× ××™×•×ª */
button {
Â  Â  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
Â  Â  box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 255, 255, 0.1);
Â  Â  border: 1px solid rgba(255, 255, 255, 0.2);
Â  Â  border-radius: 0.75rem;Â 
}
button:hover {
Â  Â  transform: translateY(-3px) scale(1.03);
Â  Â  box-shadow: 0 15px 25px -3px rgba(0, 0, 0, 0.8), 0 0 15px #3b82f650; /* ×”×‘×”×•×‘ ×§×œ */
}

/* ×¡×’× ×•×Ÿ ×œ××‘× ×” ×”×˜×•×¨× ×™×¨ */
.match-card {
Â  Â  min-width: 220px; /* ×”×’×“×œ×ª ×¨×•×—×‘ ×§×œ×¤×™× */
Â  Â  border: 3px solid #3b82f6; /* ×’×‘×•×œ ×›×—×•×œ ×‘×•×œ×˜ ×œ××©×—×§ */
Â  Â  margin-bottom: 16px; /* 16px = h-4 */
Â  Â  border-radius: 16px;
Â  Â  background: linear-gradient(145deg, #1e293b, #111827); /* ×¨×§×¢ ×›×”×” ×¢× ×¢×•××§ */
Â  Â  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
Â  Â  padding: 0; /* × × ×”×œ ××ª ×”×¨×™×¤×•×“ ×‘×¤× ×™× */
Â  Â  /* ×’×•×‘×” ××—×™×“ ×œ×›×œ ×›×¨×˜×™×¡ (×›×•×œ×œ ×¤×“×™× ×’ ×¤× ×™××™ + ×‘×•×¨×“×¨×™×) ×›×“×™ ×œ××¤×©×¨ ×—×™×©×•×‘×™× ××“×•×™×§×™× ×‘-JS */
Â  Â  height: 80px; /* ×’×•×‘×” ××•×ª×× ×œ×©× ×™ ×”-player-slot-×™× */
}
.player-slot {
Â  Â  /* × ×’×“×™×¨ ×’×•×‘×” ××“×•×™×§ ×œ×›×œ ×¡×œ×•×˜ */
Â  Â  height: 40px;Â 
Â  Â  padding: 6px 14px; /* ×”×§×˜× ×ª ×¤×“×™× ×’ ×× ×›×™ */
Â  Â  margin: 0;Â 
Â  Â  border-radius: 12px;
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  font-weight: 700;
Â  Â  font-size: 1rem; /* ×’×•×“×œ ×¤×•× ×˜ ×§×˜×Ÿ ×™×•×ª×¨ */
Â  Â  position: relative;
Â  Â  z-index: 10;
}


/* ×”×’×‘×”×ª ×”×˜×•×¨× ×™×¨ ×›×“×™ ×œ××¤×©×¨ ×™×™×©×•×¨ ×× ×›×™ ×©×œ ×”×’××¨ */
#bracket {
Â  Â  min-height: 800px;
}

/* ×¡×˜×™×™×œ×™× ×’ ×œ×˜×•×¨× ×™×¨ ×”× ×•×§×××•×˜ - ×”×˜×•×¨ ×”×××¦×¢×™ ××§×‘×œ ×§×• ×”×¤×¨×“×” ×‘×¨×•×¨ */
#tournament-section {
Â  Â  background-color: #1a202c; /* ×¨×§×¢ ×œ×•×— ×›×”×” ×™×•×ª×¨ */
Â  Â  border: 1px solid #374151;
Â  Â  padding: 2rem;
}

.round-column {
Â  Â  min-width: 200px;
Â  Â  margin: 0 10px;
}
/* ×§×• ×× ×›×™ ×œ×’××¨ */
.round-column.is-final-column {
Â  Â  border-left: 3px dashed #FBBF2450;
Â  Â  border-right: 3px dashed #FBBF2450;
Â  Â  padding: 0 20px;
}

/* ×¢×™×¦×•×‘ ××™×•×—×“ ×œ×’××¨ - ×“×’×© ×¢×œ ×’×“×•×œ ×™×•×ª×¨ */
.match-card.final-match {
Â  Â  border-width: 5px;
Â  Â  border-color: #FBBF24; /* ×–×”×‘ */
Â  Â  min-width: 280px;
Â  Â  /* ×‘×™×˜×•×œ ×¡×§×™×™×œ ×“×™× ××™ ×›×“×™ ×œ×©××•×¨ ×¢×œ ×™×™×©×•×¨ ××“×•×™×§ */
Â  Â  transform: none;Â 
Â  Â  box-shadow: 0 15px 30px rgba(245, 158, 11, 0.8);
Â  Â  height: 100px; /* ×’×•×‘×” ×’×“×•×œ ×™×•×ª×¨ ×œ×’××¨ */
}
.match-card.final-match .player-slot {
Â  Â  height: 50px;
Â  Â  font-size: 1.25rem;
Â  Â  padding: 8px 16px;
}


/* ×¢×™×¦×•×‘ ××©×•×¤×¨ ×œ-player-slot (×›×¤×™ ×©×”×™×” ×‘××§×•×¨) */
.player-slot:first-child {
Â  Â  border-bottom: 1px dashed #3b82f640;
Â  Â  border-top-left-radius: 16px;
Â  Â  border-top-right-radius: 16px;
}
.player-slot:last-child {
Â  Â  border-bottom-left-radius: 16px;
Â  Â  border-bottom-right-radius: 16px;
}

.player-slot-empty {
Â  Â  background-color: #3b82f610; /* ×›×—×•×œ ×©×§×•×£ */
Â  Â  color: #93c5fd;Â 
Â  Â  font-style: italic;
Â  Â  border: none;
}
.player-slot-filled {
Â  Â  background-color: #3b82f6; /* ×›×—×•×œ ××§×˜×™×‘×™ ×—×–×§ */
Â  Â  color: #1f2937; /* ×˜×§×¡×˜ ×›×”×” */
Â  Â  cursor: pointer;
Â  Â  box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2); /* ××¤×§×˜ ×¤× ×™××™ ××‘×¨×™×§ */
}
.player-slot-filled:hover {
Â  Â  background-color: #06b6d4; /* ×˜×•×¨×§×™×– ×‘×”×•×‘×¨ */
}
.player-slot-winner {
Â  Â  background: linear-gradient(90deg, #FBBF24, #f59e0b); /* Gold to Darker Gold */
Â  Â  color: #1f2937;
Â  Â  font-weight: 900;
Â  Â  transform: none; /* ×‘×™×˜×•×œ ×¡×§×™×™×œ ×›×“×™ ×œ×©××•×¨ ×¢×œ ×™×™×©×•×¨ */
Â  Â  border: 3px solid #f59e0b;
}
.player-slot-loser {
Â  Â  background-color: #ef4444; /* ××“×•× */
Â  Â  color: #1f2937;
Â  Â  text-decoration: line-through;
Â  Â  opacity: 0.7;
Â  Â  font-weight: 500;
}

/* ×¡×’× ×•×Ÿ ××™×•×—×“ ×œ×›×¨×˜×™×¡ ×”× ×™×¦×—×•×Ÿ - ××¤×§×˜ ×—×’×™×’×™ ×™×•×ª×¨ */
#champion-card-container {
Â  Â  background: linear-gradient(135deg, #1A3D5D, #275078);
Â  Â  border: 5px solid #FBBF24;
}
#champion-card {
Â  Â  background: radial-gradient(circle at center, #f59e0b, #ef4444); /* ××¢×‘×¨ ×¨×“×™××œ×™ */
Â  Â  color: #fff;
Â  Â  padding: 3rem;
Â  Â  border-radius: 18px;
Â  Â  text-align: center;
Â  Â  font-size: 3.2rem;
Â  Â  font-weight: 900;
Â  Â  text-shadow: 0 0 10px #fff;
Â  Â  box-shadow: 0 15px 30px rgba(245, 158, 11, 0.8);
Â  Â  animation: pulse 1.5s infinite;
}

@keyframes pulse {
Â  Â  0% { transform: scale(1); box-shadow: 0 15px 30px rgba(245, 158, 11, 0.8); }
Â  Â  50% { transform: scale(1.03); box-shadow: 0 15px 40px rgba(245, 158, 11, 1); }
Â  Â  100% { transform: scale(1); box-shadow: 0 15px 30px rgba(245, 158, 11, 0.8); }
}

/* ×›×¤×ª×•×¨×™ ×”××•×“××œ */
#btn-p1-win, #btn-p2-win {
Â  Â  background: linear-gradient(90deg, #3b82f6, #06b6d4); /* Blue-Cyan Gradient */
Â  Â  color: white;
}

</style>
</head>
<body class="rtl text-right">

<!-- ×©×™× ×•×™ ×¦×‘×¢×™ ×¨×§×¢ ×•×›×•×ª×¨×•×ª ×œ×××‘×¨ ×•×‘×•×œ×˜×•×ª -->
<div class="text-center py-6 bg-slate-900 rounded-b-3xl mb-8 shadow-2xl border-b-4 border-cyan-500">
Â  Â  <h1 class="text-5xl font-black text-amber-400 tracking-wider">ğŸ† ×˜×™×•×œ ×’×‘×¨×™×: ×˜×•×¨× ×™×¨ ×©×©-×‘×© ğŸ²</h1>
Â  Â  <!-- ×¢×“×›×•×Ÿ ×œ-16 ×©×—×§× ×™× -->
Â  Â  <p class="text-xl text-cyan-300 mt-2 font-semibold">×¤×•×¨××˜: **×”×¨××©×•×Ÿ ×œ-3 × ×™×¦×—×•× ×•×ª ××©×—×§** (×˜×•×¨× ×™×¨ 16 ×©×—×§× ×™×)</p>
</div>

<!-- ×›×¤×ª×•×¨×™ ×‘×§×¨×” -->
<div class="flex justify-center mb-8 space-x-6 space-x-reverse">
Â  Â  <!-- ×›×¤×ª×•×¨ ×”×ª×—×œ×” ×‘×˜×•×¨×§×™×– ×‘×•×œ×˜ -->
Â  Â  <button id="start-tournament" class="bg-teal-600 text-white px-8 py-4 rounded-xl font-extrabold text-xl hover:bg-teal-700 transition duration-150">ğŸš€ ×”×ª×—×œ ×˜×•×¨× ×™×¨ (×¦×¨×™×š 16 ×©×—×§× ×™×)</button>
Â  Â Â 
Â  Â  <!-- ×›×¤×ª×•×¨ ××™×¤×•×¡ ×‘×›×ª×•× ×—×–×§ -->
Â  Â  <button id="reset-tournament" onclick="window.resetTournament()" class="bg-orange-700 text-white px-8 py-4 rounded-xl font-extrabold text-xl hover:bg-red-800 transition duration-150">âŒ ××¤×¡ ×˜×•×¨× ×™×¨</button>
</div>

<!-- ×”×•×“×¢×•×ª ×¡×˜×˜×•×¡ -->
<div id="status-message" class="text-center text-xl font-semibold mb-6 text-yellow-500 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto"></div>


<!-- ×˜×•×¤×¡ ×¨×™×©×•× ×©×—×§× ×™× -->
<div id="registration-section" class="bg-slate-800 p-8 rounded-3xl mb-8 shadow-2xl border border-cyan-500/50 max-w-4xl mx-auto">
Â  Â  <!-- ×¢×“×›×•×Ÿ ×œ-16 ×©×—×§× ×™× -->
Â  Â  <h2 class="text-3xl font-bold text-amber-300 mb-5 border-b border-amber-300/30 pb-3 flex items-center gap-3">
Â  Â  Â  Â  <span class="text-4xl">ğŸ‘¥</span>
Â  Â  Â  Â  ×¨×©×™××ª ×”×œ×•×—××™× (<span id="team-count">0</span>/16)
Â  Â  </h2>
Â  Â  <form id="add-team-form" class="flex gap-4 mb-4">
Â  Â  Â  Â  <input id="team-name" class="flex-grow p-4 bg-slate-700 border-2 border-cyan-400 rounded-xl text-white placeholder-gray-400 focus:ring-cyan-500 focus:border-cyan-500 text-right text-lg shadow-inner" placeholder="×”×›× ×¡ ×©× ×©×—×§×Ÿ/×›×™× ×•×™ ××§×•×¨×™..." required />
Â  Â  Â  Â  <!-- ×›×¤×ª×•×¨ ×”×•×¡×¤×” ×‘×›×—×•×œ ×—×™ -->
Â  Â  Â  Â  <button id="add-team" class="bg-cyan-600 p-4 rounded-xl hover:bg-cyan-700 text-white font-bold text-lg" disabled>â• ×”×•×¡×£ ×©×—×§×Ÿ</button>
Â  Â  </form>
Â  Â  <div id="registration-alert" class="text-sm h-4 mb-2 text-center"></div>

Â  Â  <ul id="teams-list" class="mt-4 text-gray-200 space-y-3">
Â  Â  Â  Â  <!-- ×¨×©×™××ª ×”×©×—×§× ×™× ×ª×•×¦×’ ×›××Ÿ -->
Â  Â  </ul>
</div>

<!-- ×ª×¦×•×’×ª ×˜×•×¨× ×™×¨ -->
<div id="tournament-section" class="bg-slate-900 p-6 rounded-3xl shadow-2xl hidden border border-cyan-500/30">
Â  Â  <h2 class="text-4xl font-black text-amber-400 mb-8 text-center border-b border-amber-400/30 pb-4">âš”ï¸ ×œ×•×— ×”×§×¨×‘×•×ª ×”××¨×›×–×™ - × ×•×§×××•×˜ 16 âš”ï¸</h2>
Â  Â  <div id="bracket" class="flex justify-center overflow-x-auto p-4">
Â  Â  Â  Â  <!-- ××‘× ×” ×”×˜×•×¨× ×™×¨ ×™×•×˜×¢×Ÿ ×›××Ÿ -->
Â  Â  </div>
</div>

<!-- ××•×“××œ ×œ×¢×“×›×•×Ÿ ×ª×•×¦××•×ª - ×”×˜×•×‘ ×-5 -->
<div id="result-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50 p-4">
Â  Â  <div class="bg-slate-800 p-8 rounded-3xl w-full max-w-lg shadow-2xl border-4 border-amber-500 animate-in zoom-in duration-300">
Â  Â  Â  Â  <h3 id="modal-title" class="text-3xl font-black text-amber-400 mb-6 text-center border-b border-amber-400/30 pb-3">×¢×“×›×•×Ÿ ×ª×•×¦××ª ××©×—×§</h3>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="modal-score-display" class="text-4xl text-center mb-6 font-extrabold text-cyan-300 bg-slate-700 p-4 rounded-xl border border-cyan-400 shadow-lg"></div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <input type="hidden" id="match-id" />

Â  Â  Â  Â  <p class="text-xl text-center font-semibold text-white mb-6">××™ × ×™×¦×— ×‘××©×—×§ ×”×‘×•×“×“ ×”××—×¨×•×Ÿ? (×©×©-×‘×©)</p>

Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  <!-- P1 Win Button -->
Â  Â  Â  Â  Â  Â  <button type="button" id="btn-p1-win" onclick="window.handleGameWin(document.getElementById('match-id').value, 1)" class="w-full p-5 rounded-2xl text-white font-black transition duration-150 flex justify-between items-center text-2xl shadow-xl hover:shadow-cyan-400/50">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="name-player1" class="text-2xl font-black"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xl">× ×™×¦×—×•×Ÿ ×‘××©×—×§ ğŸ¯</span>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="text-center text-3xl font-black text-amber-500">××•</div>

Â  Â  Â  Â  Â  Â  <!-- P2 Win Button -->
Â  Â  Â  Â  Â  Â  <button type="button" id="btn-p2-win" onclick="window.handleGameWin(document.getElementById('match-id').value, 2)" class="w-full p-5 rounded-2xl text-white font-black transition duration-150 flex justify-between items-center text-2xl shadow-xl hover:shadow-cyan-400/50">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="name-player2" class="text-2xl font-black"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xl">× ×™×¦×—×•×Ÿ ×‘××©×—×§ ğŸ¯</span>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="flex justify-center pt-8">
Â  Â  Â  Â  Â  Â  <button type="button" onclick="window.closeModal()" class="bg-gray-700 hover:bg-gray-600 p-4 rounded-xl text-white font-semibold transition duration-150 text-xl shadow-md">×¡×’×•×¨ / ×—×–×•×¨ ×œ×œ×•×—</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<!-- ×”×•×“×¢×ª ×¡×™××•×Ÿ -->
<div id="modal-placeholder" class="fixed inset-0 flex items-center justify-center hidden bg-black bg-opacity-70 z-50 p-4">
Â  Â  <div id="champion-card-container" class="max-w-xl bg-gray-800 p-1 rounded-3xl shadow-2xl">
Â  Â  Â  Â  <div id="champion-card">
Â  Â  Â  Â  Â  Â  <!-- ×”×•×“×¢×ª ×”× ×™×¦×—×•×Ÿ ×ª×•×˜×¢×Ÿ ×›××Ÿ -->
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="text-center p-4">
Â  Â  Â  Â  Â  Â  <button onclick="window.closeChampionModal()" class="bg-cyan-600 text-white px-10 py-4 rounded-xl font-black hover:bg-cyan-700 transition duration-150 shadow-lg text-xl">×¡×’×•×¨ ×•×—×–×•×¨ ×œ×œ×•×—</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
// --- ×”×’×“×¨×•×ª ×’×œ×•×‘×œ×™×•×ª ---
const STORAGE_KEY = 'backgammon_tournament_16_players_v2';
const WINS_TO_WIN_MATCH = 3; // ×”×¨××©×•×Ÿ ×œ-3 × ×™×¦×—×•× ×•×ª ××©×—×§ (×”×˜×•×‘ ×-5)
const MAX_PLAYERS = 16; // *** ×¢×“×›×•×Ÿ ×œ-16 ×©×—×§× ×™× ***
// ×’×•×‘×” ×›×¨×˜×™×¡ ××©×—×§ (80px) + ××¨×•×•×— ×ª×—×ª×•×Ÿ (mb-4 = 16px).
// ×–×”×• ×”×’×•×‘×” ×”×œ×•×’×™ ×©×œ '×©×•×¨×” ××—×ª' ×‘×˜×•×¨× ×™×¨.
const MATCH_HEIGHT_UNIT = 80 + 16; // 96pxÂ 

// ×¨×©×™××ª ×”×›×™× ×•×™×™× ×”××¦×—×™×§×™× (16 ×›× ×™×¡×•×ª)
const FUNNY_NICKNAMES = [
Â  Â  "×”×§×•×‘×™×” ×”××©×ª×•×œ×œ×ª", "×”××–×œ×–×œ ×”× ×¦×—×™", "×”×× ×’×œ×™×¡×˜ ×”×¨××©×™", "×˜×¨×™×§-×©×©-×‘×©",
Â  Â  "×”×©×—×§×Ÿ ×”×œ×™×œ×™", "×—×¡×™××ª ×”×¦×”×¨×™×™×", "×”×“××‘×œ ×©×œ ×©×™×©×™", "×”××œ×•×£ ×”×ª×•×¨×Ÿ",
Â  Â  "×”×¤×•×¨×§×Ÿ ×©×œ ××•×¦'×™", "× ××¨ ×”×˜××‘×œ×”", "×’× ×‘ ×”×§×•×‘×™×•×ª", "××œ×•×£ ×”××™× ×™××•×",
Â  Â  "×©×œ×™×— ×”×’××œ×™×", "×”××œ×š ×”××©×›× ×–×™", "×”××’×Ÿ ×”×˜×•×¨×§×™", "×”××¢×™×£ ×”××§×¦×•×¢×™"
];

// --- DOM elements ---
const teamNameInput = document.getElementById('team-name');
const addTeamButton = document.getElementById('add-team');
const startTournamentButton = document.getElementById('start-tournament');
const teamsListElement = document.getElementById('teams-list');
const teamCountElement = document.getElementById('team-count');
const bracketElement = document.getElementById('bracket');
const registrationSection = document.getElementById('registration-section');
const tournamentSection = document.getElementById('tournament-section');
const statusMessage = document.getElementById('status-message');
const registrationAlert = document.getElementById('registration-alert');
const resultModal = document.getElementById('result-modal');
const championModal = document.getElementById('modal-placeholder');
const championCard = document.getElementById('champion-card');

// ×”×’×“×¨×” ×©×œ ××¦×‘ ×”×ª×—×œ×ª×™ ×¢× 4 ×¡×‘×‘×™× ×œ×•×’×™×™×
const initialTournamentData = {
Â  Â  teams: [],Â 
Â  Â  status: 'registration', // 'registration', 'in_progress', 'finished'
Â  Â  matches: {
Â  Â  Â  Â  roundOf16: [], // ×©××™× ×™×ª ×’××¨ - 8 ××©×—×§×™×
Â  Â  Â  Â  quarterfinals: [], // ×¨×‘×¢ ×’××¨ - 4 ××©×—×§×™×
Â  Â  Â  Â  semifinals: [], // ×—×¦×™ ×’××¨ - 2 ××©×—×§×™×
Â  Â  Â  Â  final: [] // ×’××¨ - 1 ××©×—×§
Â  Â  },
Â  Â  winner: null,
Â  Â  showChampionModal: falseÂ 
};

let tournamentData = { ...initialTournamentData }; // ×©×™××•×© ×‘××•×‘×™×™×§×˜ ×”×ª×—×œ×ª×™

// --- Utilities ---

function showRegistrationAlert(message, type = 'info') {
Â  Â  registrationAlert.textContent = message;
Â  Â  registrationAlert.className = `text-sm h-4 mb-2 text-center ${type === 'error' ? 'text-red-400' : 'text-lime-400'}`;
Â  Â  setTimeout(() => {
Â  Â  Â  Â  registrationAlert.textContent = '';
Â  Â  Â  Â  registrationAlert.className = 'text-sm h-4 mb-2 text-center';
Â  Â  }, 3000);
}

function shuffle(array) {
Â  Â  for (let i = array.length - 1; i > 0; i--) {
Â  Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  Â  [array[i], array[j]] = [array[j], array[i]];
Â  Â  }
Â  Â  return array;
}

function generateId() {
Â  Â  return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
}

function getAvailableNickname(currentTeams) {
Â  Â  const usedNicknames = new Set(currentTeams.map(t => t.nickname).filter(n => n));
Â  Â  const availableNicknames = FUNNY_NICKNAMES.filter(n => !usedNicknames.has(n));

Â  Â  if (availableNicknames.length === 0) {
Â  Â  Â  Â  return null; // ××™×Ÿ ×›×™× ×•×™×™× ×¤× ×•×™×™×
Â  Â  }

Â  Â  const randomIndex = Math.floor(Math.random() * availableNicknames.length);
Â  Â  return availableNicknames[randomIndex];
}

/**
Â * ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ××¦×™××ª ××•×‘×™×™×§×˜ ××©×—×§ ×œ×¤×™ ××–×”×” (ID) ×©×œ×• ×‘×ª×•×š ×›×œ ×”×¡×™×‘×•×‘×™×.
Â */
function getMatchById(id) {
Â  Â  const rounds = tournamentData.matches;
Â  Â  for (const roundKey in rounds) {
Â  Â  Â  Â  const match = rounds[roundKey].find(m => m.id === id);
Â  Â  Â  Â  if (match) return match;
Â  Â  }
Â  Â  return null;
}

// --- Modal Handlers (Complete Implementation) ---

window.closeModal = () => {
Â  Â  resultModal.classList.add('hidden');
};

window.closeChampionModal = () => {
Â  Â  tournamentData.showChampionModal = false;
Â  Â  saveTournamentState(); // ×©××™×¨×” ×•×¨×™× ×“×•×¨ ××—×“×©
}

/**
Â * ×¤×•×ª×— ××ª ×”××•×“××œ ×•×××œ× ××•×ª×• ×‘× ×ª×•× ×™ ×”××©×—×§ ×”× ×•×›×—×™.
Â */
window.openModal = (matchId) => {
Â  Â  const match = getMatchById(matchId);
Â  Â  // ×‘×“×™×§×” × ×•×¡×¤×ª: ×œ×•×•×“× ×©×”××©×—×§ ×§×™×™×, ×œ× ×”×¡×ª×™×™× ×•×™×© ×‘×• ×©× ×™ ×©×—×§× ×™×
Â  Â  if (!match || match.winnerId || !match.player1 || !match.player2) return;

Â  Â  document.getElementById('match-id').value = matchId;
Â  Â Â 
Â  Â  // ×”×¦×’×ª ×”×›×™× ×•×™ ×”×¨××©×™ ×‘××•×“××œ
Â  Â  const p1DisplayName = match.player1.nickname || match.player1.name;
Â  Â  const p2DisplayName = match.player2.nickname || match.player2.name;

Â  Â  document.getElementById('modal-title').textContent = `×¢×“×›×•×Ÿ ×ª×•×¦××”: ${p1DisplayName} × ×’×“ ${p2DisplayName}`;

Â  Â  document.getElementById('modal-score-display').innerHTML = `
Â  Â  Â  Â  <span class="text-amber-400">${p1DisplayName}</span> (${match.gameWins1})
Â  Â  Â  Â  <span class="mx-4 text-white"> - × ×’×“ - </span>
Â  Â  Â  Â  <span class="text-amber-400">${p2DisplayName}</span> (${match.gameWins2})
Â  Â  `;

Â  Â  // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™ ×”× ×™×¦×—×•×Ÿ
Â  Â  document.getElementById('btn-p1-win').innerHTML = `
Â  Â  Â  Â  <span class="text-2xl font-black">${p1DisplayName}</span>
Â  Â  Â  Â  <span class="text-xl">× ×™×¦×—×•×Ÿ ×‘××©×—×§ ğŸ¯</span>
Â  Â  `;

Â  Â  document.getElementById('btn-p2-win').innerHTML = `
Â  Â  Â  Â  <span class="text-2xl font-black">${p2DisplayName}</span>
Â  Â  Â  Â  <span class="text-xl">× ×™×¦×—×•×Ÿ ×‘××©×—×§ ğŸ¯</span>
Â  Â  `;

Â  Â  resultModal.classList.remove('hidden');
}

// --- Local Storage Functions ---

function loadData() {
Â  Â  try {
Â  Â  Â  Â  const storedData = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  if (storedData) {
Â  Â  Â  Â  Â  Â  const parsedData = JSON.parse(storedData);
Â  Â  Â  Â  Â  Â  if (parsedData && Array.isArray(parsedData.teams) && typeof parsedData.status === 'string') {
Â  Â  Â  Â  Â  Â  Â  Â  tournamentData = { ...initialTournamentData, ...parsedData };
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Local Storage: Stored data is corrupted or invalid. Starting fresh.");
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  tournamentData = { ...initialTournamentData };Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  tournamentData = { ...initialTournamentData };Â 
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Local Storage: Error loading data:", e);
Â  Â  Â  Â  tournamentData = { ...initialTournamentData };
Â  Â  }
}

function saveTournamentState() {
Â  Â  try {
Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(tournamentData));
Â  Â  Â  Â  renderTournament(tournamentData); // ×¨×™× ×“×•×¨ ××™×™×“×™ ×œ××—×¨ ×©××™×¨×”
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Local Storage: Error saving data:", e);
Â  Â  Â  Â  showRegistrationAlert("×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×‘×“×¤×“×¤×Ÿ.", 'error');
Â  Â  }
}

window.resetTournament = () => {
Â  Â  // ×”×©×ª××© ×‘×œ×•×’×™×§×” ×©×× ×™×—×” ××™×©×•×¨ ×‘××§×•× confirm() ×©××¡×•×¨.
Â  Â  if (true) {
Â  Â  Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  Â  Â  tournamentData = { ...initialTournamentData };
Â  Â  Â  Â  initializeApp();
Â  Â  Â  Â  statusMessage.textContent = 'ğŸ§¹ ×”×˜×•×¨× ×™×¨ ××•×¤×¡ ×‘×”×¦×œ×—×”! × ×™×ª×Ÿ ×œ×”×ª×—×™×œ ×¨×™×©×•× ××—×“×©.';
Â  Â  Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-4 text-amber-400 bg-slate-700/50 p-3 rounded-xl max-w-4xl mx-auto";
Â  Â  }
};

function initializeApp() {
Â  Â  loadData();
Â  Â  renderTournament(tournamentData);
Â  Â Â 
Â  Â  addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= MAX_PLAYERS || teamNameInput.value.trim() === '';
Â  Â Â 
Â  Â  if (tournamentData.status !== 'registration') {
Â  Â  Â  Â  statusMessage.textContent = tournamentData.status === 'finished' ?Â 
Â  Â  Â  Â  Â  Â  'ğŸ‰ ×”×˜×•×¨× ×™×¨ ×”×¡×ª×™×™×! ×œ×—×¥ "××¤×¡ ×˜×•×¨× ×™×¨" ×›×“×™ ×œ×”×ª×—×™×œ ×—×“×©.' :Â 
Â  Â  Â  Â  Â  Â  'ğŸ² ×”×˜×•×¨× ×™×¨ ×‘×¢×™×¦×•××•! × ×ª×•× ×™× × ×©××¨×™× ××§×•××™×ª.';
Â  Â  Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-6 text-cyan-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
Â  Â  } else {
Â  Â  Â  Â  statusMessage.textContent = `âœ… ××¦×‘ ××§×•××™ (Local Storage) ×¤×¢×™×œ. ×”× ×ª×•× ×™× × ×©××¨×™× ×‘×“×¤×“×¤×Ÿ ×–×”. ×™×© ×œ×¨×©×•× ${MAX_PLAYERS} ×©×—×§× ×™×.`;
Â  Â  Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-6 text-lime-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
Â  Â  }
}


// --- UI Rendering ---

function renderTournament(data) {
Â  Â  const { teams, status, winner, showChampionModal } = data;

Â  Â  // 1. ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×©×—×§× ×™× ×•×›×¤×ª×•×¨ ×”×”×ª×—×œ×”
Â  Â  teamsListElement.innerHTML = '';
Â  Â  teamCountElement.textContent = teams.length;
Â  Â Â 
Â  Â  teams.forEach((team, index) => {
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  li.className = 'flex justify-between items-center bg-slate-700 p-3 rounded-xl text-white font-medium shadow-md border border-cyan-500/30';Â 
Â  Â  Â  Â  // *** ×©×™× ×•×™: ×”×¦×’×ª ×”×›×™× ×•×™ ×›×©× ×”×¨××©×™ ×•×”×©× ×”××§×•×¨×™ ×‘×¡×•×’×¨×™×™× ***
Â  Â  Â  Â  const displayName = `${team.nickname || '××™×Ÿ ×›×™× ×•×™'} <span class="text-amber-300 font-normal">(${team.name})</span>`;
Â  Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  Â  Â  <span class="text-xl">${index + 1}. ${displayName}</span>
Â  Â  Â  Â  Â  Â  <button class="text-red-400 hover:text-red-500 text-lg bg-transparent p-1 rounded-full hover:bg-red-900/50 transition font-bold" onclick="removeTeam('${team.id}')" ${status !== 'registration' ? 'disabled' : ''}>[X] ×”×¡×¨</button>
Â  Â  Â  Â  `;
Â  Â  Â  Â  teamsListElement.appendChild(li);
Â  Â  });

Â  Â  if (teams.length === 0) {
Â  Â  Â  Â  teamsListElement.innerHTML = `<li class="text-gray-400 text-center py-4 italic text-lg">ğŸ² × ×“×¨×©×™× ${MAX_PLAYERS} ×©×—×§× ×™× ×œ×”×ª×—×œ×ª ×”×˜×•×¨× ×™×¨. ×”×•×¡×£ ×©×—×§× ×™× ×œ××¢×œ×”.</li>`;
Â  Â  }

Â  Â  // 2. × ×™×”×•×œ ××¦×‘ ×”×”×¨×©××” ×•×›×¤×ª×•×¨ ×”'×”×ª×—×œ ×˜×•×¨× ×™×¨'
Â  Â  const teamCount = teams.length;
Â  Â  const hasAvailableNicknames = getAvailableNickname(teams) !== null || teamCount === MAX_PLAYERS;
Â  Â Â 
Â  Â  addTeamButton.disabled = tournamentData.status !== 'registration' || teamCount >= MAX_PLAYERS || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
Â  Â Â 
Â  Â  startTournamentButton.disabled = tournamentData.status !== 'registration' || teamCount !== MAX_PLAYERS;
Â  Â  startTournamentButton.textContent = teamCount === MAX_PLAYERS ? 'ğŸš€ ×”×ª×—×œ ×˜×•×¨× ×™×¨! ×™××œ×œ×” ×‘×œ××’×Ÿ' : `×¦×¨×™×š ×¢×•×“ ${MAX_PLAYERS - teamCount} ×©×—×§× ×™×`;

Â  Â  if (status === 'registration') {
Â  Â  Â  Â  registrationSection.classList.remove('hidden');
Â  Â  Â  Â  tournamentSection.classList.add('hidden');
Â  Â  } else {
Â  Â  Â  Â  registrationSection.classList.add('hidden');
Â  Â  Â  Â  tournamentSection.classList.remove('hidden');
Â  Â  }
Â  Â Â 
Â  Â  // 3. ×”×¦×’×ª ×˜×‘×œ×ª ×”× ×•×§×××•×˜
Â  Â  renderSplitBracket(data.matches, winner, showChampionModal);
}

// ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª ×œ×”×¦×’×ª ××‘× ×” ×”×˜×•×¨× ×™×¨ ×”××¤×•×¦×œ ×œ-16 ×©×—×§× ×™× ×¢× ×™×™×©×•×¨ ××©×•×¤×¨
function renderSplitBracket(matches, tournamentWinner, showChampionModal) {
Â  Â  bracketElement.innerHTML = '';

Â  Â  if (tournamentWinner && showChampionModal) {
Â  Â  Â  Â  championCard.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="flex flex-col items-center space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-8xl">ğŸ‘‘</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-4xl font-extrabold text-white">×”×× ×¦×— ×©×œ ×”×˜×™×•×œ:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-7xl font-black text-white">${tournamentWinner.nickname || tournamentWinner.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-3xl mt-4 text-cyan-200">(${tournamentWinner.name}) ×–×›×™×ª ×‘×›×‘×•×“ ×”× ×¦×—×™!</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  championModal.classList.remove('hidden');
Â  Â  } else {
Â  Â  Â  Â  championModal.classList.add('hidden');
Â  Â  }

Â  Â  // ×¨×™×›×•×– ×›×œ ×”××©×—×§×™× ×œ×¤×™ ××–×”×” ×œ×©×œ×™×¤×” × ×•×—×”
Â  Â  const allMatches = [...matches.roundOf16, ...matches.quarterfinals, ...matches.semifinals, ...matches.final].reduce((acc, m) => {
Â  Â  Â  Â  acc[m.id] = m;
Â  Â  Â  Â  return acc;
Â  Â  }, {});

Â  Â  // ×”×’×“×¨×ª ××‘× ×” ×”×˜×•×¨× ×™×¨ ×”××¤×•×¦×œ ×œ-7 ×˜×•×¨×™×
Â  Â  const H = MATCH_HEIGHT_UNIT; // 96px (Match Card height + margin-bottom)

Â  Â  // ×—×™×©×•×‘ ×¨×•×•×—×™× ××“×•×™×§×™× (×‘×›×¤×•×œ×•×ª ×©×œ H) ×œ×™×™×©×•×¨ ×× ×›×™
Â  Â  // R16 (4 matches, 1H between them, 0.5H initial offset)
Â  Â  // ×”×¢×¨×•×ª ×™×™×©×•×¨: ×›×“×™ ×œ×¨×›×– ××ª ×”×˜×•×¨ ×”×‘×, ×”×•× ×¦×¨×™×š ×œ×”×™×•×ª ××¨×•×›×– ×‘×™×Ÿ ×©× ×™ ×”××©×—×§×™× ×©×œ ×”×˜×•×¨ ×”×§×•×“×.
Â  Â  // 0.5H ×–×” ×”××¨×•×•×— ××ª×—×™×œ×ª ×”×˜×•×¨ ×¢×“ ×××¦×¢ ×”××©×—×§ ×”×¨××©×•×Ÿ.
Â  Â  // 1.0H ×–×” ×”××¨×—×§ ×‘×™×Ÿ ××¨×›×– ××©×—×§ ×œ××¨×›×– ××©×—×§ ×‘×˜×•×¨ R16.
Â  Â Â 
Â  Â  // R16: [48, 96, 96, 96]
Â  Â  const R16_Spacers = [H * 0.5, H, H, H];Â 

Â  Â  // QF: ××¨×•×›×– ×‘×™×Ÿ R16 ×–×•×’×•×ª. ×”××¨×•×•×— ×-QF1 ×¢×“ ××¨×›×– R16-M1/M2 ×”×•× 1.5H
Â  Â  // 1.5H (48 + 48) | 3.0H (96 + 96 + 96)
Â  Â  const QF_Spacers = [H * 1.5, H * 3.0];Â 

Â  Â  // SF: ××¨×•×›×– ×‘×™×Ÿ QF ×–×•×’×•×ª. ×”××¨×•×•×— ×-SF1 ×¢×“ ××¨×›×– QF-M1/M2 ×”×•× 3.5H
Â  Â  // 3.5H (48 + 96 + 96 + 96)
Â  Â  const SF_Spacers = [H * 3.5];

Â  Â  // FINAL: ××¨×•×›×– ×‘××¨×›×–.
Â  Â  const Final_Spacers = [H * 3.5];


Â  Â  const columnStructure = [
Â  Â  Â  Â  // 1. ×©××™× ×™×ª ×’××¨ - ×™××™×Ÿ (R16_R) - 4 ××©×—×§×™× (1, 2, 3, 4)
Â  Â  Â  Â  { key: 'R16_R', title: '×©××™× ×™×ª ×’××¨', matchIds: ['r1m1', 'r1m2', 'r1m3', 'r1m4'], spacerHeights: R16_Spacers, titleColor: 'text-cyan-400' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. ×¨×‘×¢ ×’××¨ - ×™××™×Ÿ (QF_R) - 2 ××©×—×§×™× (1, 2)
Â  Â  Â  Â  { key: 'QF_R', title: '×¨×‘×¢ ×’××¨', matchIds: ['r2m1', 'r2m2'], spacerHeights: QF_Spacers, titleColor: 'text-cyan-400' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 3. ×—×¦×™ ×’××¨ - ×™××™×Ÿ (SF_R) - 1 ××©×—×§ (1)
Â  Â  Â  Â  { key: 'SF_R', title: '×—×¦×™ ×’××¨', matchIds: ['r3m1'], spacerHeights: SF_Spacers, titleColor: 'text-cyan-400' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 4. ×’××¨ (Final) - 1 ××©×—×§ - ××¨×›×– (×’×“×•×œ ×™×•×ª×¨)
Â  Â  Â  Â  { key: 'Final', title: '×”×’××¨ ×”×’×“×•×œ', matchIds: ['r4m1'], spacerHeights: Final_Spacers, isFinal: true, titleColor: 'text-amber-300' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 5. ×—×¦×™ ×’××¨ - ×©×××œ (SF_L) - 1 ××©×—×§ (2)
Â  Â  Â  Â  { key: 'SF_L', title: '×—×¦×™ ×’××¨', matchIds: ['r3m2'], spacerHeights: SF_Spacers, titleColor: 'text-cyan-400' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 6. ×¨×‘×¢ ×’××¨ - ×©×××œ (QF_L) - 2 ××©×—×§×™× (3, 4)
Â  Â  Â  Â  { key: 'QF_L', title: '×¨×‘×¢ ×’××¨', matchIds: ['r2m3', 'r2m4'], spacerHeights: QF_Spacers, titleColor: 'text-cyan-400' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 7. ×©××™× ×™×ª ×’××¨ - ×©×××œ (R16_L) - 4 ××©×—×§×™× (5, 6, 7, 8)
Â  Â  Â  Â  { key: 'R16_L', title: '×©××™× ×™×ª ×’××¨', matchIds: ['r1m5', 'r1m6', 'r1m7', 'r1m8'], spacerHeights: R16_Spacers, titleColor: 'text-cyan-400' },
Â  Â  ];


Â  Â  columnStructure.forEach(col => {
Â  Â  Â  Â  const roundColumn = document.createElement('div');
Â  Â  Â  Â  roundColumn.className = `flex flex-col items-center p-2 mx-2 ${col.isFinal ? 'is-final-column' : 'round-column'}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let preTitle = '';

Â  Â  Â  Â  if (col.isFinal) {
Â  Â  Â  Â  Â  Â  // ×©×™× ×•×™ ×”×›×•×›×‘ ×œ×’×‘×™×¢
Â  Â  Â  Â  Â  Â  preTitle = '<div class="text-4xl text-amber-500 mb-2">ğŸ†</div>';Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ×”×•×¡×¤×ª ×›×•×ª×¨×ª ×œ×›×œ ×˜×•×¨
Â  Â  Â  Â  roundColumn.innerHTML = `
Â  Â  Â  Â  Â  Â  ${preTitle}
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-black ${col.titleColor} mb-6 text-center">${col.title}</h3>
Â  Â  Â  Â  `;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let spacerIndex = 0;

Â  Â  Â  Â  col.matchIds.forEach((matchId) => {
Â  Â  Â  Â  Â  Â  const match = allMatches[matchId];
Â  Â  Â  Â  Â  Â  if (!match) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ×”×•×¡×¤×ª ×¨×•×•×— ×œ×¤× ×™ ×”××©×—×§
Â  Â  Â  Â  Â  Â  if (col.spacerHeights[spacerIndex] !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  const spacerHeight = col.spacerHeights[spacerIndex];
Â  Â  Â  Â  Â  Â  Â  Â  const spacer = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  spacer.style.height = `${spacerHeight}px`;
Â  Â  Â  Â  Â  Â  Â  Â  spacer.className = `w-full`;
Â  Â  Â  Â  Â  Â  Â  Â  roundColumn.appendChild(spacer);
Â  Â  Â  Â  Â  Â  Â  Â  spacerIndex++;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const matchContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  matchContainer.id = match.id;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let matchClass = 'match-card mb-4 rounded-xl flex flex-col justify-center';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ×¢×™×¦×•×‘ ××™×•×—×“ ×œ×’××¨ (×”×¤×™×›×” ×œ×’×“×•×œ ×™×•×ª×¨)
Â  Â  Â  Â  Â  Â  if (matchId === 'r4m1') {
Â  Â  Â  Â  Â  Â  Â  Â  matchClass += ' final-match'; // ×©×™××•×© ×‘×§×œ××¡ CSS ×©×”×•×’×“×¨ ×œ××¢×œ×”
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  matchContainer.className = matchClass;

Â  Â  Â  Â  Â  Â  const matchInfo = document.createElement('div');
Â  Â  Â  Â  Â  Â  matchInfo.className = 'flex flex-col w-full';

Â  Â  Â  Â  Â  Â  // ×©×™××•×© ×‘×¤×•× ×§×¦×™×” createPlayerSlot ×”××•×’×“×¨×ª
Â  Â  Â  Â  Â  Â  const player1Slot = createPlayerSlot(match, match.player1, match.gameWins1, true); // true for P1
Â  Â  Â  Â  Â  Â  const player2Slot = createPlayerSlot(match, match.player2, match.gameWins2, false); // false for P2
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  matchInfo.appendChild(player1Slot);
Â  Â  Â  Â  Â  Â  matchInfo.appendChild(player2Slot);
Â  Â  Â  Â  Â  Â  matchContainer.appendChild(matchInfo);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  roundColumn.appendChild(matchContainer);
Â  Â  Â  Â  });

Â  Â  Â  Â  bracketElement.appendChild(roundColumn);
Â  Â  });
}

function createPlayerSlot(match, player, gameWins, isPlayer1) {
Â  Â  const slotEl = document.createElement('div');
Â  Â  slotEl.className = 'player-slot relative';
Â  Â Â 
Â  Â  // ×”×¦×’×ª ×”×©× ×”×¨××©×™ (×›×™× ×•×™ ×× ×§×™×™×)
Â  Â  let playerName = player?.nickname || player?.name || (match.status === 'pending' ? '×××ª×™×Ÿ ×œ×–×•×›×”' : '---');
Â  Â  let winsDisplay = gameWins > 0 ? `(${gameWins}/${WINS_TO_WIN_MATCH})` : '';Â 
Â  Â  let icon = 'ğŸ²'; // ××™×™×§×•×Ÿ ×§×•×‘×™×™×” ×œ×‘××§×’××•×Ÿ

Â  Â  // ×©×™×œ×•×‘ ×©× ×•×›×™× ×•×™ ×œ×”×¦×’×” - ×¢×›×©×™×• ×”×›×™× ×•×™ ×”×•× ×”×¨××©×™
Â  Â  let displayNameHtml = playerName;
Â  Â  if (player && player.nickname) {
Â  Â  Â  Â  // *** ×©×™× ×•×™: ×”×¦×’×ª ×”×›×™× ×•×™ ×›×©× ×”×¨××©×™ ×•×”×©× ×”××§×•×¨×™ ×‘×¡×•×’×¨×™×™× ***
Â  Â  Â  Â  const nicknameColor = match.winnerId ? 'text-gray-900/80' : 'text-slate-900/80';
Â  Â  Â  Â  displayNameHtml = `${player.nickname} <span class="text-sm font-normal ${nicknameColor}">(${player.name})</span>`;
Â  Â  }

Â  Â  let isWinner = match.winnerId && player && match.winnerId === player.id;
Â  Â  let isLoser = match.winnerId && player && match.winnerId !== player.id;
Â  Â  let isEmpty = !player && match.status !== 'pending';

Â  Â  if (isEmpty) {
Â  Â  Â  Â  slotEl.classList.remove('player-slot-filled');
Â  Â  Â  Â  slotEl.classList.add('player-slot-empty');
Â  Â  Â  Â  icon = '...';
Â  Â  Â  Â  displayNameHtml = playerName; // ×œ× ×œ×”×¦×™×’ ×¡×•×’×¨×™×™× ×× ×¨×™×§
Â  Â  } else if (isWinner) {
Â  Â  Â  Â  slotEl.classList.add('player-slot-winner');
Â  Â  Â  Â  winsDisplay = `(×”×× ×¦×—!)`;Â 
Â  Â  Â  Â  icon = 'ğŸ‘‘';
Â  Â  Â  Â  // ×‘×¢×ª × ×™×¦×—×•×Ÿ, ××•×•×“××™× ×©×”×›×™× ×•×™ ××•×¦×’ ×‘×¦×•×¨×” ×‘×¨×•×¨×”
Â  Â  Â  Â  displayNameHtml = player.nickname || player.name;
Â  Â  Â  Â  if (player.nickname && player.name) {
Â  Â  Â  Â  Â  Â  // ××¦×™×’×™× ××ª ×”×©× ×”××§×•×¨×™ ×‘×¡×•×’×¨×™×™× ×’× ×›××Ÿ
Â  Â  Â  Â  Â  Â  displayNameHtml = `${player.nickname} <span class="text-sm font-normal text-gray-900/80">(${player.name})</span>`;
Â  Â  Â  Â  }
Â  Â  } else if (isLoser) {
Â  Â  Â  Â  slotEl.classList.add('player-slot-loser');
Â  Â  Â  Â  icon = 'âŒ';
Â  Â  } else if (player) {
Â  Â  Â  Â  slotEl.classList.add('player-slot-filled');
Â  Â  }
Â  Â Â 
Â  Â  // ×”×ª×•×›×Ÿ ×©×œ ×”×¡×œ×•×˜
Â  Â  slotEl.innerHTML = `
Â  Â  Â  Â  <span class="text-base font-bold flex items-center gap-2">
Â  Â  Â  Â  Â  Â  ${icon} ${displayNameHtml}
Â  Â  Â  Â  </span>
Â  Â  Â  Â  <span class="font-black text-sm">${winsDisplay}</span>
Â  Â  `;

Â  Â  // ×”×•×¡×¤×ª ×™×›×•×œ×ª ×œ×—×™×¦×” ×¨×§ ×× ×”××©×—×§ ××•×›×Ÿ ×•×˜×¨× ×”×¡×ª×™×™×
Â  Â  if (!match.winnerId && match.player1 && match.player2) {
Â  Â  Â  Â  // ×§×¨×™××” ×œ×¤×•× ×§×¦×™×” openModal ×©×”×•×’×“×¨×” ×‘-window
Â  Â  Â  Â  slotEl.onclick = () => window.openModal(match.id);
Â  Â  Â  Â  slotEl.classList.add('cursor-pointer', 'transition');
Â  Â  }
Â  Â Â 
Â  Â  return slotEl;
}


// --- Tournament Logic ---

window.removeTeam = (playerIdToRemove) => {
Â  Â  if (tournamentData.status !== 'registration') return;
Â  Â  tournamentData.teams = tournamentData.teams.filter(t => t.id !== playerIdToRemove);
Â  Â  saveTournamentState();
}

document.getElementById('add-team-form').addEventListener('submit', (e) => {
Â  Â  e.preventDefault();
Â  Â  const playerName = teamNameInput.value.trim();
Â  Â  if (!playerName || playerName.length < 2) return;

Â  Â  if (tournamentData.teams.length >= MAX_PLAYERS || tournamentData.status !== 'registration') {
Â  Â  Â  Â  showRegistrationAlert(`×”×’×¢×ª ×œ××’×‘×œ×” (${MAX_PLAYERS} ×©×—×§× ×™×) ××• ×”×˜×•×¨× ×™×¨ ×›×‘×¨ ×”×—×œ.`, 'error');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if (tournamentData.teams.some(t => t.name.toLowerCase() === playerName.toLowerCase())) {
Â  Â  Â  Â  showRegistrationAlert("×”×©×—×§×Ÿ ×”×–×” ×›×‘×¨ ×¨×©×•×!", 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // *** ×”×•×¡×¤×ª ×”×›×™× ×•×™ ×”××¦×—×™×§ ***
Â  Â  const nickname = getAvailableNickname(tournamentData.teams);

Â  Â  if (!nickname) {
Â  Â  Â  Â  showRegistrationAlert("×©×’×™××”: ×”×’×¢×ª ×œ××¡×¤×¨ ×”×›×™× ×•×™×™× ×”××§×¡×™××œ×™ (16). ×œ× × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×©×—×§× ×™× × ×•×¡×¤×™×.", 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const newPlayer = { id: generateId(), name: playerName, nickname: nickname };
Â  Â  tournamentData.teams.push(newPlayer);
Â  Â  teamNameInput.value = '';
Â  Â  teamNameInput.focus();
Â  Â  showRegistrationAlert(`×”×©×—×§×Ÿ ${playerName} (×”×›×™× ×•×™: ${nickname}) × ×•×¡×£ ×‘×”×¦×œ×—×”!`);
Â  Â Â 
Â  Â  saveTournamentState();Â 
});

teamNameInput.addEventListener('input', () => {
Â  Â  const hasAvailableNicknames = getAvailableNickname(tournamentData.teams) !== null || tournamentData.teams.length === MAX_PLAYERS;
Â  Â  addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= MAX_PLAYERS || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
});

/**
Â * ××¤×¢×™×œ ××ª ×”×˜×•×¨× ×™×¨ ×•××™×™×¦×¨ ××ª ×”××©×—×§×™× ×”×¨××©×•× ×™×™×.
Â */
function generateBracket() {
Â  Â  const players = shuffle([...tournamentData.teams]);Â 
Â  Â  const matches = {
Â  Â  Â  Â  roundOf16: [], quarterfinals: [], semifinals: [], final: []
Â  Â  };

Â  Â  // 1. ×©××™× ×™×ª ×’××¨ (Round of 16 - 8 matches)
Â  Â  for (let i = 0; i < 8; i++) {
Â  Â  Â  Â  matches.roundOf16.push({
Â  Â  Â  Â  Â  Â  id: `r1m${i + 1}`,
Â  Â  Â  Â  Â  Â  player1: players[i * 2],
Â  Â  Â  Â  Â  Â  player2: players[i * 2 + 1],
Â  Â  Â  Â  Â  Â  gameWins1: 0,
Â  Â  Â  Â  Â  Â  gameWins2: 0,
Â  Â  Â  Â  Â  Â  winnerId: null,
Â  Â  Â  Â  Â  Â  // r1m1, r1m2 -> r2m1 | r1m3, r1m4 -> r2m2 | r1m5, r1m6 -> r2m3 | r1m7, r1m8 -> r2m4
Â  Â  Â  Â  Â  Â  nextMatchId: `r2m${Math.floor(i / 2) + 1}`,Â 
Â  Â  Â  Â  Â  Â  nextPlayerSlot: (i % 2) === 0 ? 1 : 2, // 1st match feeds slot 1, 2nd feeds slot 2
Â  Â  Â  Â  Â  Â  status: 'active'
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // 2. ×¨×‘×¢ ×’××¨ (Quarterfinals - 4 matches)
Â  Â  for (let i = 0; i < 4; i++) {
Â  Â  Â  Â  matches.quarterfinals.push({
Â  Â  Â  Â  Â  Â  id: `r2m${i + 1}`,
Â  Â  Â  Â  Â  Â  player1: null,
Â  Â  Â  Â  Â  Â  player2: null,
Â  Â  Â  Â  Â  Â  gameWins1: 0,
Â  Â  Â  Â  Â  Â  gameWins2: 0,
Â  Â  Â  Â  Â  Â  winnerId: null,
Â  Â  Â  Â  Â  Â  // r2m1, r2m2 -> r3m1 | r2m3, r2m4 -> r3m2
Â  Â  Â  Â  Â  Â  nextMatchId: `r3m${Math.floor(i / 2) + 1}`,
Â  Â  Â  Â  Â  Â  nextPlayerSlot: (i % 2) === 0 ? 1 : 2,
Â  Â  Â  Â  Â  Â  status: 'pending'
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // 3. ×—×¦×™ ×’××¨ (Semifinals - 2 matches)
Â  Â  for (let i = 0; i < 2; i++) {
Â  Â  Â  Â  matches.semifinals.push({
Â  Â  Â  Â  Â  Â  id: `r3m${i + 1}`,
Â  Â  Â  Â  Â  Â  player1: null,
Â  Â  Â  Â  Â  Â  player2: null,
Â  Â  Â  Â  Â  Â  gameWins1: 0,
Â  Â  Â  Â  Â  Â  gameWins2: 0,
Â  Â  Â  Â  Â  Â  winnerId: null,
Â  Â  Â  Â  Â  Â  // r3m1, r3m2 -> r4m1 (Final)
Â  Â  Â  Â  Â  Â  nextMatchId: `r4m1`,
Â  Â  Â  Â  Â  Â  nextPlayerSlot: i === 0 ? 1 : 2,
Â  Â  Â  Â  Â  Â  status: 'pending'
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // 4. ×’××¨ (Final - 1 match) - ××™×Ÿ nextMatchId
Â  Â  matches.final.push({
Â  Â  Â  Â  id: `r4m1`,
Â  Â  Â  Â  player1: null,
Â  Â  Â  Â  player2: null,
Â  Â  Â  Â  gameWins1: 0,
Â  Â  Â  Â  gameWins2: 0,
Â  Â  Â  Â  winnerId: null,
Â  Â  Â  Â  nextMatchId: null, // ×”×’××¨ ×”×•× ×”×¡×•×£
Â  Â  Â  Â  nextPlayerSlot: null,
Â  Â  Â  Â  status: 'pending'
Â  Â  });
Â  Â Â 
Â  Â  tournamentData.matches = matches;
Â  Â  tournamentData.status = 'in_progress';
Â  Â  tournamentData.winner = null;
Â  Â  tournamentData.showChampionModal = false;
Â  Â  saveTournamentState();
}

document.getElementById('start-tournament').addEventListener('click', () => {
Â  Â  if (tournamentData.teams.length === MAX_PLAYERS && tournamentData.status === 'registration') {
Â  Â  Â  Â  generateBracket();
Â  Â  Â  Â  statusMessage.textContent = 'âš”ï¸ ×”×˜×•×¨× ×™×¨ ×”×—×œ! ×™××œ×œ×” ×‘×œ××’×Ÿ! ×œ×—×¥ ×¢×œ ××©×—×§ ×›×“×™ ×œ×¢×“×›×Ÿ ×ª×•×¦××”.';
Â  Â  Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-6 text-cyan-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
Â  Â  } else if (tournamentData.status !== 'registration') {
Â  Â  Â  Â  // ×”×˜×•×¨× ×™×¨ ×›×‘×¨ ×”×—×œ, ×¤×©×•×˜ × ×¡×’×•×¨ ××ª ×”×¨×™×©×•×
Â  Â  Â  Â  renderTournament(tournamentData);
Â  Â  } else {
Â  Â  Â  Â  statusMessage.textContent = `âš ï¸ ×—×¡×¨×™× ${MAX_PLAYERS - tournamentData.teams.length} ×©×—×§× ×™× ×›×“×™ ×œ×”×ª×—×™×œ.`;
Â  Â  Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-6 text-yellow-500 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
Â  Â  }
});


/**
Â * ××§×“× ×–×•×›×” ××©×—×§ ×‘×•×“×“ ×‘×ª×•×š ××©×—×§ ×”×˜×•×‘ ×-5.
Â */
window.handleGameWin = (matchId, playerSlot) => {
Â  Â  const match = getMatchById(matchId);
Â  Â  if (!match || match.winnerId) return;

Â  Â  if (playerSlot === 1) {
Â  Â  Â  Â  match.gameWins1++;
Â  Â  } else if (playerSlot === 2) {
Â  Â  Â  Â  match.gameWins2++;
Â  Â  }
Â  Â Â 
Â  Â  // ×‘×“×™×§×” ×”×× ×”××©×—×§ ×”×¡×ª×™×™× (×”×¨××©×•×Ÿ ×œ-3)
Â  Â  if (match.gameWins1 === WINS_TO_WIN_MATCH) {
Â  Â  Â  Â  match.winnerId = match.player1.id;
Â  Â  Â  Â  match.winner = match.player1;
Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  advanceWinner(match);
Â  Â  } else if (match.gameWins2 === WINS_TO_WIN_MATCH) {
Â  Â  Â  Â  match.winnerId = match.player2.id;
Â  Â  Â  Â  match.winner = match.player2;
Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  advanceWinner(match);
Â  Â  } else {
Â  Â  Â  Â  // ×”××©×—×§ ×¢×“×™×™×Ÿ ×œ× ×”×¡×ª×™×™×, ×¨×§ ××¢×“×›×Ÿ ××ª ×”×ª×•×¦××” ×‘××•×“××œ
Â  Â  Â  Â  saveTournamentState();
Â  Â  Â  Â  // ×¤×•×ª×— ××—×“×© ××ª ×”××•×“××œ ×¢× ×”× ×ª×•× ×™× ×”××¢×•×“×›× ×™×
Â  Â  Â  Â  openModal(matchId);
Â  Â  }
Â  Â Â 
Â  Â  saveTournamentState();
};

/**
Â * ××§×“× ××ª ×”×× ×¦×— ×œ××©×—×§ ×”×‘× ×‘×˜×•×¨× ×™×¨.
Â */
function advanceWinner(completedMatch) {
Â  Â  if (!completedMatch.winner || !completedMatch.nextMatchId) {
Â  Â  Â  Â  // ×”×’××¨ ×”×¡×ª×™×™×
Â  Â  Â  Â  if (completedMatch.id === 'r4m1') {
Â  Â  Â  Â  Â  Â  tournamentData.winner = completedMatch.winner;
Â  Â  Â  Â  Â  Â  tournamentData.status = 'finished';
Â  Â  Â  Â  Â  Â  tournamentData.showChampionModal = true;
Â  Â  Â  Â  Â  Â  statusMessage.textContent = `ğŸ‘‘ ×”×˜×•×¨× ×™×¨ ×”×¡×ª×™×™×! ×”×× ×¦×— ×”×•× ${completedMatch.winner.nickname || completedMatch.winner.name}!`;
Â  Â  Â  Â  Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-6 text-amber-300 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const nextMatch = getMatchById(completedMatch.nextMatchId);
Â  Â  if (!nextMatch) return;

Â  Â  // ×¢×“×›×•×Ÿ ×¡×œ×•×˜ ×”×©×—×§×Ÿ ×”×‘×
Â  Â  if (completedMatch.nextPlayerSlot === 1) {
Â  Â  Â  Â  nextMatch.player1 = completedMatch.winner;
Â  Â  } else if (completedMatch.nextPlayerSlot === 2) {
Â  Â  Â  Â  nextMatch.player2 = completedMatch.winner;
Â  Â  }

Â  Â  // ×× ×©× ×™ ×”×©×—×§× ×™× ××•×›× ×™× ×‘××©×—×§ ×”×‘×, ×”×•× ×”×•×¤×š ×œ-active
Â  Â  if (nextMatch.player1 && nextMatch.player2) {
Â  Â  Â  Â  nextMatch.status = 'active';
Â  Â  }
}


// --- Initialization ---

window.onload = initializeApp;
</script>
</body>
</html>
