<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>××¢×¨×›×ª × ×™×”×•×œ ×˜×•×¨× ×™×¨ ×©×©-×‘×©</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ×”×’×“×¨×•×ª ×’×•×¤×Ÿ ×•×¨×§×¢ ×›×œ×œ×™ */
body {
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background-color: #1f2937; /* ×¨×§×¢ ×›×”×” */
  color: #d1d5db;
  padding: 1rem;
}

/* ×¡×’× ×•×Ÿ ×›×¤×ª×•×¨×™× ××™×•×—×“ ×œ××©×—×§×™×•×ª */
button {
    transition: all 0.15s ease-in-out;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
}
button:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.2);
}

/* ×¡×’× ×•×Ÿ ×œ××‘× ×” ×”×˜×•×¨× ×™×¨ */
.match-card {
    min-width: 150px;
    border-right: 2px solid #374151; /* ×§×• ×”×¤×¨×“×” ×‘×™×Ÿ ××©×—×§×™× */
    margin-bottom: 8px;
}
.player-slot {
    padding: 6px 10px;
    margin: 2px 0;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;
    font-size: 0.9rem;
}
.player-slot-empty {
    background-color: #374151;
    color: #9ca3af;
    font-style: italic;
}
.player-slot-filled {
    background-color: #4b5563;
    cursor: pointer;
}
.player-slot-winner {
    background-color: #10b981; /* ×™×¨×•×§ */
    color: #1f2937;
    font-weight: 700;
}
.player-slot-loser {
    background-color: #ef4444; /* ××“×•× */
    color: #1f2937;
    text-decoration: line-through;
    opacity: 0.7;
}

/* ×¡×’× ×•×Ÿ ××™×•×—×“ ×œ×›×¨×˜×™×¡ ×”× ×™×¦×—×•×Ÿ */
#champion-card {
    background: linear-gradient(135deg, #f59e0b, #ef4444);
    color: #fff;
    padding: 2rem;
    border-radius: 12px;
    text-align: center;
    font-size: 2.5rem;
    font-weight: 900;
    box-shadow: 0 10px 15px rgba(245, 158, 11, 0.4);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}

</style>
</head>
<body class="rtl text-right">

<div class="text-center py-6 bg-gray-800 rounded-b-xl mb-6 shadow-xl">
  <h1 class="text-4xl font-black text-red-500">ğŸ† ××¢×¨×›×ª × ×™×”×•×œ ×˜×•×¨× ×™×¨ ×©×©-×‘×© ğŸ²</h1>
  <p class="text-xl text-yellow-400 mt-2">×¨×™×©×•×, ×”×’×¨×œ×” ×•×¢×“×›×•×Ÿ ×—×™ ×©×œ ×”×˜×‘×œ×”</p>
</div>

<!-- ×›×¤×ª×•×¨ ×”×ª×—×œ×ª ×”×˜×•×¨× ×™×¨ -->
<div class="flex justify-center mb-4">
  <button id="start-tournament" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold text-lg hover:bg-green-700 transition duration-150" disabled>×”×ª×—×œ ×˜×•×¨× ×™×¨ (×¦×¨×™×š 8 ×¦×•×•×ª×™×)</button>
</div>

<!-- ×”×•×“×¢×•×ª ×¡×˜×˜×•×¡ -->
<div id="status-message" class="text-center text-xl font-semibold mb-4 text-yellow-500"></div>


<!-- ×˜×•×¤×¡ ×¨×™×©×•× ×¦×•×•×ª×™× -->
<div id="registration-section" class="bg-gray-800 p-6 rounded-xl mb-6 shadow-lg">
  <h2 class="text-2xl font-bold text-red-400 mb-4">×¨×™×©×•× ×–×•×’×•×ª / ×¦×•×•×ª×™× (<span id="team-count">0</span>/8)</h2>
  <form id="add-team-form" class="flex gap-2 mb-4">
    <input id="team-name" class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-red-500 focus:border-red-500" placeholder="×”×›× ×¡ ×©× ×–×•×’..." required />
    <button id="add-team" class="bg-blue-600 p-3 rounded-lg hover:bg-blue-700 text-white font-bold" disabled>×”×•×¡×£ ×¦×•×•×ª</button>
  </form>
  <div id="registration-alert" class="text-sm h-4 mb-2 text-center"></div>

  <ul id="teams-list" class="mt-4 text-gray-300 space-y-2">
    <!-- ×¨×©×™××ª ×”×¦×•×•×ª×™× ×ª×•×¦×’ ×›××Ÿ -->
  </ul>
</div>

<!-- ×ª×¦×•×’×ª ×˜×•×¨× ×™×¨ -->
<div id="tournament-section" class="bg-gray-800 p-6 rounded-xl shadow-lg hidden">
  <h2 class="text-2xl font-bold text-red-400 mb-4">×˜×‘×œ×ª × ×•×§×××•×˜</h2>
  <div id="bracket" class="flex flex-row-reverse justify-start overflow-x-auto p-2">
    <!-- ××‘× ×” ×”×˜×•×¨× ×™×¨ ×™×•×˜×¢×Ÿ ×›××Ÿ -->
  </div>
</div>

<!-- ××•×“××œ ×œ×¢×“×›×•×Ÿ ×ª×•×¦××•×ª -->
<div id="result-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
  <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md shadow-2xl border border-red-500/50">
    <h3 id="modal-title" class="text-2xl font-bold text-yellow-400 mb-5">×¢×“×›×•×Ÿ ×ª×•×¦××ª ××©×—×§</h3>
    <form id="update-result-form" class="space-y-4">
      <input type="hidden" id="match-id" />
      
      <div>
        <label id="label-player1" class="block text-gray-300 font-semibold mb-1"></label>
        <input type="number" min="0" id="score1" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500" placeholder="× ×§×•×“×•×ª" required />
      </div>
      
      <div class="text-center text-xl font-bold text-red-500">× ×’×“</div>

      <div>
        <label id="label-player2" class="block text-gray-300 font-semibold mb-1"></label>
        <input type="number" min="0" id="score2" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-red-500 focus:border-red-500" placeholder="× ×§×•×“×•×ª" required />
      </div>

      <div class="flex justify-end space-x-2 pt-6">
        <button type="button" onclick="window.closeModal()" class="bg-gray-600 hover:bg-gray-700 p-3 rounded-lg text-white font-semibold transition duration-150">×‘×™×˜×•×œ</button>
        <button type="submit" class="bg-red-600 hover:bg-red-700 p-3 rounded-lg text-white font-bold transition duration-150">×©××•×¨ ×ª×•×¦××”</button>
      </div>
    </form>
  </div>
</div>

<!-- ×”×•×“×¢×ª ×¡×™××•×Ÿ -->
<div id="modal-placeholder" class="fixed inset-0 flex items-center justify-center hidden bg-black bg-opacity-50 z-50">
    <div id="champion-card" class="max-w-xl">
        <!-- ×”×•×“×¢×ª ×”× ×™×¦×—×•×Ÿ ×ª×•×˜×¢×Ÿ ×›××Ÿ -->
    </div>
</div>

<script type="module">
// --- ×”×’×“×¨×•×ª ×’×œ×•×‘×œ×™×•×ª ---
// ×©× ××¤×ª×— ×”-localStorage ×œ×©××™×¨×ª × ×ª×•× ×™ ×”×˜×•×¨× ×™×¨
const STORAGE_KEY = 'backgammon_tournament_data_v1';

// --- DOM elements ---
const teamNameInput = document.getElementById('team-name');
const addTeamButton = document.getElementById('add-team');
const startTournamentButton = document.getElementById('start-tournament');
const teamsListElement = document.getElementById('teams-list');
const teamCountElement = document.getElementById('team-count');
const bracketElement = document.getElementById('bracket');
const registrationSection = document.getElementById('registration-section');
const tournamentSection = document.getElementById('tournament-section');
const statusMessage = document.getElementById('status-message');
const registrationAlert = document.getElementById('registration-alert');
const resultModal = document.getElementById('result-modal');
const updateResultForm = document.getElementById('update-result-form');
const championModal = document.getElementById('modal-placeholder');
const championCard = document.getElementById('champion-card');

let tournamentData = {
    teams: [],
    status: 'registration', // 'registration', 'in_progress', 'finished'
    matches: {
        round1: [],
        semifinals: [],
        final: []
    },
    winner: null,
};

// --- Utilities ---

// ××¦×™×’ ×”×•×“×¢×” ×–×× ×™×ª ×‘××–×•×¨ ×”×¨×™×©×•×
function showRegistrationAlert(message, type = 'info') {
    registrationAlert.textContent = message;
    registrationAlert.className = `text-sm h-4 mb-2 text-center ${type === 'error' ? 'text-red-400' : 'text-green-400'}`;
    setTimeout(() => {
        registrationAlert.textContent = '';
        registrationAlert.className = 'text-sm h-4 mb-2 text-center';
    }, 3000);
}

// ×¤×•× ×§×¦×™×™×ª ×¢×¨×‘×•×‘ ××¢×¨×š (Fisher-Yates)
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// ××—×•×œ×œ ××–×”×” ×™×™×—×•×“×™ ×¤×©×•×˜
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
}

// ×¡×’×™×¨×ª ×”××•×“××œ
window.closeModal = () => {
    resultModal.classList.add('hidden');
    // ××™×¤×•×¡ ×˜×•×¤×¡
    updateResultForm.reset();
};


// --- Local Storage Functions ---

function loadData() {
    try {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            const parsedData = JSON.parse(storedData);
            // ××™××•×ª ×”××™×“×¢ ×”×˜×¢×•×Ÿ
            if (parsedData && Array.isArray(parsedData.teams) && typeof parsedData.status === 'string') {
                tournamentData = parsedData;
                console.log("Local Storage: Tournament data loaded successfully.");
            } else {
                console.warn("Local Storage: Stored data is corrupted or invalid. Starting fresh.");
                localStorage.removeItem(STORAGE_KEY);
            }
        }
    } catch (e) {
        console.error("Local Storage: Error loading data:", e);
        // ×× ×™×© ×©×’×™××”, ××ª×—×™×œ×™× ×¢× × ×ª×•× ×™× ×¨×™×§×™× (×›×¤×™ ×©×”×•×’×“×¨×• ×’×œ×•×‘×œ×™×ª)
    }
}

// ×©××™×¨×ª ××¦×‘ ×”×˜×•×¨× ×™×¨ ×‘-LocalStorage
function saveTournamentState() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tournamentData));
        console.log("Local Storage: Tournament state saved.");
        renderTournament(tournamentData); // ×¨×™× ×“×•×¨ ××™×™×“×™ ×œ××—×¨ ×©××™×¨×”
    } catch (e) {
        console.error("Local Storage: Error saving data:", e);
        showRegistrationAlert("×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×‘×“×¤×“×¤×Ÿ.", 'error');
    }
}

// ×¤×•× ×§×¦×™×” ×”××“××” ×”××–× ×” ×œ×©×™× ×•×™×™× (×›×¢×ª ×§×•×¨××ª ×¨×§ ×œ×¨×™× ×“×•×¨ ×œ××—×¨ ×˜×¢×™× ×ª ×”× ×ª×•× ×™×)
function initializeApp() {
    loadData(); // ×˜×•×¢×Ÿ × ×ª×•× ×™× ××”-localStorage
    renderTournament(tournamentData); // ××¦×™×’ ××ª ×”× ×ª×•× ×™× ×”×˜×¢×•× ×™×
    
    // ×”×¤×¢×œ×ª ×›×¤×ª×•×¨ ×”×•×¡×¤×ª ×”×¦×•×•×ª×™× (×›×™×•×•×Ÿ ×©××™×Ÿ ×ª×œ×•×ª ×‘-Firebase)
    addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= 8 || teamNameInput.value.trim() === '';
    
    statusMessage.textContent = "âœ… ××¦×‘ ××§×•××™ (Local Storage) ×¤×¢×™×œ. ×”× ×ª×•× ×™× × ×©××¨×™× ×‘×“×¤×“×¤×Ÿ ×–×”.";
    statusMessage.className = "text-center text-xl font-semibold mb-4 text-green-400 bg-gray-700/50 p-2 rounded-lg";
}


// --- UI Rendering ---

function renderTournament(data) {
    const { teams, status, matches, winner } = data;

    // 1. ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×¦×•×•×ª×™× ×•×›×¤×ª×•×¨ ×”×”×ª×—×œ×”
    teamsListElement.innerHTML = '';
    teamCountElement.textContent = teams.length; // ×”×¦×’×ª ×¡×¤×™×¨×ª ×”×¦×•×•×ª×™×
    
    teams.forEach((team, index) => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-lg text-white font-medium'; // ×”×“×’×©×” ×§×œ×” ×™×•×ª×¨
        li.innerHTML = `
            <span>${index + 1}. ${team.name}</span>
            <button class="text-red-400 hover:text-red-500 text-sm" onclick="removeTeam('${team.id}')" ${status !== 'registration' ? 'disabled' : ''}>[X] ×”×¡×¨</button>
        `;
        teamsListElement.appendChild(li);
    });

    if (teams.length === 0) {
        teamsListElement.innerHTML = '<li class="text-gray-500 text-center py-2">×¢×“×™×™×Ÿ ×œ× × ×¨×©××• ×¦×•×•×ª×™×.</li>';
    }

    // 2. × ×™×”×•×œ ××¦×‘ ×”×”×¨×©××” ×•×›×¤×ª×•×¨ ×”'×”×ª×—×œ ×˜×•×¨× ×™×¨'
    const teamCount = teams.length;
    
    // ×›×¤×ª×•×¨ ×”×”×•×¡×¤×” ××•×©×‘×ª ×× ×”×§×œ×˜ ×¨×™×§, ××œ×, ××• ×”×˜×•×¨× ×™×¨ ×”×ª×—×™×œ
    addTeamButton.disabled = tournamentData.status !== 'registration' || teamCount >= 8 || teamNameInput.value.trim() === '';
    
    // ×›×¤×ª×•×¨ ×”×”×ª×—×œ×” ××•×©×‘×ª ×× ×œ× 8 ×¦×•×•×ª×™×
    startTournamentButton.disabled = tournamentData.status !== 'registration' || teamCount !== 8;
    startTournamentButton.textContent = teamCount === 8 ? '×”×ª×—×œ ×˜×•×¨× ×™×¨!' : `×”×ª×—×œ ×˜×•×¨× ×™×¨ (×¦×¨×™×š 8 ×¦×•×•×ª×™×)`;

    if (status === 'registration') {
        registrationSection.classList.remove('hidden');
        tournamentSection.classList.add('hidden');
        statusMessage.textContent = `× ×¨×©××•: ${teamCount} / 8. ${teamCount === 8 ? '××•×›×Ÿ ×œ×”×’×¨×œ×”.' : '×™×© ×œ×¨×©×•× 8 ×¦×•×•×ª×™× ×›×“×™ ×œ×”×ª×—×™×œ.'}`;
        statusMessage.className = "text-center text-xl font-semibold mb-4 text-green-400 bg-gray-700/50 p-2 rounded-lg";
    } else {
        registrationSection.classList.add('hidden');
        tournamentSection.classList.remove('hidden');
        statusMessage.textContent = status === 'in_progress' ? '×”×˜×•×¨× ×™×¨ ×‘×¢×™×¦×•××•!' : '×”×˜×•×¨× ×™×¨ ×”×¡×ª×™×™×!';
    }
    
    // 3. ×”×¦×’×ª ×˜×‘×œ×ª ×”× ×•×§×××•×˜
    renderBracket(matches, winner);
}

function renderBracket(matches, tournamentWinner) {
    bracketElement.innerHTML = '';

    if (tournamentWinner) {
        // ×× ×™×© ×–×•×›×”, ×”×¦×’ ××•×“××œ × ×™×¦×—×•×Ÿ ×•×”×¤×¡×§
        championCard.innerHTML = `
            <div class="flex flex-col items-center space-y-4">
                <span class="text-6xl">ğŸ‘‘</span>
                <span class="text-3xl font-extrabold">×”×× ×¦×— ×”×’×“×•×œ:</span>
                <span class="text-6xl font-black">${tournamentWinner.name}</span>
                <p class="text-2xl mt-4">×›×œ ×”×›×‘×•×“ ×¢×œ ×”×–×›×™×™×” ×‘×˜×•×¨× ×™×¨ ×”×©×©-×‘×©!</p>
            </div>
        `;
        championModal.classList.remove('hidden');
        return;
    } else {
        championModal.classList.add('hidden');
    }

    const rounds = ['round1', 'semifinals', 'final'];

    rounds.forEach((roundKey) => {
        const roundMatches = matches[roundKey] || [];
        
        // ×™×¦×™×¨×ª ×¢××•×“×” ×œ×¡×™×‘×•×‘
        const roundColumn = document.createElement('div');
        roundColumn.className = `flex flex-col items-center p-4 min-w-[200px] border-l border-gray-700 mx-1`;
        
        const roundTitleMap = { 'round1': '×¡×™×‘×•×‘ 1 (×¨×‘×¢ ×’××¨)', 'semifinals': '×—×¦×™ ×’××¨', 'final': '×’××¨' };
        roundColumn.innerHTML = `<h3 class="text-xl font-bold text-yellow-400 mb-4">${roundTitleMap[roundKey]}</h3>`;
        
        roundMatches.forEach(match => {
            const matchContainer = document.createElement('div');
            matchContainer.id = match.id;
            matchContainer.className = 'match-card mb-4 p-2 rounded-lg bg-gray-700/50';

            const matchInfo = document.createElement('div');
            matchInfo.className = 'flex flex-col';

            const player1Slot = createPlayerSlot(match, match.player1, 1);
            const player2Slot = createPlayerSlot(match, match.player2, 2);
            
            matchInfo.appendChild(player1Slot);
            matchInfo.appendChild(player2Slot);
            matchContainer.appendChild(matchInfo);
            roundColumn.appendChild(matchContainer);
        });

        bracketElement.appendChild(roundColumn);
    });
}

function createPlayerSlot(match, player, slot) {
    const slotEl = document.createElement('div');
    slotEl.className = 'player-slot relative';
    
    // ×§×‘×™×¢×ª ××¦×‘ ×”×©×—×§×Ÿ (×× ×¦×—, ××¤×¡×™×“, ×××ª×™×Ÿ, ×¨×™×§)
    let teamName = player?.name || (match.status === 'pending' ? '×××ª×™×Ÿ ×œ×–×•×›×”' : '---');
    let score = player?.score !== null && player?.score !== undefined ? player.score : '';
    let isWinner = match.winnerId && player && match.winnerId === player.id;
    let isLoser = match.winnerId && player && match.winnerId !== player.id;
    let isEmpty = !player && match.status !== 'pending';

    if (isEmpty) {
        slotEl.classList.add('player-slot-empty');
    } else if (isWinner) {
        slotEl.classList.add('player-slot-winner');
    } else if (isLoser) {
        slotEl.classList.add('player-slot-loser');
    } else if (player) {
        slotEl.classList.add('player-slot-filled');
    }
    
    // ×”×ª×•×›×Ÿ ×©×œ ×”×¡×œ×•×˜
    slotEl.innerHTML = `
        <span class="text-base">${teamName}</span>
        <span class="font-bold text-sm">${score}</span>
    `;

    // ×”×•×¡×¤×ª ×™×›×•×œ×ª ×œ×—×™×¦×” ×¨×§ ×× ×”××©×—×§ ××•×›×Ÿ ×•×˜×¨× ×”×¡×ª×™×™×
    if (!match.winnerId && match.player1 && match.player2) {
        slotEl.onclick = () => openModal(match.id);
        slotEl.classList.add('cursor-pointer', 'hover:bg-red-500/50', 'transition');
    }
    
    return slotEl;
}


// --- Tournament Logic ---

// ××—×™×§×ª ×¦×•×•×ª (×¨×§ ×‘×©×œ×‘ ×”×”×¨×©××”)
window.removeTeam = (teamIdToRemove) => {
    if (tournamentData.status !== 'registration') return;
    tournamentData.teams = tournamentData.teams.filter(t => t.id !== teamIdToRemove);
    saveTournamentState();
}

// ×˜×™×¤×•×œ ×‘×”×•×¡×¤×ª ×¦×•×•×ª
document.getElementById('add-team-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const teamName = teamNameInput.value.trim();
    if (!teamName || teamName.length < 2) return;

    if (tournamentData.teams.length >= 8 || tournamentData.status !== 'registration') {
        showRegistrationAlert("×”×’×¢×ª ×œ××’×‘×œ×” (8 ×¦×•×•×ª×™×) ××• ×”×˜×•×¨× ×™×¨ ×›×‘×¨ ×”×—×œ.", 'error');
        return;
    }
    
    // ×‘×“×™×§×” ×œ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª
    if (tournamentData.teams.some(t => t.name === teamName)) {
        showRegistrationAlert("×”×¦×•×•×ª ×”×–×” ×›×‘×¨ ×¨×©×•×!", 'error');
        return;
    }

    const newTeam = { id: generateId(), name: teamName };
    tournamentData.teams.push(newTeam);
    teamNameInput.value = '';
    teamNameInput.focus(); // ×”×—×–×¨×ª ××™×§×•×“ ×œ×”×•×¡×¤×” ××”×™×¨×” ×©×œ ×”×‘×
    showRegistrationAlert("×”×¦×•×•×ª × ×•×¡×£ ×‘×”×¦×œ×—×”!");
    
    // ×”×¤×•× ×§×¦×™×” ×”×–×• ××¢×“×›× ×ª ××ª localStorage ×•××¤×¢×™×œ×” ××ª ×”×¨×™× ×“×•×¨ ××—×“×©
    saveTournamentState(); 
});

// ×”×¤×¢×œ×ª/×”×©×‘×ª×ª ×›×¤×ª×•×¨ '×”×•×¡×£ ×¦×•×•×ª' ×‘×–××Ÿ ×”×§×œ×“×”
teamNameInput.addEventListener('input', () => {
    // ×”×©×‘×ª×” ×× ×”×§×œ×˜ ×¨×™×§, ××œ×, ××• ×”×˜×•×¨× ×™×¨ ×”×ª×—×™×œ
    addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= 8 || teamNameInput.value.trim() === '';
});


// ×™×¦×™×¨×ª ××‘× ×” ×”× ×•×§×××•×˜ ×•×”×’×¨×œ×ª ×”×¦×•×•×ª×™×
function generateBracket() {
    const teams = shuffle([...tournamentData.teams]); // ×¢×¨×‘×•×‘ ×”×¦×•×•×ª×™×

    // 1. ×”×’×“×¨×ª ××‘× ×” ×”××©×—×§×™× ×•×”×§×™×©×•×¨×™×•×ª
    const structure = [
        // id, round, nextMatchId, nextPlayerSlot (1=player1, 2=player2)
        { id: 'r1m1', round: 'round1', nextMatchId: 'r2m1', nextPlayerSlot: 1 },
        { id: 'r1m2', round: 'round1', nextMatchId: 'r2m1', nextPlayerSlot: 2 },
        { id: 'r1m3', round: 'round1', nextMatchId: 'r2m2', nextPlayerSlot: 1 },
        { id: 'r1m4', round: 'round1', nextMatchId: 'r2m2', nextPlayerSlot: 2 },
        { id: 'r2m1', round: 'semifinals', nextMatchId: 'r3m1', nextPlayerSlot: 1 },
        { id: 'r2m2', round: 'semifinals', nextMatchId: 'r3m1', nextPlayerSlot: 2 },
        { id: 'r3m1', round: 'final', nextMatchId: null, nextPlayerSlot: null }
    ];

    const allMatches = structure.map(s => ({
        id: s.id,
        player1: null,
        player2: null,
        score1: null,
        score2: null,
        winnerId: null,
        nextMatchId: s.nextMatchId,
        nextPlayerSlot: s.nextPlayerSlot,
        status: (s.round === 'round1' ? 'active' : 'pending'), // ×¨×§ ××©×—×§×™ ×¡×™×‘×•×‘ 1 ×¤×¢×™×œ×™× ×‘×”×ª×—×œ×”
    }));

    // 2. ×©×™×‘×•×¥ ×”×¦×•×•×ª×™× ×‘×¡×™×‘×•×‘ ×”×¨××©×•×Ÿ (×¨×‘×¢ ×’××¨)
    for (let i = 0; i < 4; i++) {
        const matchIndex = i;
        allMatches[matchIndex].player1 = teams[i * 2];
        allMatches[matchIndex].player2 = teams[i * 2 + 1];
    }

    // 3. ×¡×™×“×•×¨ ×œ×¤×™ ×¡×™×‘×•×‘×™×
    const matchesByRound = allMatches.reduce((acc, match) => {
        const roundKey = structure.find(s => s.id === match.id).round;
        acc[roundKey].push(match);
        return acc;
    }, { round1: [], semifinals: [], final: [] });

    return matchesByRound;
}

// ×˜×™×¤×•×œ ×‘×”×ª×—×œ×ª ×”×˜×•×¨× ×™×¨
startTournamentButton.addEventListener('click', () => {
    if (tournamentData.status === 'registration' && tournamentData.teams.length === 8) {
        
        statusMessage.textContent = "××ª×—×™×œ ×˜×•×¨× ×™×¨... ××‘× ×” ×”×˜×•×¨× ×™×¨ ×”×•×’×¨×œ.";
        statusMessage.className = 'text-center text-xl font-semibold mb-4 text-green-500';

        tournamentData.matches = generateBracket();
        tournamentData.status = 'in_progress';
        saveTournamentState(); // ×©××™×¨×” ×•×¨×™× ×“×•×¨
    }
});

// ×¤×ª×™×—×ª ××•×“××œ ×¢×“×›×•×Ÿ ×ª×•×¦××”
window.openModal = (matchId) => {
    const match = findMatchById(matchId);
    if (!match || match.winnerId) return; // ×œ× ×¤×•×ª×—×™× ×× ××™×Ÿ ××©×—×§ ××• ×× ×›×‘×¨ ×™×© ×–×•×›×”

    document.getElementById('match-id').value = matchId;
    document.getElementById('modal-title').textContent = `×¢×“×›×•×Ÿ ×ª×•×¦××”: ${match.player1.name} × ×’×“ ${match.player2.name}`;
    
    document.getElementById('label-player1').textContent = `× ×§×•×“×•×ª ×œ-${match.player1.name}`;
    document.getElementById('label-player2').textContent = `× ×§×•×“×•×ª ×œ-${match.player2.name}`;

    // ×˜×¢×™× ×ª ×ª×•×¦××•×ª ×§×•×“××•×ª ×× ×§×™×™××•×ª
    document.getElementById('score1').value = match.score1 || '';
    document.getElementById('score2').value = match.score2 || '';

    resultModal.classList.remove('hidden');
};

// ×¤×•× ×§×¦×™×” ×œ××¦×™××ª ××©×—×§ ×œ×¤×™ ××–×”×”
function findMatchById(matchId) {
    for (const roundKey in tournamentData.matches) {
        const match = tournamentData.matches[roundKey].find(m => m.id === matchId);
        if (match) return match;
    }
    return null;
}

// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ××©×—×§ (×§×™×“×•× ×× ×¦×—)
function updateMatch(matchId, newMatchData) {
    for (const roundKey in tournamentData.matches) {
        const index = tournamentData.matches[roundKey].findIndex(m => m.id === matchId);
        if (index !== -1) {
            tournamentData.matches[roundKey][index] = { 
                ...tournamentData.matches[roundKey][index], 
                ...newMatchData 
            };
            return tournamentData.matches[roundKey][index]; // ×”×—×–×¨×ª ×”××•×‘×™×™×§×˜ ×”××¢×•×“×›×Ÿ
        }
    }
    return null;
}

// ×˜×™×¤×•×œ ×‘×©××™×¨×ª ×ª×•×¦××”
updateResultForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const matchId = document.getElementById('match-id').value;
    const score1 = parseInt(document.getElementById('score1').value);
    const score2 = parseInt(document.getElementById('score2').value);

    // ×•×œ×™×“×¦×™×” ×‘×¡×™×¡×™×ª: ×”×¦×™×•×Ÿ ×—×™×™×‘ ×œ×”×™×•×ª ×©×•× ×”
    if (score1 === score2) {
        showRegistrationAlert("×”×¦×™×•× ×™× ×—×™×™×‘×™× ×œ×”×™×•×ª ×©×•× ×™× (×©×•×•×™×•×Ÿ ××™× ×• ××¤×©×¨×™ ×‘× ×•×§×××•×˜).", 'error');
        window.closeModal(); 
        return;
    }

    const currentMatch = findMatchById(matchId);
    if (!currentMatch) return;

    // ×§×‘×™×¢×ª ×”×× ×¦×— ×•×”××¤×¡×™×“
    const winner = score1 > score2 ? currentMatch.player1 : currentMatch.player2;
    
    // 1. ×¢×“×›×•×Ÿ ×”××©×—×§ ×”× ×•×›×—×™
    const updatedMatch = updateMatch(matchId, {
        score1: score1,
        score2: score2,
        winnerId: winner.id,
    });
    
    // 2. ×§×™×“×•× ×”×× ×¦×— ×œ×¡×™×‘×•×‘ ×”×‘×
    if (updatedMatch.nextMatchId) {
        const nextMatch = findMatchById(updatedMatch.nextMatchId);
        if (nextMatch) {
            // ×”× ×ª×•× ×™× ×”××§×•×“××™× (×¨×§ ×”-ID ×•×”×©×)
            const promotedPlayer = { id: winner.id, name: winner.name, score: null };
            const slotKey = updatedMatch.nextPlayerSlot === 1 ? 'player1' : 'player2';
            
            // ×¢×“×›×•×Ÿ ×”××©×—×§ ×”×‘×
            updateMatch(nextMatch.id, {
                [slotKey]: promotedPlayer,
                status: (nextMatch.player1 && nextMatch.player2) ? 'active' : 'pending' // ×× ×©× ×™ ×”×©×—×§× ×™× ×§×•×“××•, ×”××©×—×§ ×”×•×¤×š ×œ×¤×¢×™×œ
            });
        }
    } else {
        // ×× ××™×Ÿ nextMatchId, ×–×” ×”×’××¨!
        tournamentData.status = 'finished';
        tournamentData.winner = winner;
    }

    // ×©××™×¨×” ×•×¡×’×™×¨×ª ××•×“××œ
    saveTournamentState();
    window.closeModal();
});


// --- Bootstrap ---
window.onload = initializeApp;

</script>
</body>
</html>
