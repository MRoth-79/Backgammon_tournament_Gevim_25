<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>מערכת ניהול טורניר שש-בש (השחקן שמגיע לשלוש נקודות מנצח) ל-16 שחקנים</title>
<!-- האזהרה שקיבלת מתייחסת לשימוש ב-CDN הזה, שהוא הכרחי לצורך הצגת העיצוב באופן מיידי בסביבת הפיתוח הזו. -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* הגדרות גופן ורקע כללי - סכמה אנרגטית מעודכנת */
body {
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background-color: #0F172A; /* Dark Slate Blue - כחול צי לילה */
    color: #f3f4f6; /* Light text for contrast */
    padding: 1rem;
}

body {
	-moz-text-size-adjust: 100%;
    -webkit-text-size-adjust: 100%; 
    text-size-adjust: 100%; 
}

html {
    /* נותן תמיכה ל-Firefox (קידומת) */
    -moz-text-size-adjust: 100%; 
    /* נותן תמיכה ל-Safari ול-Chrome ישנים (קידומת) */
    -webkit-text-size-adjust: 100%; 
    /* המאפיין הסטנדרטי (Chrome/Edge מודרניים) */
    text-size-adjust: 100%;
}

#result-modal, 
#modal-placeholder {
    -webkit-backdrop-filter: blur(5px); 
    backdrop-filter: blur(5px); 
}

.match-card {
    width: 280px; /* רוחב קבוע לכרטיס משחק */
    min-height: 80px;
    background-color: #334155; /* slate-700 */
    border: 1px solid #06B6D4; /* cyan-500 */
}
.player-slot {
    padding: 8px 12px;
    border-bottom: 1px solid #475569; /* slate-600 */
    background-color: #f1f5f9; /* רקע בהיר להדגשה */
    color: #0f172a; /* slate-900 */
    line-height: 1.2;
}
.player-slot:last-child {
    border-bottom: none;
}
/* 2. עיצובי ניצחון והפסד */
.player-slot-winner {
    background: #10B981; /* emerald-500 - ירוק מנצח */
    color: #0F172A; /* Slate-900 */
    font-weight: 700;
    box-shadow: 0 0 10px #10B981;
}
.player-slot-loser {
    background: #64748B; /* slate-500 - אפור מפסיד */
    color: #E2E8F0; /* Slate-200 */
    text-decoration: line-through;
    opacity: 0.8;
}
/* 3. אפקטי זוהר - שיפור נראות */
.header-glow-text {
    text-shadow: 0 0 10px #FBBE24, 0 0 20px #F59E0B;
}
.glow-score {
    text-shadow: 0 0 5px #06B6D4; /* ציאן */
}

/* --- סגנונות חדשים לכותרת הראשית --- */
/* אפקט זוהר/צל לטקסט הראשי */
.header-glow-text {
    /* צל כפול: אחד בהיר לברק, ואחד כתום/זהוב לזוהר */
    text-shadow: 
        0 0 8px rgba(255, 255, 255, 0.6), /* ברק לבן עדין */
        0 0 25px #f59e0b, 	 	 	 	/* זוהר כתום */
    	0 0 40px rgba(245, 158, 11, 0.4); /* פיזור רחב יותר */
    transition: all 0.3s ease-in-out;
}
.header-glow-text:hover {
    text-shadow: 
        0 0 10px #fff,
    	0 0 30px #fbbf24,
    	0 0 50px #d97706;
}

/* --- סגנון מעודכן לכיתוב "תותחי הגמר" (הוקטן) --- */
.finalists-hype-text {
    font-weight: 900; /* סופר מודגש */
    color: #fca5a5; /* Reddish Pink - צבע טקסט בסיס */
    /* אפקט זוהר אדום/ורוד חזק */
    text-shadow: 
        0 0 10px #fca5a5, /* אור בסיסי */
    	0 0 25px #ef4444, /* צל אדום חזק */
    	0 0 40px rgba(239, 68, 68, 0.7); /* פיזור רחב יותר */
}

/* אפקט זוהר חזק לספרת הניקוד */
.glow-score {
    text-shadow:
        0 0 5px #fef08a, /* Lightest yellow glow */
    	0 0 10px #facc15, /* Strong yellow glow */
    	0 0 20px #ca8a04; /* Darker yellow spread */
}

/* הגבהת הטורניר כדי לאפשר יישור אנכי של הגמר */
#bracket {
    min-height: 800px;
}

/* הגדלה והבלטה של האמוג'י (גם הוקטן) */
.finalists-hype-text .text-4xl {
    font-size: 2.5rem !important; /* האימוג'י הוקטן */
    text-shadow: 0 0 10px #ffcc00, 0 0 20px #ff9900; /* זוהר כתום/צהוב לסמל */
    margin: 0 0.5rem;
}

/* סגנון כפתורים מיוחד למשחקיות - בולטות ודינמיות */
button {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem; 
}
button:hover {
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 15px 25px -3px rgba(0, 0, 0, 0.8), 0 0 15px #3b82f650; /* הבהוב קל */
}

/* סגנון למבנה הטורניר */
.match-card {
    min-width: 220px; /* הגדלת רוחב קלפים */
    border: 3px solid #3b82f6; /* גבול כחול בולט למשחק */
    margin-bottom: 16px; /* 16px = h-4 */
    border-radius: 16px;
    background: linear-gradient(145deg, #1e293b, #111827); /* רקע כהה עם עומק */
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    padding: 0; /* ננהל את הריפוד בפנים */
    /* גובה אחיד לכל כרטיס (כולל פדינג פנימי + בורדרים) כדי לאפשר חישובים מדויקים ב-JS */
    height: 80px; /* גובה מותאם לשני ה-player-slot-ים */
}
.player-slot {
    /* נגדיר גובה מדויק לכל סלוט */
    height: 40px; 
    padding: 6px 14px; /* הקטנת פדינג אנכי */
    margin: 0; 
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    font-size: 1rem; /* גודל פונט קטן יותר */
    position: relative;
    z-index: 10;
}


/* סטיילינג לטורניר הנוקאאוט - הטור האמצעי מקבל קו הפרדה ברור */
#tournament-section {
    background-color: #1a202c; /* רקע לוח כהה יותר */
    border: 1px solid #374151;
    padding: 2rem;
}

.round-column {
    min-width: 200px;
    margin: 0 10px;
}
/* קו אנכי לגמר */
.round-column.is-final-column {
    border-left: 3px dashed #FBBF2450;
    border-right: 3px dashed #FBBF2450;
    padding: 0 20px;
}

/* עיצוב מיוחד לגמר - דגש על גדול יותר */
.match-card.final-match {
    border-width: 5px;
    border-color: #FBBF24; /* זהב */
    min-width: 280px;
    /* ביטול סקייל דינמי כדי לשמור על יישור מדויק */
    transform: none; 
    box-shadow: 0 15px 30px rgba(245, 158, 11, 0.8);
    height: 100px; /* גובה גדול יותר לגמר */
}
.match-card.final-match .player-slot {
    height: 50px;
    font-size: 1.25rem;
    padding: 8px 16px;
}


/* עיצוב משופר ל-player-slot (כפי שהיה במקור) */
.player-slot:first-child {
    border-bottom: 1px dashed #3b82f640;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
}
.player-slot:last-child {
    border-bottom-left-radius: 16px;
    border-bottom-right-radius: 16px;
}

.player-slot-empty {
    background-color: #3b82f610; /* כחול שקוף */
    color: #93c5fd; 
    font-style: italic;
    border: none;
}
.player-slot-filled {
    background-color: #3b82f6; /* כחול אקטיבי חזק */
    color: #1f2937; /* טקסט כהה */
    cursor: pointer;
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2); /* אפקט פנימי מבריק */
}
.player-slot-filled:hover {
    background-color: #06b6d4; /* טורקיז בהובר */
}
.player-slot-winner {
    background: linear-gradient(90deg, #FBBF24, #f59e0b); /* Gold to Darker Gold */
    color: #1f2937;
    font-weight: 900;
    transform: none; /* ביטול סקייל כדי לשמור על יישור */
    border: 3px solid #f59e0b;
}
.player-slot-loser {
    background-color: #ef4444; /* אדום */
    color: #1f2937;
    text-decoration: line-through;
    opacity: 0.7;
    font-weight: 500;
}

/* סגנון מיוחד לכרטיס הניצחון - אפקט חגיגי יותר */
#champion-card-container {
    background: linear-gradient(135deg, #1A3D5D, #275078);
    border: 5px solid #FBBF24;
}
#champion-card {
    background: radial-gradient(circle at center, #f59e0b, #ef4444); /* מעבר רדיאלי */
    color: #fff;
    padding: 3rem;
    border-radius: 18px;
    text-align: center;
    font-size: 3.2rem;
    font-weight: 900;
    text-shadow: 0 0 10px #fff;
    box-shadow: 0 15px 30px rgba(245, 158, 11, 0.8);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); box-shadow: 0 15px 30px rgba(245, 158, 11, 0.8); }
    50% { transform: scale(1.03); box-shadow: 0 15px 40px rgba(245, 158, 11, 1); }
    100% { transform: scale(1); box-shadow: 0 15px 30px rgba(245, 158, 11, 0.8); }
}

/* כפתורי המודאל */
#btn-p1-win, #btn-p2-win {
    background: linear-gradient(90deg, #3b82f6, #06b6d4); /* Blue-Cyan Gradient */
    color: white;
}

/* סגנון חלון קופץ (Modal) */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    /* --- התיקון: הוספת הקידומת לספארי --- */
    -webkit-backdrop-filter: blur(5px); 
    backdrop-filter: blur(5px);
}

.modal-content {
    background-color: #1e293b;
    padding: 2rem;
    border-radius: 1rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.9);
    border: 3px solid #f59e0b;
    max-width: 90%;
    text-align: center;
}
.modal-score-button {
    width: 150px;
    padding: 10px;
    font-size: 1.2rem;
    font-weight: bold;
}

</style>
</head>
<body class="rtl text-right">

<!-- הכותרת המעוצבת -->
<div class="text-center py-8 mb-10 shadow-2xl rounded-b-[40px] border-b-8 border-double border-yellow-500" style="background: linear-gradient(180deg, #1e293b, #0F172A);">
    <h1 class="text-6xl md:text-7xl font-extrabold text-amber-400 tracking-wider header-glow-text">
        🏆 טיול גברים: טורניר שש-בש 🎲
    </h1>
    
    <!-- שורה חדשה ומעוצבת להדגשת הפרטים - מבנה מעודכן -->
     <p class="text-xl text-cyan-300 mt-2 font-semibold">
       <span class="text-yellow-300">הפורמט הבלתי מתפשר:</span> **הטוב מ-5**! צריך 3 ניצחונות כדי לבאס את היריב. (16 לוחמים על הכיסא, אבל רק הקוביות יקבעו מי האחד שיהיה על הפודיום).
     </p>
</div>

<!-- כפתורי בקרה -->
<div class="flex justify-center mb-8 space-x-6 space-x-reverse">
    <button type="button" id="start-tournament" class="bg-teal-600 text-white px-8 py-4 rounded-xl font-extrabold text-xl hover:bg-teal-700 transition duration-150">🚀 התחל טורניר (צריך 16 שחקנים)</button>
    <button type="button" id="reset-tournament" onclick="window.resetTournament()" class="bg-orange-700 text-white px-8 py-4 rounded-xl font-extrabold text-xl hover:bg-red-800 transition duration-150">❌ אפס טורניר</button>
</div>

<!-- הודעות סטטוס -->
<div id="status-message" class="text-center text-xl font-semibold mb-6 text-yellow-500 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto"></div>


<!-- טופס רישום שחקנים -->
<div id="registration-section" class="bg-slate-800 p-8 rounded-3xl mb-8 shadow-2xl border border-cyan-500/50 max-w-4xl mx-auto">
    <!-- עדכון ל-16 שחקנים -->
    <h2 class="text-3xl font-bold text-amber-300 mb-5 border-b border-amber-300/30 pb-3 flex items-center gap-3">
        <span class="text-4xl">👥</span>
        רשימת המזליסטים (<span id="team-count">0</span>/16)
    </h2>
	
	<form id="add-team-form" class="flex gap-4 mb-4">
		<input id="team-name" class="flex-grow p-4 bg-slate-700 border-2 border-cyan-400 rounded-xl text-white placeholder-gray-400 focus:ring-cyan-500 focus:border-cyan-500 text-right text-lg shadow-inner" placeholder="הכנס כינוי - שם מלא (לדוגמה: הקוביות - משה כהן)" required />
		<button type="submit" id="add-team" class="bg-cyan-600 p-4 rounded-xl hover:bg-cyan-700 text-white font-bold text-lg" disabled>➕ הוסף שחקן</button>
	</form>

    <div id="registration-alert" class="text-sm h-4 mb-2 text-center text-red-400"></div>

    <ul id="teams-list" class="mt-4 text-gray-200 space-y-3">
        <!-- רשימת השחקנים תוצג כאן -->
    </ul>
</div>

<!-- תצוגת טורניר -->
<div id="tournament-section" class="bg-slate-900 p-6 rounded-3xl shadow-2xl hidden border border-cyan-500/30">
    <h2 class="text-4xl font-black text-amber-400 mb-8 text-center border-b border-amber-400/30 pb-4">⚔️ לוח הקרבות המרכזי - נוקאאוט 16 ⚔️</h2>
    <div id="bracket" class="flex justify-center overflow-x-auto p-4">
        <!-- מבנה הטורניר יוטען כאן -->
    </div>
</div>

<!-- מודאל לעדכון תוצאות - הטוב מ-5 -->
<div id="result-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-slate-800 p-8 rounded-3xl w-full max-w-lg shadow-2xl border-4 border-amber-500 animate-in zoom-in duration-300">
        <h3 id="modal-title" class="text-3xl font-black text-amber-400 mb-6 text-center border-b border-amber-400/30 pb-3">עדכון תוצאת משחק</h3>
        
        <div id="modal-score-display" class="text-4xl text-center mb-6 font-extrabold text-cyan-300 bg-slate-700 p-4 rounded-xl border border-cyan-400 shadow-lg"></div>
        
        <input type="hidden" id="match-id" />

        <p class="text-xl text-center font-semibold text-white mb-6">מי ניצח במשחק הבודד האחרון? (שש-בש)</p>

        <div class="space-y-4">
            <button type="button" id="btn-p1-win" onclick="window.handleGameWin(document.getElementById('match-id').value, 1)" class="w-full p-5 rounded-2xl text-white font-black transition duration-150 flex justify-between items-center text-2xl shadow-xl hover:shadow-cyan-400/50">
                <span id="name-player1" class="text-2xl font-black"></span>
                <span class="text-xl">ניצחון במשחק 🎯</span>
            </button>
            
            <div class="text-center text-3xl font-black text-amber-500">או</div>

            <button type="button" id="btn-p2-win" onclick="window.handleGameWin(document.getElementById('match-id').value, 2)" class="w-full p-5 rounded-2xl text-white font-black transition duration-150 flex justify-between items-center text-2xl shadow-xl hover:shadow-cyan-400/50">
                <span id="name-player2" class="text-2xl font-black"></span>
                <span class="text-xl">ניצחון במשחק 🎯</span>
            </button>
        </div>

        <div class="flex justify-center pt-8">
            <button type="button" onclick="window.closeModal()" class="bg-gray-700 hover:bg-gray-600 p-4 rounded-xl text-white font-semibold transition duration-150 text-xl shadow-md">סגור / חזור ללוח</button>
        </div>
    </div>
</div>

<!-- הודעת סימון -->
<div id="modal-placeholder" class="fixed inset-0 flex items-center justify-center hidden bg-black bg-opacity-70 z-50 p-4">
    <div id="champion-card-container" class="max-w-xl bg-gray-800 p-1 rounded-3xl shadow-2xl">
        <div id="champion-card">
            <!-- הודעת הניצחון תוטען כאן -->
        </div>
        <div class="text-center p-4">
            <button onclick="window.closeChampionModal()" class="bg-cyan-600 text-white px-10 py-4 rounded-xl font-black hover:bg-cyan-700 transition duration-150 shadow-lg text-xl">סגור וחזור ללוח</button>
        </div>
    </div>
</div>

<script type="module">
// --- הגדרות גלובליות ---
const STORAGE_KEY = 'backgammon_tournament_16_players_v2';
const WINS_TO_WIN_MATCH = 3; // הראשון ל-3 ניצחונות משחק (הטוב מ-5)
const MAX_PLAYERS = 16; // *** עדכון ל-16 שחקנים ***
// גובה כרטיס משחק (80px) + מרווח תחתון (mb-4 = 16px).
// זהו הגובה הלוגי של 'שורה אחת' בטורניר.
const MATCH_HEIGHT_UNIT = 80 + 16; // 96px 

// רשימת הכינויים המצחיקים (16 כניסות) - עודכנו לכינויים ממוקדי שש-בש
const FUNNY_NICKNAMES = [
    "מפציץ הדאבל", "הנשנשן המושבע", "שליח שש-שש", "הבכיין המזליסט",
    "האפסנאי של הבר", "מאכלס הבית", "השובר הטורקי", "משקיע הפישפש",
    "הדוחף האגרסיבי", "חוקר ה-24", "שומר הסף (של 5)", "הכובש הבלתי צפוי",
    "מלך הפתיחה", "המלך האשכנזי", "צ'יפמנק הקוביות", "איש ה'בליינד' המסתורי"
];

// --- DOM elements ---
const teamNameInput = document.getElementById('team-name');
const addTeamButton = document.getElementById('add-team');
const startTournamentButton = document.getElementById('start-tournament');
const teamsListElement = document.getElementById('teams-list');
const teamCountElement = document.getElementById('team-count');
const bracketElement = document.getElementById('bracket');
const registrationSection = document.getElementById('registration-section');
const tournamentSection = document.getElementById('tournament-section');
const statusMessage = document.getElementById('status-message');
const registrationAlert = document.getElementById('registration-alert');
const resultModal = document.getElementById('result-modal');
const championModal = document.getElementById('modal-placeholder');
const championCard = document.getElementById('champion-card');

// הגדרה של מצב התחלתי עם 4 סבבים לוגיים
const initialTournamentData = {
    teams: [], 
    status: 'registration', // 'registration', 'in_progress', 'finished'
    matches: {
        roundOf16: [], // שמינית גמר - 8 משחקים
        quarterfinals: [], // רבע גמר - 4 משחקים
        semifinals: [], // חצי גמר - 2 משחקים
        final: [] // גמר - 1 משחק
    },
    winner: null,
    showChampionModal: false 
};

let tournamentData = { ...initialTournamentData }; // שימוש באובייקט התחלתי

// --- Utilities ---

function showRegistrationAlert(message, type = 'info') {
    registrationAlert.textContent = message;
    registrationAlert.className = `text-sm h-4 mb-2 text-center ${type === 'error' ? 'text-red-400' : 'text-lime-400'}`;
    setTimeout(() => {
        registrationAlert.textContent = '';
        registrationAlert.className = 'text-sm h-4 mb-2 text-center';
    }, 3000);
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
}

function getAvailableNickname(currentTeams) {
    const usedNicknames = new Set(currentTeams.map(t => t.nickname).filter(n => n));
    const availableNicknames = FUNNY_NICKNAMES.filter(n => !usedNicknames.has(n));

    if (availableNicknames.length === 0) {
        return null; // אין כינויים פנויים
    }

    const randomIndex = Math.floor(Math.random() * availableNicknames.length);
    return availableNicknames[randomIndex];
}

window.closeModal = () => {
    resultModal.classList.add('hidden');
    saveTournamentState(); // שמירה ורינדור מחדש לאחר סגירת מודאל
};

window.closeChampionModal = () => {
    tournamentData.showChampionModal = false;
    saveTournamentState(); // שמירה ורינדור מחדש
}


// --- Local Storage Functions ---

function loadData() {
    try {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            const parsedData = JSON.parse(storedData);
            if (parsedData && Array.isArray(parsedData.teams) && typeof parsedData.status === 'string') {
                tournamentData = { ...initialTournamentData, ...parsedData };
            } else {
                console.warn("Local Storage: Stored data is corrupted or invalid. Starting fresh.");
                localStorage.removeItem(STORAGE_KEY);
                tournamentData = { ...initialTournamentData }; 
            }
        } else {
            tournamentData = { ...initialTournamentData }; 
        }
    } catch (e) {
        console.error("Local Storage: Error loading data:", e);
        tournamentData = { ...initialTournamentData };
    }
}

function saveTournamentState() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tournamentData));
        renderTournament(tournamentData); // רינדור מיידי לאחר שמירה
    } catch (e) {
        console.error("Local Storage: Error saving data:", e);
        showRegistrationAlert("שגיאה: לא ניתן לשמור את הנתונים בדפדפן.", 'error');
    }
}

// FIX: הפונקציה window.resetTournament() מופעלת ישירות מה-onclick
window.resetTournament = () => {
    // השתמש בלוגיקה שמניחה אישור במקום confirm() שאסור.
    // מאחר ואנחנו לא יכולים להשתמש ב-confirm, נניח שהלחיצה על כפתור האיפוס היא אישור.
    // אם היינו משתמשים במודאל אישור, זה היה המקום לקרוא ל-showConfirmationModal().
    
    // מנקים הכל ומתחילים מחדש
    localStorage.removeItem(STORAGE_KEY);
    tournamentData = { ...initialTournamentData };
    initializeApp();
    statusMessage.textContent = '🧹 הטורניר אופס בהצלחה! ניתן להתחיל רישום מחדש.';
    statusMessage.className = "text-center text-xl font-semibold mb-4 text-amber-400 bg-slate-700/50 p-3 rounded-xl max-w-4xl mx-auto";
    
};

function initializeApp() {
    loadData();
    renderTournament(tournamentData);
    
    // בדיקת ניהול מצב כפתור 'הוסף שחקן'
    const teamCount = tournamentData.teams.length;
    const hasAvailableNicknames = getAvailableNickname(tournamentData.teams) !== null || teamCount === MAX_PLAYERS;

    addTeamButton.disabled = tournamentData.status !== 'registration' || teamCount >= MAX_PLAYERS || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
    
    if (tournamentData.status !== 'registration') {
        statusMessage.textContent = tournamentData.status === 'finished' ? 
            '🎉 הטורניר הסתיים! לחץ "אפס טורניר" כדי להתחיל חדש.' : 
            '🎲 הטורניר בעיצומו! נתונים נשמרים מקומית.';
        statusMessage.className = "text-center text-xl font-semibold mb-6 text-cyan-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
    } else {
        statusMessage.textContent = `✅ מצב מקומי (Local Storage) פעיל. הנתונים נשמרים בדפדפן זה. יש לרשום ${MAX_PLAYERS} שחקנים.`;
        statusMessage.className = "text-center text-xl font-semibold mb-6 text-lime-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
    }
}


// --- UI Rendering ---

function renderTournament(data) {
    const { teams, status, winner, showChampionModal } = data;

    // 1. עדכון רשימת השחקנים וכפתור ההתחלה
    teamsListElement.innerHTML = '';
    teamCountElement.textContent = teams.length;
    
    teams.forEach((team, index) => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center bg-slate-700 p-3 rounded-xl text-white font-medium shadow-md border border-cyan-500/30'; 
        const displayName = `${team.nickname || 'אין כינוי'} <span class="text-amber-300 font-normal">(${team.name})</span>`;
        li.innerHTML = `
            <span class="text-xl">${index + 1}. ${displayName}</span>
		<button **type="button"** class="text-red-400 hover:text-red-500 text-lg bg-transparent p-1 rounded-full hover:bg-red-900/50 transition font-bold" onclick="removeTeam('${team.id}')" ${status !== 'registration' ? 'disabled' : ''}>[X] הסר</button>        `;
        teamsListElement.appendChild(li);
    });

    if (teams.length === 0) {
        teamsListElement.innerHTML = `<li class="text-gray-400 text-center py-4 italic text-lg">🎲 נדרשים ${MAX_PLAYERS} שחקנים להתחלת הטורניר. הוסף שחקנים למעלה.</li>`;
    }

    // 2. ניהול מצב ההרשמה וכפתור ה'התחל טורניר'
    const teamCount = teams.length;
    const hasAvailableNicknames = getAvailableNickname(teams) !== null || teamCount === MAX_PLAYERS;
    
    addTeamButton.disabled = tournamentData.status !== 'registration' || teamCount >= MAX_PLAYERS || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
    
    startTournamentButton.disabled = tournamentData.status !== 'registration' || teamCount !== MAX_PLAYERS;
    startTournamentButton.textContent = teamCount === MAX_PLAYERS ? '🚀 התחל טורניר! יאללה בלאגן' : `צריך עוד ${MAX_PLAYERS - teamCount} שחקנים`;

    if (status === 'registration') {
        registrationSection.classList.remove('hidden');
        tournamentSection.classList.add('hidden');
    } else {
        registrationSection.classList.add('hidden');
        tournamentSection.classList.remove('hidden');
    }
    
    // 3. הצגת טבלת הנוקאאוט
    renderSplitBracket(data.matches, winner, showChampionModal);
}

// פונקציה מעודכנת להצגת מבנה הטורניר המפוצל ל-16 שחקנים עם יישור משופר
function renderSplitBracket(matches, tournamentWinner, showChampionModal) {
    bracketElement.innerHTML = '';

    if (tournamentWinner && showChampionModal) {
        championCard.innerHTML = `
            <div class="flex flex-col items-center space-y-4">
                <span class="text-8xl">👑</span>
                <span class="text-4xl font-extrabold text-white">המנצח של הטיול:</span>
                <span class="text-7xl font-black text-white">${tournamentWinner.name}</span>
                <p class="text-3xl mt-4 text-cyan-200">(${tournamentWinner.nickname}) זכית בכבוד הנצחי!</p>
            </div>
        `;
        championModal.classList.remove('hidden');
    } else {
        championModal.classList.add('hidden');
    }

    // ריכוז כל המשחקים לפי מזהה לשליפה נוחה
    const allMatches = [...matches.roundOf16, ...matches.quarterfinals, ...matches.semifinals, ...matches.final].reduce((acc, m) => {
        acc[m.id] = m;
        return acc;
    }, {});

    // הגדרת מבנה הטורניר המפוצל ל-7 טורים
    const H = MATCH_HEIGHT_UNIT; // 96px (Match Card height + margin-bottom)

    // חישוב רווחים מדויקים (בכפולות של H) ליישור אנכי
    // R16 (4 matches, 1H between them, 0.5H initial offset)
    const R16_Spacers = [H * 0.5, H, H, H]; // 48, 96, 96, 96

    // QF (2 matches, centered over 2 R16 pairs)
    // S1: 1.5H (144px). S2: 3.0H (288px)
    const QF_Spacers = [H * 1.5, H * 3.0]; 

    // SF (1 match, centered over 2 QF matches)
    // S1: 3.5H (336px)
    const SF_Spacers = [H * 3.5];

    // FINAL (1 match, centered over the whole R16 structure - 8 slots)
    // S1: 3.5H (336px)
    const Final_Spacers = [H * 3.5];


    const columnStructure = [
        // 1. שמינית גמר - ימין (R16_R) - 4 משחקים
        { key: 'R16_R', title: 'שמינית גמר (1/8)', matchIds: ['r1m1', 'r1m2', 'r1m3', 'r1m4'], spacerHeights: R16_Spacers, titleColor: 'text-cyan-400' },
        
        // 2. רבע גמר - ימין (QF_R) - 2 משחקים
        { key: 'QF_R', title: 'רבע גמר (1/4)', matchIds: ['r2m1', 'r2m2'], spacerHeights: QF_Spacers, titleColor: 'text-cyan-400' },
        
        // 3. חצי גמר - ימין (SF_R) - 1 משחק
        { key: 'SF_R', title: 'חצי גמר (1/2)', matchIds: ['r3m1'], spacerHeights: SF_Spacers, titleColor: 'text-cyan-400' },
        
        // 4. גמר (Final) - 1 משחק - מרכז (גדול יותר)
        { key: 'Final', title: 'הגמר הגדול', matchIds: ['r4m1'], spacerHeights: Final_Spacers, isFinal: true, titleColor: 'text-amber-300' },
        
        // 5. חצי גמר - שמאל (SF_L) - 1 משחק (שיקוף)
        { key: 'SF_L', title: 'חצי גמר (1/2)', matchIds: ['r3m2'], spacerHeights: SF_Spacers, titleColor: 'text-cyan-400' },
        
        // 6. רבע גמר - שמאל (QF_L) - 2 משחקים (שיקוף)
        { key: 'QF_L', title: 'רבע גמר (1/4)', matchIds: ['r2m3', 'r2m4'], spacerHeights: QF_Spacers, titleColor: 'text-cyan-400' },
        
        // 7. שמינית גמר - שמאל (R16_L) - 4 משחקים (שיקוף)
        { key: 'R16_L', title: 'שמינית גמר (1/8)', matchIds: ['r1m5', 'r1m6', 'r1m7', 'r1m8'], spacerHeights: R16_Spacers, titleColor: 'text-cyan-400' },
    ];


    columnStructure.forEach(col => {
        const roundColumn = document.createElement('div');
        roundColumn.className = `flex flex-col items-center p-2 mx-2 ${col.isFinal ? 'is-final-column' : 'round-column'}`;
        
        let preTitle = '';

        if (col.isFinal) {
            // שינוי הכוכב לגביע
            preTitle = '<div class="text-4xl text-amber-500 mb-2">🏆</div>'; 
        }
        
        // הוספת כותרת לכל טור
        roundColumn.innerHTML = `
            ${preTitle}
            <h3 class="text-2xl font-black ${col.titleColor} mb-6 text-center">${col.title}</h3>
        `;
        
        let spacerIndex = 0;

        col.matchIds.forEach((matchId) => {
            const match = allMatches[matchId];
            if (!match) return;
            
            // הוספת רווח לפני המשחק
            if (col.spacerHeights[spacerIndex] !== undefined) {
                const spacerHeight = col.spacerHeights[spacerIndex];
                const spacer = document.createElement('div');
                spacer.style.height = `${spacerHeight}px`;
                spacer.className = `w-full`;
                roundColumn.appendChild(spacer);
                spacerIndex++;
            }

            const matchContainer = document.createElement('div');
            matchContainer.id = match.id;
            
            let matchClass = 'match-card mb-4 rounded-xl flex flex-col justify-center';
            
            // עיצוב מיוחד לגמר (הפיכה לגדול יותר)
            if (matchId === 'r4m1') {
                matchClass += ' final-match'; // שימוש בקלאס CSS שהוגדר למעלה
            }
            
            matchContainer.className = matchClass;

            const matchInfo = document.createElement('div');
            matchInfo.className = 'flex flex-col w-full';

            const player1Slot = createPlayerSlot(match, match.player1, match.gameWins1, true); // true for P1
            const player2Slot = createPlayerSlot(match, match.player2, match.gameWins2, false); // false for P2
            
            matchInfo.appendChild(player1Slot);
            matchInfo.appendChild(player2Slot);
            matchContainer.appendChild(matchInfo);
            
            roundColumn.appendChild(matchContainer);
			
			// === הוספת ההודעה המבוקשת מתחת לגמר הגדול (r4m1) ===

            if (matchId === 'r4m1') {

                const announcement = document.createElement('div');

                announcement.className = 'mt-4 p-3 bg-red-800/70 border-4 border-red-500 rounded-xl text-white text-center font-bold text-lg shadow-2xl animate-pulse w-full';

                announcement.innerHTML = `

                    <p class="text-xl font-extrabold text-yellow-300 mb-1">📢 הודעת שידור חי!!!</p>

                    החל מרבע גמר כל המשחקים יעברו בשידור חי ב"צריכים משהו גבים"

                `;

                roundColumn.appendChild(announcement);

            }
        });

        bracketElement.appendChild(roundColumn);
    });
}

function createPlayerSlot(match, player, gameWins, isPlayer1) {
    const slotEl = document.createElement('div');
    slotEl.className = 'player-slot relative';
    
    let playerName = player?.name || (match.status === 'pending' ? 'ממתין לזוכה' : '---');
    let winsDisplay = gameWins > 0 ? `(${gameWins}/${WINS_TO_WIN_MATCH})` : ''; 
    let icon = '🎲'; // אייקון קובייה לבאקגמון

    // שילוב שם וכינוי להצגה
    let displayNameHtml = playerName;
    if (player && player.nickname) {
        // לוודא שהצבעים משתלבים טוב עם רקע ה-winner/loser
        const nicknameColor = match.winnerId ? 'text-gray-900/80' : 'text-slate-900/80';
        displayNameHtml = `${player.nickname} <span class="text-sm font-normal ${nicknameColor}">(${player.name})</span>`;
    }

    let isWinner = match.winnerId && player && match.winnerId === player.id;
    let isLoser = match.winnerId && player && match.winnerId !== player.id;
    let isEmpty = !player && match.status !== 'pending';

    if (isEmpty) {
        slotEl.classList.remove('player-slot-filled');
        slotEl.classList.add('player-slot-empty');
        icon = '...';
        displayNameHtml = playerName; // לא להציג כינוי אם ריק
    } else if (isWinner) {
        slotEl.classList.add('player-slot-winner');
        winsDisplay = `(המנצח!)`; 
        icon = '👑';
    } else if (isLoser) {
        slotEl.classList.add('player-slot-loser');
        icon = '❌';
    } else if (player) {
        slotEl.classList.add('player-slot-filled');
    }
    
    // התוכן של הסלוט
    slotEl.innerHTML = `
        <span class="text-base font-bold flex items-center gap-2">
            ${icon} ${displayNameHtml}
        </span>
        <span class="font-black text-sm">${winsDisplay}</span>
    `;

    // הוספת יכולת לחיצה רק אם המשחק מוכן וטרם הסתיים
    if (!match.winnerId && match.player1 && match.player2) {
        slotEl.onclick = () => window.openModal(match.id);
        slotEl.classList.add('cursor-pointer', 'transition');
    }
    
    return slotEl;
}


// --- Tournament Logic ---

window.removeTeam = (playerIdToRemove) => {
    if (tournamentData.status !== 'registration') return;
    tournamentData.teams = tournamentData.teams.filter(t => t.id !== playerIdToRemove);
    saveTournamentState();
}

document.getElementById('add-team-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const playerName = teamNameInput.value.trim();
    if (!playerName || playerName.length < 2) return;

    if (tournamentData.teams.length >= MAX_PLAYERS || tournamentData.status !== 'registration') {
        showRegistrationAlert(`הגעת למגבלה (${MAX_PLAYERS} שחקנים) או הטורניר כבר החל.`, 'error');
        return;
    }
    
    if (tournamentData.teams.some(t => t.name.toLowerCase() === playerName.toLowerCase())) {
        showRegistrationAlert("השחקן הזה כבר רשום!", 'error');
        return;
    }

    // *** הוספת הכינוי המצחיק ***
    const nickname = getAvailableNickname(tournamentData.teams);

    if (!nickname) {
        showRegistrationAlert("שגיאה: הגעת למספר הכינויים המקסימלי (16). לא ניתן להוסיף שחקנים נוספים.", 'error');
        return;
    }

    const newPlayer = { id: generateId(), name: playerName, nickname: nickname };
    tournamentData.teams.push(newPlayer);
    teamNameInput.value = '';
    teamNameInput.focus();
    showRegistrationAlert(`השחקן ${playerName} (הכינוי: ${nickname}) נוסף בהצלחה!`);
    
    saveTournamentState(); 
});

teamNameInput.addEventListener('input', () => {
    const hasAvailableNicknames = getAvailableNickname(tournamentData.teams) !== null || tournamentData.teams.length === MAX_PLAYERS;
    addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= MAX_PLAYERS || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
});


function generateBracket() {
    const players = shuffle([...tournamentData.teams]); 
    const matches = {
        roundOf16: [], quarterfinals: [], semifinals: [], final: []
    };

    if (players.length !== MAX_PLAYERS) {
        showRegistrationAlert(`שגיאה: נדרשים ${MAX_PLAYERS} שחקנים כדי להתחיל את הטורניר. רשומים רק ${players.length}.`, 'error');
        return;
    }


    // 1. שמינית גמר (Round of 16 - 8 matches)
    for (let i = 0; i < 8; i++) {
        matches.roundOf16.push({
            id: `r1m${i + 1}`,
            player1: players[i * 2],
            player2: players[i * 2 + 1],
            gameWins1: 0,
            gameWins2: 0,
            winnerId: null,
            // r1m1, r1m2 -> r2m1 | r1m3, r1m4 -> r2m2 | r1m5, r1m6 -> r2m3 | r1m7, r1m8 -> r2m4
            nextMatchId: `r2m${Math.floor(i / 2) + 1}`, 
            nextPlayerSlot: (i % 2) === 0 ? 1 : 2, // 1st match feeds slot 1, 2nd feeds slot 2
            status: 'active'
        });
    }

    // 2. רבע גמר (Quarterfinals - 4 matches)
    for (let i = 0; i < 4; i++) {
        matches.quarterfinals.push({
            id: `r2m${i + 1}`,
            player1: null, // Filled by R16 winners
            player2: null, // Filled by R16 winners
            gameWins1: 0,
            gameWins2: 0,
            winnerId: null,
            // r2m1, r2m2 -> r3m1 | r2m3, r2m4 -> r3m2
            nextMatchId: `r3m${Math.floor(i / 2) + 1}`,
            nextPlayerSlot: (i % 2) === 0 ? 1 : 2,
            status: 'pending'
        });
    }

    // 3. חצי גמר (Semifinals - 2 matches)
    for (let i = 0; i < 2; i++) {
        matches.semifinals.push({
            id: `r3m${i + 1}`,
            player1: null, // Filled by QF winners
            player2: null, // Filled by QF winners
            gameWins1: 0,
            gameWins2: 0,
            winnerId: null,
            // r3m1, r3m2 -> r4m1 (The Final)
            nextMatchId: `r4m1`,
            nextPlayerSlot: i + 1, // r3m1 feeds slot 1, r3m2 feeds slot 2
            status: 'pending'
        });
    }

    // 4. גמר (Final - 1 match)
    matches.final.push({
        id: `r4m1`,
        player1: null, // Filled by SF winners
        player2: null, // Filled by SF winners
        gameWins1: 0,
        gameWins2: 0,
        winnerId: null,
        nextMatchId: null, // Last match
        nextPlayerSlot: null,
        status: 'pending'
    });
    
    // הגדרת מצב הטורניר ושמירה
    tournamentData.matches = matches;
    tournamentData.status = 'in_progress';
    tournamentData.winner = null;
    tournamentData.showChampionModal = false;
    showRegistrationAlert('🚀 הטורניר החל! בהצלחה לכל המשתתפים.', 'info');
    saveTournamentState();
}

// מחזיר את אובייקט המשחק ואת המפתח של הסיבוב שלו
function findMatch(matchId) {
    for (const roundKey in tournamentData.matches) {
        const match = tournamentData.matches[roundKey].find(m => m.id === matchId);
        if (match) return { match, roundKey };
    }
    return { match: null, roundKey: null };
}

// פתיחת חלון קופץ לעדכון תוצאות
window.openModal = (matchId) => {
    const { match } = findMatch(matchId);

    if (!match || match.winnerId || !match.player1 || !match.player2) return;

    document.getElementById('match-id').value = matchId;
    document.getElementById('name-player1').textContent = match.player1.name;
    document.getElementById('name-player2').textContent = match.player2.name;
	
	const greenClasses = 'w-full p-5 rounded-2xl text-white font-black transition duration-150 flex justify-between items-center text-2xl shadow-xl hover:shadow-green-400/50 hover:bg-green-600';

	const btnP1 = document.getElementById('btn-p1-win');
	const btnP2 = document.getElementById('btn-p2-win');

	// 2. החלפת הקלאסים
	btnP1.className = greenClasses;
	btnP2.className = greenClasses;

	// 3. דריסה חזקה: הגדרת צבע רקע ירוק ישירות ב-style
	btnP1.style.backgroundColor = '#047857'; // Tailwind green-700
	btnP2.style.backgroundColor = '#047857'; // Tailwind green-700

	// 4. חשוב: יש לוודא שצבע הכיתוב הוא לבן
	btnP1.style.color = '#ffffff'; 
	btnP2.style.color = '#ffffff';

    const scoreDisplay = document.getElementById('modal-score-display');
    scoreDisplay.innerHTML = `
        <div class="flex justify-around items-center">
            <span class="text-xl text-amber-300 font-normal">${match.player1.name}</span>
            <span class="text-6xl text-white font-extrabold glow-score">${match.gameWins1}</span>
            <span class="text-4xl text-gray-400 font-bold">:</span>
            <span class="text-6xl text-white font-extrabold glow-score">${match.gameWins2}</span>
            <span class="text-xl text-amber-300 font-normal">${match.player2.name}</span>
        </div>
        <p class="text-sm mt-2 text-red-300 font-bold">הראשון ל-${WINS_TO_WIN_MATCH} ניצחונות משחק מנצח את המפגש!</p>
    `;

    resultModal.classList.remove('hidden');
};

// טיפול בניצחון משחק בודד (העלאת ניקוד)
window.handleGameWin = (matchId, winnerPlayerNumber) => {
    const { match } = findMatch(matchId);
    if (!match || match.winnerId) return;

    const scoreToUpdate = winnerPlayerNumber === 1 ? 'gameWins1' : 'gameWins2';
    match[scoreToUpdate]++;

    // עדכון תצוגת הניקוד במודאל באופן מיידי
    const scoreDisplay = document.getElementById('modal-score-display');
    scoreDisplay.innerHTML = `
        <div class="flex justify-around items-center">
            <span class="text-xl text-amber-300 font-normal">${match.player1.name}</span>
            <span class="text-6xl text-white font-extrabold glow-score">${match.gameWins1}</span>
            <span class="text-4xl text-gray-400 font-bold">:</span>
            <span class="text-6xl text-white font-extrabold glow-score">${match.gameWins2}</span>
            <span class="text-xl text-amber-300 font-normal">${match.player2.name}</span>
        </div>
        <p class="text-sm mt-2 text-red-300 font-bold">הראשון ל-${WINS_TO_WIN_MATCH} ניצחונות משחק מנצח את המפגש!</p>
    `;

    // בדיקה האם המפגש הסתיים (הטוב מ-5 / הראשון ל-3)
    if (match.gameWins1 === WINS_TO_WIN_MATCH || match.gameWins2 === WINS_TO_WIN_MATCH) {
        match.winnerId = match.gameWins1 === WINS_TO_WIN_MATCH ? match.player1.id : match.player2.id;
        const winnerPlayer = match.winnerId === match.player1.id ? match.player1 : match.player2;

        window.closeModal();
        advanceWinner(match, winnerPlayer);
    }

    saveTournamentState();
};

// קידום המנצח למשחק הבא
function advanceWinner(currentMatch, winnerPlayer) {
    if (!currentMatch.nextMatchId) {
        // הטורניר הסתיים!
        tournamentData.status = 'finished';
        tournamentData.winner = winnerPlayer;
        tournamentData.showChampionModal = true;
        saveTournamentState();
        return;
    }

    const { match: nextMatch } = findMatch(currentMatch.nextMatchId);

    if (nextMatch) {
        if (currentMatch.nextPlayerSlot === 1) {
            nextMatch.player1 = winnerPlayer;
        } else {
            nextMatch.player2 = winnerPlayer;
        }
        // אם שני הסלוטים מלאים, המשחק הופך לפעיל
        if (nextMatch.player1 && nextMatch.player2) {
            nextMatch.status = 'active';
        }
    }

    saveTournamentState();
}

// קריאה לפונקציית יצירת המבנה בלחיצה על 'התחל'
document.getElementById('start-tournament').addEventListener('click', generateBracket);

// אתחול האפליקציה בטעינת הדף
initializeApp();
</script>
</body>
</html>
