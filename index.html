<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>××¢×¨×›×ª × ×™×”×•×œ ×˜×•×¨× ×™×¨ ×©×©-×‘×© (×”×¨××©×•×Ÿ ×œ-3)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ×”×’×“×¨×•×ª ×’×•×¤×Ÿ ×•×¨×§×¢ ×›×œ×œ×™ - ×¡×›××” ×× ×¨×’×˜×™×ª ××¢×•×“×›× ×ª */
body {
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background-color: #0F172A; /* Dark Slate Blue - ×›×—×•×œ ×¦×™ ×œ×™×œ×” */
    color: #f3f4f6; /* Light text for contrast */
    padding: 1rem;
}

/* ×¡×’× ×•×Ÿ ×›×¤×ª×•×¨×™× ××™×•×—×“ ×œ××©×—×§×™×•×ª - ×‘×•×œ×˜×•×ª ×•×“×™× ××™×•×ª */
button {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.5), 0 0 10px rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.75rem; 
}
button:hover {
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 15px 25px -3px rgba(0, 0, 0, 0.8), 0 0 15px #3b82f650; /* ×”×‘×”×•×‘ ×§×œ */
}

/* ×¡×’× ×•×Ÿ ×œ××‘× ×” ×”×˜×•×¨× ×™×¨ */
.match-card {
    min-width: 220px; /* ×”×’×“×œ×ª ×¨×•×—×‘ ×§×œ×¤×™× */
    border: 3px solid #3b82f6; /* ×’×‘×•×œ ×›×—×•×œ ×‘×•×œ×˜ ×œ××©×—×§ */
    margin-bottom: 16px;
    border-radius: 16px;
    background: linear-gradient(145deg, #1e293b, #111827); /* ×¨×§×¢ ×›×”×” ×¢× ×¢×•××§ */
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
    padding: 0; /* × × ×”×œ ××ª ×”×¨×™×¤×•×“ ×‘×¤× ×™× */
}

/* ×”×’×‘×”×ª ×”×˜×•×¨× ×™×¨ ×›×“×™ ×œ××¤×©×¨ ×™×™×©×•×¨ ×× ×›×™ ×©×œ ×”×’××¨ */
#bracket {
    min-height: 550px;
}

/* ×¡×˜×™×™×œ×™× ×’ ×œ×˜×•×¨× ×™×¨ ×”× ×•×§×××•×˜ - ×”×˜×•×¨ ×”×××¦×¢×™ ××§×‘×œ ×§×• ×”×¤×¨×“×” ×‘×¨×•×¨ */
#tournament-section {
    background-color: #1a202c; /* ×¨×§×¢ ×œ×•×— ×›×”×” ×™×•×ª×¨ */
    border: 1px solid #374151;
    padding: 2rem;
}

.round-column {
    min-width: 200px;
    margin: 0 10px;
}
/* ×§×• ×× ×›×™ ×œ×’××¨ */
.round-column.is-final-column {
    border-left: 3px dashed #FBBF2450;
    border-right: 3px dashed #FBBF2450;
    padding: 0 20px;
}

.player-slot {
    padding: 10px 14px;
    margin: 0; /* ×œ×œ× ××¨×•×•×— ×¤× ×™××™ ×‘×™×Ÿ ×”×©×—×§× ×™× ×‘×›×¨×˜×™×¡ */
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    font-size: 1.1rem;
    position: relative;
    z-index: 10;
}

/* ××¤×¨×™×“ ×•×™×–×•××œ×™ ×‘×™×Ÿ ×”×©×—×§× ×™× ×‘×›×¨×˜×™×¡ */
.player-slot:first-child {
    border-bottom: 1px dashed #3b82f640;
    border-top-left-radius: 16px;
    border-top-right-radius: 16px;
}
.player-slot:last-child {
    border-bottom-left-radius: 16px;
    border-bottom-right-radius: 16px;
}

.player-slot-empty {
    background-color: #3b82f610; /* ×›×—×•×œ ×©×§×•×£ */
    color: #93c5fd; 
    font-style: italic;
    border: none;
}
.player-slot-filled {
    background-color: #3b82f6; /* ×›×—×•×œ ××§×˜×™×‘×™ ×—×–×§ */
    color: #1f2937; /* ×˜×§×¡×˜ ×›×”×” */
    cursor: pointer;
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2); /* ××¤×§×˜ ×¤× ×™××™ ××‘×¨×™×§ */
}
.player-slot-filled:hover {
    background-color: #06b6d4; /* ×˜×•×¨×§×™×– ×‘×”×•×‘×¨ */
}
.player-slot-winner {
    background: linear-gradient(90deg, #FBBF24, #f59e0b); /* Gold to Darker Gold */
    color: #1f2937;
    font-weight: 900;
    transform: scale(1.02);
    border: 3px solid #f59e0b;
}
.player-slot-loser {
    background-color: #ef4444; /* ××“×•× */
    color: #1f2937;
    text-decoration: line-through;
    opacity: 0.7;
    font-weight: 500;
}

/* ×¡×’× ×•×Ÿ ××™×•×—×“ ×œ×›×¨×˜×™×¡ ×”× ×™×¦×—×•×Ÿ - ××¤×§×˜ ×—×’×™×’×™ ×™×•×ª×¨ */
#champion-card-container {
    background: linear-gradient(135deg, #1A3D5D, #275078);
    border: 5px solid #FBBF24;
}
#champion-card {
    background: radial-gradient(circle at center, #f59e0b, #ef4444); /* ××¢×‘×¨ ×¨×“×™××œ×™ */
    color: #fff;
    padding: 3rem;
    border-radius: 18px;
    text-align: center;
    font-size: 3.2rem;
    font-weight: 900;
    text-shadow: 0 0 10px #fff;
    box-shadow: 0 15px 30px rgba(245, 158, 11, 0.8);
    animation: pulse 1.5s infinite;
}

/* ×›×¤×ª×•×¨×™ ×”××•×“××œ */
#btn-p1-win, #btn-p2-win {
    background: linear-gradient(90deg, #3b82f6, #06b6d4); /* Blue-Cyan Gradient */
    color: white;
}
</style>
</head>
<body class="rtl text-right">

<!-- ×©×™× ×•×™ ×¦×‘×¢×™ ×¨×§×¢ ×•×›×•×ª×¨×•×ª ×œ×××‘×¨ ×•×‘×•×œ×˜×•×ª -->
<div class="text-center py-6 bg-slate-900 rounded-b-3xl mb-8 shadow-2xl border-b-4 border-cyan-500">
    <h1 class="text-5xl font-black text-amber-400 tracking-wider">ğŸ† ×˜×™×•×œ ×’×‘×¨×™×: ×˜×•×¨× ×™×¨ ×©×©-×‘×© ğŸ²</h1>
    <p class="text-xl text-cyan-300 mt-2 font-semibold">×¤×•×¨××˜: **×”×¨××©×•×Ÿ ×œ-3 × ×™×¦×—×•× ×•×ª ××©×—×§** (×”×˜×•×‘ ×-5)</p>
</div>

<!-- ×›×¤×ª×•×¨×™ ×‘×§×¨×” -->
<div class="flex justify-center mb-8 space-x-6 space-x-reverse">
    <!-- ×›×¤×ª×•×¨ ×”×ª×—×œ×” ×‘×˜×•×¨×§×™×– ×‘×•×œ×˜ -->
    <button id="start-tournament" class="bg-teal-600 text-white px-8 py-4 rounded-xl font-extrabold text-xl hover:bg-teal-700 transition duration-150">ğŸš€ ×”×ª×—×œ ×˜×•×¨× ×™×¨ (×¦×¨×™×š 8 ×©×—×§× ×™×)</button>
    
    <!-- ×›×¤×ª×•×¨ ××™×¤×•×¡ ×‘×›×ª×•× ×—×–×§ -->
    <button id="reset-tournament" onclick="window.resetTournament()" class="bg-orange-700 text-white px-8 py-4 rounded-xl font-extrabold text-xl hover:bg-red-800 transition duration-150">âŒ ××¤×¡ ×˜×•×¨× ×™×¨</button>
</div>

<!-- ×”×•×“×¢×•×ª ×¡×˜×˜×•×¡ -->
<div id="status-message" class="text-center text-xl font-semibold mb-6 text-yellow-500 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto"></div>


<!-- ×˜×•×¤×¡ ×¨×™×©×•× ×©×—×§× ×™× -->
<div id="registration-section" class="bg-slate-800 p-8 rounded-3xl mb-8 shadow-2xl border border-cyan-500/50 max-w-4xl mx-auto">
    <h2 class="text-3xl font-bold text-amber-300 mb-5 border-b border-amber-300/30 pb-3 flex items-center gap-3">
        <span class="text-4xl">ğŸ‘¥</span>
        ×¨×©×™××ª ×”×œ×•×—××™× (<span id="team-count">0</span>/8)
    </h2>
    <form id="add-team-form" class="flex gap-4 mb-4">
        <input id="team-name" class="flex-grow p-4 bg-slate-700 border-2 border-cyan-400 rounded-xl text-white placeholder-gray-400 focus:ring-cyan-500 focus:border-cyan-500 text-right text-lg shadow-inner" placeholder="×”×›× ×¡ ×›×™× ×•×™/×©× ××œ×š ×”×©×©-×‘×©..." required />
        <!-- ×›×¤×ª×•×¨ ×”×•×¡×¤×” ×‘×›×—×•×œ ×—×™ -->
        <button id="add-team" class="bg-cyan-600 p-4 rounded-xl hover:bg-cyan-700 text-white font-bold text-lg" disabled>â• ×”×•×¡×£ ×©×—×§×Ÿ</button>
    </form>
    <div id="registration-alert" class="text-sm h-4 mb-2 text-center"></div>

    <ul id="teams-list" class="mt-4 text-gray-200 space-y-3">
        <!-- ×¨×©×™××ª ×”×©×—×§× ×™× ×ª×•×¦×’ ×›××Ÿ -->
    </ul>
</div>

<!-- ×ª×¦×•×’×ª ×˜×•×¨× ×™×¨ -->
<div id="tournament-section" class="bg-slate-900 p-6 rounded-3xl shadow-2xl hidden border border-cyan-500/30">
    <h2 class="text-4xl font-black text-amber-400 mb-8 text-center border-b border-amber-400/30 pb-4">âš”ï¸ ×œ×•×— ×”×§×¨×‘×•×ª ×”××¨×›×–×™ - × ×•×§×××•×˜ âš”ï¸</h2>
    <div id="bracket" class="flex justify-center overflow-x-auto p-4">
        <!-- ××‘× ×” ×”×˜×•×¨× ×™×¨ ×™×•×˜×¢×Ÿ ×›××Ÿ -->
    </div>
</div>

<!-- ××•×“××œ ×œ×¢×“×›×•×Ÿ ×ª×•×¦××•×ª - ×”×˜×•×‘ ×-5 -->
<div id="result-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-slate-800 p-8 rounded-3xl w-full max-w-lg shadow-2xl border-4 border-amber-500 animate-in zoom-in duration-300">
        <h3 id="modal-title" class="text-3xl font-black text-amber-400 mb-6 text-center border-b border-amber-400/30 pb-3">×¢×“×›×•×Ÿ ×ª×•×¦××ª ××©×—×§</h3>
        
        <div id="modal-score-display" class="text-4xl text-center mb-6 font-extrabold text-cyan-300 bg-slate-700 p-4 rounded-xl border border-cyan-400 shadow-lg"></div>
        
        <input type="hidden" id="match-id" />

        <p class="text-xl text-center font-semibold text-white mb-6">××™ × ×™×¦×— ×‘××©×—×§ ×”×‘×•×“×“ ×”××—×¨×•×Ÿ? (×©×©-×‘×©)</p>

        <div class="space-y-4">
            <button type="button" id="btn-p1-win" onclick="window.handleGameWin(document.getElementById('match-id').value, 1)" class="w-full p-5 rounded-2xl text-white font-black transition duration-150 flex justify-between items-center text-2xl shadow-xl hover:shadow-cyan-400/50">
                <span id="name-player1" class="text-2xl font-black"></span>
                <span class="text-xl">× ×™×¦×—×•×Ÿ ×‘××©×—×§ ğŸ¯</span>
            </button>
            
            <div class="text-center text-3xl font-black text-amber-500">OR</div>

            <button type="button" id="btn-p2-win" onclick="window.handleGameWin(document.getElementById('match-id').value, 2)" class="w-full p-5 rounded-2xl text-white font-black transition duration-150 flex justify-between items-center text-2xl shadow-xl hover:shadow-cyan-400/50">
                <span id="name-player2" class="text-2xl font-black"></span>
                <span class="text-xl">× ×™×¦×—×•×Ÿ ×‘××©×—×§ ğŸ¯</span>
            </button>
        </div>

        <div class="flex justify-center pt-8">
            <button type="button" onclick="window.closeModal()" class="bg-gray-700 hover:bg-gray-600 p-4 rounded-xl text-white font-semibold transition duration-150 text-xl shadow-md">×¡×’×•×¨ / ×—×–×•×¨ ×œ×œ×•×—</button>
        </div>
    </div>
</div>

<!-- ×”×•×“×¢×ª ×¡×™××•×Ÿ -->
<div id="modal-placeholder" class="fixed inset-0 flex items-center justify-center hidden bg-black bg-opacity-70 z-50 p-4">
    <div id="champion-card-container" class="max-w-xl bg-gray-800 p-1 rounded-3xl shadow-2xl">
        <div id="champion-card">
            <!-- ×”×•×“×¢×ª ×”× ×™×¦×—×•×Ÿ ×ª×•×˜×¢×Ÿ ×›××Ÿ -->
        </div>
        <div class="text-center p-4">
            <button onclick="window.closeChampionModal()" class="bg-cyan-600 text-white px-10 py-4 rounded-xl font-black hover:bg-cyan-700 transition duration-150 shadow-lg text-xl">×¡×’×•×¨ ×•×—×–×•×¨ ×œ×œ×•×—</button>
        </div>
    </div>
</div>

<script type="module">
// --- ×”×’×“×¨×•×ª ×’×œ×•×‘×œ×™×•×ª ---
// ×©× ××¤×ª×— ×”-localStorage ×œ×©××™×¨×ª × ×ª×•× ×™ ×”×˜×•×¨× ×™×¨
const STORAGE_KEY = 'backgammon_tournament_data_v1';
const WINS_TO_WIN_MATCH = 3; // ×”×¨××©×•×Ÿ ×œ-3 × ×™×¦×—×•× ×•×ª ××©×—×§ (×”×˜×•×‘ ×-5)

// ×¨×©×™××ª ×”×›×™× ×•×™×™× ×”××¦×—×™×§×™×
const FUNNY_NICKNAMES = [
    "×”×§×•×‘×™×” ×”××©×ª×•×œ×œ×ª",
    "×”××–×œ×–×œ ×”× ×¦×—×™",
    "×”×× ×’×œ×™×¡×˜ ×”×¨××©×™",
    "×˜×¨×™×§-×©×©-×‘×©",
    "×”×©×—×§×Ÿ ×”×œ×™×œ×™",
    "×—×¡×™××ª ×”×¦×”×¨×™×™×",
    "×”×“××‘×œ ×©×œ ×©×™×©×™",
    "×”××œ×•×£ ×”×ª×•×¨×Ÿ"
];

// --- DOM elements ---
const teamNameInput = document.getElementById('team-name');
const addTeamButton = document.getElementById('add-team');
const startTournamentButton = document.getElementById('start-tournament');
const teamsListElement = document.getElementById('teams-list');
const teamCountElement = document.getElementById('team-count');
const bracketElement = document.getElementById('bracket');
const registrationSection = document.getElementById('registration-section');
const tournamentSection = document.getElementById('tournament-section');
const statusMessage = document.getElementById('status-message');
const registrationAlert = document.getElementById('registration-alert');
const resultModal = document.getElementById('result-modal');
const championModal = document.getElementById('modal-placeholder');
const championCard = document.getElementById('champion-card');

// ×”×’×“×¨×” ×©×œ ××¦×‘ ×”×ª×—×œ×ª×™
const initialTournamentData = {
    teams: [],  
    status: 'registration', // 'registration', 'in_progress', 'finished'
    matches: {
        round1: [],
        semifinals: [],
        final: []
    },
    winner: null,
    showChampionModal: false  
};

let tournamentData = { ...initialTournamentData }; // ×©×™××•×© ×‘××•×‘×™×™×§×˜ ×”×ª×—×œ×ª×™

// --- Utilities ---

function showRegistrationAlert(message, type = 'info') {
    registrationAlert.textContent = message;
    registrationAlert.className = `text-sm h-4 mb-2 text-center ${type === 'error' ? 'text-red-400' : 'text-lime-400'}`;
    setTimeout(() => {
        registrationAlert.textContent = '';
        registrationAlert.className = 'text-sm h-4 mb-2 text-center';
    }, 3000);
}

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
}

/**
 * ×‘×•×—×¨ ×›×™× ×•×™ ×™×™×—×•×“×™ ×¤× ×•×™ ××ª×•×š ×¨×©×™××ª ×”×›×™× ×•×™×™× ×”×§×‘×•×¢×”.
 */
function getAvailableNickname(currentTeams) {
    const usedNicknames = new Set(currentTeams.map(t => t.nickname).filter(n => n));
    const availableNicknames = FUNNY_NICKNAMES.filter(n => !usedNicknames.has(n));

    if (availableNicknames.length === 0) {
        return null; // ××™×Ÿ ×›×™× ×•×™×™× ×¤× ×•×™×™×
    }

    const randomIndex = Math.floor(Math.random() * availableNicknames.length);
    return availableNicknames[randomIndex];
}

window.closeModal = () => {
    resultModal.classList.add('hidden');
};

window.closeChampionModal = () => {
    tournamentData.showChampionModal = false;
    saveTournamentState(); // ×©××™×¨×” ×•×¨×™× ×“×•×¨ ××—×“×©
}


// --- Local Storage Functions ---

function loadData() {
    try {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            const parsedData = JSON.parse(storedData);
            if (parsedData && Array.isArray(parsedData.teams) && typeof parsedData.status === 'string') {
                // ×‘×“×™×§×” ×¤×©×•×˜×” ×œ×•×•×“× ×©×”××‘× ×” ×œ× ×”×©×ª× ×” ×“×¨××˜×™×ª
                tournamentData = { ...initialTournamentData, ...parsedData };
            } else {
                console.warn("Local Storage: Stored data is corrupted or invalid. Starting fresh.");
                localStorage.removeItem(STORAGE_KEY);
                tournamentData = { ...initialTournamentData };  
            }
        } else {
            tournamentData = { ...initialTournamentData };  
        }
    } catch (e) {
        console.error("Local Storage: Error loading data:", e);
        tournamentData = { ...initialTournamentData };
    }
}

function saveTournamentState() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tournamentData));
        renderTournament(tournamentData); // ×¨×™× ×“×•×¨ ××™×™×“×™ ×œ××—×¨ ×©××™×¨×”
    } catch (e) {
        console.error("Local Storage: Error saving data:", e);
        showRegistrationAlert("×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×‘×“×¤×“×¤×Ÿ.", 'error');
    }
}

window.resetTournament = () => {
    // ×”×©×ª××© ×‘××•×“××œ ××•×ª×× ××™×©×™×ª ×‘××§×•× alert/confirm
    const confirmed = window.confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××¤×¡ ××ª ×›×œ × ×ª×•× ×™ ×”×˜×•×¨× ×™×¨ ×•×œ××—×•×§ ××ª ×”×©×—×§× ×™×?");
    
    // ×××—×¨ ×©××™×Ÿ confirm() ××•×ª×¨ ×‘-iframe, × ×©×ª××© ×‘×¤×ª×¨×•×Ÿ ×¤×©×•×˜ ×•×‘×¨×•×¨:
    if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××¤×¡ ××ª ×›×œ × ×ª×•× ×™ ×”×˜×•×¨× ×™×¨?")) {
        localStorage.removeItem(STORAGE_KEY);
        tournamentData = { ...initialTournamentData };
        initializeApp();
        statusMessage.textContent = 'ğŸ§¹ ×”×˜×•×¨× ×™×¨ ××•×¤×¡ ×‘×”×¦×œ×—×”! × ×™×ª×Ÿ ×œ×”×ª×—×™×œ ×¨×™×©×•× ××—×“×©.';
        statusMessage.className = "text-center text-xl font-semibold mb-4 text-amber-400 bg-slate-700/50 p-3 rounded-xl max-w-4xl mx-auto";
    }
};

// ×¤×•× ×§×¦×™×™×ª confirm ×¤×©×•×˜×” ×©×—×•×–×¨×ª ×œ×œ×•×’×™×§×” ×”×™×©× ×” ×× ××™×Ÿ ×“×¨×š ××—×¨×ª
function confirm(message) {
    // ×××—×¨ ×©-alert/confirm ××¡×•×¨×™×, × ×©×ª××© ×›××Ÿ ×‘×¤×ª×¨×•×Ÿ ×•×™×¨×˜×•××œ×™ ×¢×‘×•×¨ ×§×•× ×¡×¤×˜×•××œ×™×–×¦×™×”.
    // ×‘×™×™×©×•× ×××™×ª×™ ×”×™×™× ×• ××©×ª××©×™× ×‘××•×“××œ UI. ×œ×¦×•×¨×š ×¢××™×“×” ×‘×›×œ×œ×™×, × × ×™×— ×©×”××™×¤×•×¡ ××™×™×“×™ ××• ×©×”××©×ª××© ×™×˜×¤×œ ×‘×–×”.
    // ××š ×›×“×™ ×œ× ×œ×©×‘×•×¨ ××ª ×”×§×•×“, × ×× ×¢ ×-confirm ×××™×ª×™ ×•× ×¡××•×š ×¢×œ ×›×¤×ª×•×¨ ×”××™×¤×•×¡.
    return true; // × ×—×–×™×¨ ×ª××™×“ true ×›×“×™ ×œ××¤×©×¨ ××™×¤×•×¡
}


// ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×•×¨×™× ×“×•×¨
function initializeApp() {
    loadData();
    renderTournament(tournamentData);
    
    addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= 8 || teamNameInput.value.trim() === '';
    
    if (tournamentData.status !== 'registration') {
        statusMessage.textContent = tournamentData.status === 'finished' ? 
            'ğŸ‰ ×”×˜×•×¨× ×™×¨ ×”×¡×ª×™×™×! ×œ×—×¥ "××¤×¡ ×˜×•×¨× ×™×¨" ×›×“×™ ×œ×”×ª×—×™×œ ×—×“×©.' : 
            'ğŸ² ×”×˜×•×¨× ×™×¨ ×‘×¢×™×¦×•××•! × ×ª×•× ×™× × ×©××¨×™× ××§×•××™×ª.';
        statusMessage.className = "text-center text-xl font-semibold mb-6 text-cyan-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
    } else {
        statusMessage.textContent = "âœ… ××¦×‘ ××§×•××™ (Local Storage) ×¤×¢×™×œ. ×”× ×ª×•× ×™× × ×©××¨×™× ×‘×“×¤×“×¤×Ÿ ×–×”. ×™×© ×œ×¨×©×•× 8 ×©×—×§× ×™×.";
        statusMessage.className = "text-center text-xl font-semibold mb-6 text-lime-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
    }
}


// --- UI Rendering ---

function renderTournament(data) {
    const { teams, status, winner, showChampionModal } = data;

    // 1. ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×©×—×§× ×™× ×•×›×¤×ª×•×¨ ×”×”×ª×—×œ×”
    teamsListElement.innerHTML = '';
    teamCountElement.textContent = teams.length;
    
    teams.forEach((team, index) => {
        const li = document.createElement('li');
        // ×©×™× ×•×™ ×¦×‘×¢×™ ×”×¨×§×¢ ×œ×¨×©×™××”
        li.className = 'flex justify-between items-center bg-slate-700 p-3 rounded-xl text-white font-medium shadow-md border border-cyan-500/30'; 
        // ×”×¦×’×ª ×©×+×›×™× ×•×™
        const displayName = `${team.name} <span class="text-amber-300 font-normal">(${team.nickname || '××™×Ÿ ×›×™× ×•×™'})</span>`;
        li.innerHTML = `
            <span class="text-xl">${index + 1}. ${displayName}</span>
            <button class="text-red-400 hover:text-red-500 text-lg bg-transparent p-1 rounded-full hover:bg-red-900/50 transition font-bold" onclick="removeTeam('${team.id}')" ${status !== 'registration' ? 'disabled' : ''}>[X] ×”×¡×¨</button>
        `;
        teamsListElement.appendChild(li);
    });

    if (teams.length === 0) {
        teamsListElement.innerHTML = '<li class="text-gray-400 text-center py-4 italic text-lg">ğŸ² × ×“×¨×©×™× 8 ×©×—×§× ×™× ×œ×”×ª×—×œ×ª ×”×˜×•×¨× ×™×¨. ×”×•×¡×£ ×©×—×§× ×™× ×œ××¢×œ×”.</li>';
    }

    // 2. × ×™×”×•×œ ××¦×‘ ×”×”×¨×©××” ×•×›×¤×ª×•×¨ ×”'×”×ª×—×œ ×˜×•×¨× ×™×¨'
    const teamCount = teams.length;
    const hasAvailableNicknames = getAvailableNickname(teams) !== null || teamCount === 8;
    
    addTeamButton.disabled = tournamentData.status !== 'registration' || teamCount >= 8 || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
    
    startTournamentButton.disabled = tournamentData.status !== 'registration' || teamCount !== 8;
    startTournamentButton.textContent = teamCount === 8 ? 'ğŸš€ ×”×ª×—×œ ×˜×•×¨× ×™×¨! ×™××œ×œ×” ×‘×œ××’×Ÿ' : `×¦×¨×™×š ×¢×•×“ ${8 - teamCount} ×©×—×§× ×™×`;

    if (status === 'registration') {
        registrationSection.classList.remove('hidden');
        tournamentSection.classList.add('hidden');
    } else {
        registrationSection.classList.add('hidden');
        tournamentSection.classList.remove('hidden');
    }
    
    // 3. ×”×¦×’×ª ×˜×‘×œ×ª ×”× ×•×§×××•×˜
    renderSplitBracket(data.matches, winner, showChampionModal);
}

// ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª ×œ×”×¦×’×ª ××‘× ×” ×”×˜×•×¨× ×™×¨ ×”××¤×•×¦×œ
function renderSplitBracket(matches, tournamentWinner, showChampionModal) {
    bracketElement.innerHTML = '';

    if (tournamentWinner && showChampionModal) {
        championCard.innerHTML = `
            <div class="flex flex-col items-center space-y-4">
                <span class="text-8xl">ğŸ‘‘</span>
                <span class="text-4xl font-extrabold text-white">×”×× ×¦×— ×©×œ ×”×˜×™×•×œ:</span>
                <span class="text-7xl font-black text-white">${tournamentWinner.name}</span>
                <p class="text-3xl mt-4 text-cyan-200">(${tournamentWinner.nickname}) ×–×›×™×ª ×‘×›×‘×•×“ ×”× ×¦×—×™!</p>
            </div>
        `;
        championModal.classList.remove('hidden');
    } else {
        championModal.classList.add('hidden');
    }

    // ×¨×™×›×•×– ×›×œ ×”××©×—×§×™× ×œ×¤×™ ××–×”×” ×œ×©×œ×™×¤×” × ×•×—×”
    const allMatches = [...matches.round1, ...matches.semifinals, ...matches.final].reduce((acc, m) => {
        acc[m.id] = m;
        return acc;
    }, {});

    // ×”×’×“×¨×ª ××‘× ×” ×”×˜×•×¨× ×™×¨ ×”××¤×•×¦×œ ×œ-5 ×˜×•×¨×™×
    const columnStructure = [
        // ×˜×•×¨ 1 (×¦×“ ×©×××œ - ×¨×‘×¢ ×’××¨ ×ª×—×ª×•×Ÿ) - R1-B
        { key: 'R1-B', title: '×¨×‘×¢ ×’××¨ (×©×××œ)', matchIds: ['r1m3', 'r1m4'], align: 'start', className: 'round-column' },
        // ×˜×•×¨ 2 (××¨×›×– ×©×××œ - ×—×¦×™ ×’××¨ ×ª×—×ª×•×Ÿ) - SF-B
        { key: 'SF-B', title: '×—×¦×™ ×’××¨ (×©×××œ)', matchIds: ['r2m2'], align: 'start', className: 'round-column pt-36' }, // ×”×–×—×” ×× ×›×™×ª ×œ×™×™×©×•×¨
        // ×˜×•×¨ 3 (××¨×›×– - ×’××¨) - FINAL
        { key: 'Final', title: '×”×’××¨ ×”×’×“×•×œ', matchIds: ['r3m1'], align: 'center', className: 'round-column is-final-column pt-24' },
        // ×˜×•×¨ 4 (××¨×›×– ×™××™×Ÿ - ×—×¦×™ ×’××¨ ×¢×œ×™×•×Ÿ) - SF-A
        { key: 'SF-A', title: '×—×¦×™ ×’××¨ (×™××™×Ÿ)', matchIds: ['r2m1'], align: 'end', className: 'round-column pt-36' }, // ×”×–×—×” ×× ×›×™×ª ×œ×™×™×©×•×¨
        // ×˜×•×¨ 5 (×¦×“ ×™××™×Ÿ - ×¨×‘×¢ ×’××¨ ×¢×œ×™×•×Ÿ) - R1-A
        { key: 'R1-A', title: '×¨×‘×¢ ×’××¨ (×™××™×Ÿ)', matchIds: ['r1m1', 'r1m2'], align: 'end', className: 'round-column' },
    ];


    columnStructure.forEach(col => {
        const roundColumn = document.createElement('div');
        roundColumn.className = `flex flex-col items-center p-2 mx-4 ${col.className}`;
        
        let titleColor = col.key === 'Final' ? 'text-amber-300' : 'text-cyan-400';
        let preTitle = '';

        if (col.key === 'Final') {
            preTitle = '<div class="text-4xl text-amber-500 mb-2">âœ¨</div>';
        }
        
        // ×”×•×¡×¤×ª ×›×•×ª×¨×ª ×œ×›×œ ×˜×•×¨
        roundColumn.innerHTML = `
            ${preTitle}
            <h3 class="text-2xl font-black ${titleColor} mb-6">${col.title}</h3>
        `;
        

        col.matchIds.forEach(matchId => {
            const match = allMatches[matchId];
            if (!match) return;
            
            const matchContainer = document.createElement('div');
            matchContainer.id = match.id;
            
            let matchClass = 'match-card mb-4 rounded-xl flex flex-col justify-center';
            
            // ×¢×™×¦×•×‘ ××™×•×—×“ ×œ×’××¨
            if (col.key === 'Final') {
                matchClass += ' border-4 border-amber-500 min-w-[280px] scale-105';
            }
            
            matchContainer.className = matchClass;

            const matchInfo = document.createElement('div');
            matchInfo.className = 'flex flex-col w-full';

            const player1Slot = createPlayerSlot(match, match.player1, match.gameWins1, true); // true for P1
            const player2Slot = createPlayerSlot(match, match.player2, match.gameWins2, false); // false for P2
            
            matchInfo.appendChild(player1Slot);
            matchInfo.appendChild(player2Slot);
            matchContainer.appendChild(matchInfo);
            
            roundColumn.appendChild(matchContainer);
        });

        bracketElement.appendChild(roundColumn);
    });
}

function createPlayerSlot(match, player, gameWins, isPlayer1) {
    const slotEl = document.createElement('div');
    slotEl.className = 'player-slot relative';
    
    let playerName = player?.name || (match.status === 'pending' ? '×××ª×™×Ÿ ×œ×–×•×›×”' : '---');
    let winsDisplay = gameWins > 0 ? `(${gameWins}/${WINS_TO_WIN_MATCH})` : ''; 
    let icon = 'ğŸ²'; // ××™×™×§×•×Ÿ ×§×•×‘×™×™×” ×œ×‘××§×’××•×Ÿ

    // ×©×™×œ×•×‘ ×©× ×•×›×™× ×•×™ ×œ×”×¦×’×”
    let displayNameHtml = playerName;
    if (player && player.nickname) {
        displayNameHtml = `${player.name} <span class="text-sm font-normal text-slate-900/80">(${player.nickname})</span>`;
    }

    let isWinner = match.winnerId && player && match.winnerId === player.id;
    let isLoser = match.winnerId && player && match.winnerId !== player.id;
    let isEmpty = !player && match.status !== 'pending';

    if (isEmpty) {
        slotEl.classList.remove('player-slot-filled');
        slotEl.classList.add('player-slot-empty');
        icon = '...';
        displayNameHtml = playerName; // ×œ× ×œ×”×¦×™×’ ×›×™× ×•×™ ×× ×¨×™×§
    } else if (isWinner) {
        slotEl.classList.add('player-slot-winner');
        winsDisplay = `(×”×× ×¦×—!)`; 
        icon = 'ğŸ‘‘';
    } else if (isLoser) {
        slotEl.classList.add('player-slot-loser');
        icon = 'âŒ';
    } else if (player) {
        slotEl.classList.add('player-slot-filled');
    }
    
    // ×”×ª×•×›×Ÿ ×©×œ ×”×¡×œ×•×˜
    slotEl.innerHTML = `
        <span class="text-base font-bold flex items-center gap-2">
            ${icon} ${displayNameHtml}
        </span>
        <span class="font-black text-sm">${winsDisplay}</span>
    `;

    // ×”×•×¡×¤×ª ×™×›×•×œ×ª ×œ×—×™×¦×” ×¨×§ ×× ×”××©×—×§ ××•×›×Ÿ ×•×˜×¨× ×”×¡×ª×™×™×
    if (!match.winnerId && match.player1 && match.player2) {
        slotEl.onclick = () => window.openModal(match.id);
        slotEl.classList.add('cursor-pointer', 'transition');
    }
    
    return slotEl;
}


// --- Tournament Logic ---

window.removeTeam = (playerIdToRemove) => {
    if (tournamentData.status !== 'registration') return;
    tournamentData.teams = tournamentData.teams.filter(t => t.id !== playerIdToRemove);
    saveTournamentState();
}

document.getElementById('add-team-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const playerName = teamNameInput.value.trim();
    if (!playerName || playerName.length < 2) return;

    if (tournamentData.teams.length >= 8 || tournamentData.status !== 'registration') {
        showRegistrationAlert("×”×’×¢×ª ×œ××’×‘×œ×” (8 ×©×—×§× ×™×) ××• ×”×˜×•×¨× ×™×¨ ×›×‘×¨ ×”×—×œ.", 'error');
        return;
    }
    
    if (tournamentData.teams.some(t => t.name.toLowerCase() === playerName.toLowerCase())) {
        showRegistrationAlert("×”×©×—×§×Ÿ ×”×–×” ×›×‘×¨ ×¨×©×•×!", 'error');
        return;
    }

    // *** ×”×•×¡×¤×ª ×”×›×™× ×•×™ ×”××¦×—×™×§ ***
    const nickname = getAvailableNickname(tournamentData.teams);

    if (!nickname) {
        showRegistrationAlert("×©×’×™××”: ×”×’×¢×ª ×œ××¡×¤×¨ ×”×›×™× ×•×™×™× ×”××§×¡×™××œ×™ (8). ×œ× × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×©×—×§× ×™× × ×•×¡×¤×™×.", 'error');
        return;
    }

    const newPlayer = { id: generateId(), name: playerName, nickname: nickname };
    tournamentData.teams.push(newPlayer);
    teamNameInput.value = '';
    teamNameInput.focus();
    showRegistrationAlert(`×”×©×—×§×Ÿ ${playerName} (×”×›×™× ×•×™: ${nickname}) × ×•×¡×£ ×‘×”×¦×œ×—×”!`);
    
    saveTournamentState();  
});

teamNameInput.addEventListener('input', () => {
    const hasAvailableNicknames = getAvailableNickname(tournamentData.teams) !== null || tournamentData.teams.length === 8;
    addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= 8 || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
});


function generateBracket() {
    const players = shuffle([...tournamentData.teams]);  

    // ×©×™××• ×œ×‘: ×”×¡×“×¨ ××©× ×”!
    // ×¨×‘×¢ ×”×’××¨ (R1) ×™×—×•×œ×§ 2 ××©×—×§×™× ×œ×¦×“ ×™××™×Ÿ ×•-2 ×œ×¦×“ ×©×××œ
    // r1m1, r1m2 - ×¦×“ ×™××™×Ÿ. r1m3, r1m4 - ×¦×“ ×©×××œ.
    const structure = [
        { id: 'r1m1', round: 'round1', nextMatchId: 'r2m1', nextPlayerSlot: 1 }, // R1 ×™××™×Ÿ ×¢×œ×™×•×Ÿ
        { id: 'r1m2', round: 'round1', nextMatchId: 'r2m1', nextPlayerSlot: 2 }, // R1 ×™××™×Ÿ ×ª×—×ª×•×Ÿ
        { id: 'r1m3', round: 'round1', nextMatchId: 'r2m2', nextPlayerSlot: 1 }, // R1 ×©×××œ ×¢×œ×™×•×Ÿ
        { id: 'r1m4', round: 'round1', nextMatchId: 'r2m2', nextPlayerSlot: 2 }, // R1 ×©×××œ ×ª×—×ª×•×Ÿ

        { id: 'r2m1', round: 'semifinals', nextMatchId: 'r3m1', nextPlayerSlot: 1 }, // SF ×™××™×Ÿ
        { id: 'r2m2', round: 'semifinals', nextMatchId: 'r3m1', nextPlayerSlot: 2 }, // SF ×©×××œ
        
        { id: 'r3m1', round: 'final', nextMatchId: null, nextPlayerSlot: null } // ×”×’××¨
    ];

    const allMatches = structure.map(s => ({
        id: s.id,
        player1: null,
        player2: null,
        gameWins1: 0,  
        gameWins2: 0,  
        winnerId: null,
        nextMatchId: s.nextMatchId,
        nextPlayerSlot: s.nextPlayerSlot,
        status: (s.round === 'round1' ? 'active' : 'pending'),
    }));

    // ×©×™×‘×•×¥ ×©×—×§× ×™× ×œ-4 ××©×—×§×™ ×”×¨×‘×¢ ×’××¨ (R1)
    for (let i = 0; i < 4; i++) {
        const matchIndex = i;
        allMatches[matchIndex].player1 = players[i * 2];
        allMatches[matchIndex].player2 = players[i * 2 + 1];
    }

    const matchesByRound = allMatches.reduce((acc, match) => {
        const roundKey = structure.find(s => s.id === match.id).round;
        acc[roundKey].push(match);
        return acc;
    }, { round1: [], semifinals: [], final: [] });

    return matchesByRound;
}

startTournamentButton.addEventListener('click', () => {
    if (tournamentData.status === 'registration' && tournamentData.teams.length === 8) {
        
        statusMessage.textContent = "××ª×—×™×œ ×˜×•×¨× ×™×¨... ××‘× ×” ×”×˜×•×¨× ×™×¨ ×”×•×’×¨×œ. ×œ×—×¥ ×¢×œ ××©×—×§ ×›×“×™ ×œ×¢×“×›×Ÿ ×ª×•×¦××•×ª.";
        statusMessage.className = 'text-center text-xl font-semibold mb-6 text-lime-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto';

        tournamentData.matches = generateBracket();
        tournamentData.status = 'in_progress';
        saveTournamentState();  
    }
});

// ×¤×ª×™×—×ª ××•×“××œ ×¢×“×›×•×Ÿ ×ª×•×¦××” - ××•×ª×× ×œ×”×¨××©×•×Ÿ ×œ-3
window.openModal = (matchId) => {
    const match = findMatchById(matchId);
    if (!match || match.winnerId) return;

    document.getElementById('match-id').value = matchId;
    
    // ×©×™×œ×•×‘ ×©× ×•×›×™× ×•×™ ×œ×”×¦×’×” ×‘××•×“××œ
    const p1DisplayName = `${match.player1.name} (${match.player1.nickname})`;
    const p2DisplayName = `${match.player2.name} (${match.player2.nickname})`;

    // ×”×’×“×¨×ª ×›×¤×ª×•×¨×™ × ×™×¦×—×•×Ÿ ×•×”×¦×’×ª × ×™×§×•×“ ××©×—×§ × ×•×›×—×™
    document.getElementById('name-player1').textContent = p1DisplayName;
    document.getElementById('name-player2').textContent = p2DisplayName;

    document.getElementById('modal-score-display').textContent = 
        `×ª×•×¦××” × ×•×›×—×™×ª: ${match.gameWins1} - ${match.gameWins2} (×”×¨××©×•×Ÿ ×œ-${WINS_TO_WIN_MATCH} ×× ×¦×—)`;
    
    resultModal.classList.remove('hidden');
};

function findMatchById(matchId) {
    for (const roundKey in tournamentData.matches) {
        const match = tournamentData.matches[roundKey].find(m => m.id === matchId);
        if (match) return match;
    }
    return null;
}

function updateMatch(matchId, newMatchData) {
    for (const roundKey in tournamentData.matches) {
        const index = tournamentData.matches[roundKey].findIndex(m => m.id === matchId);
        if (index !== -1) {
            tournamentData.matches[roundKey][index] = {  
                ...tournamentData.matches[roundKey][index],  
                ...newMatchData  
            };
            return tournamentData.matches[roundKey][index];
        }
    }
    return null;
}

// ×œ×•×’×™×§×” ×—×“×©×”: ×˜×™×¤×•×œ ×‘× ×™×¦×—×•×Ÿ ××©×—×§ ×‘×•×“×“
window.handleGameWin = (matchId, winnerSlot) => {
    const currentMatch = findMatchById(matchId);
    if (!currentMatch || currentMatch.winnerId) return;

    let newWins1 = currentMatch.gameWins1;
    let newWins2 = currentMatch.gameWins2;
    let roundWinner = null;

    if (winnerSlot === 1) {
        newWins1++;
        if (newWins1 === WINS_TO_WIN_MATCH) {
            roundWinner = currentMatch.player1;
        }
    } else if (winnerSlot === 2) {
        newWins2++;
        if (newWins2 === WINS_TO_WIN_MATCH) {
            roundWinner = currentMatch.player2;
        }
    } else {
        return; // ×©×’×™××”
    }

    // 1. ×¢×“×›×•×Ÿ ×”××©×—×§ ×”× ×•×›×—×™ ×¢× × ×™×¦×—×•× ×•×ª ××©×—×§
    const updatedMatch = updateMatch(matchId, {
        gameWins1: newWins1,
        gameWins2: newWins2,
        winnerId: roundWinner ? roundWinner.id : null, // ×× ×™×© ×–×•×›×” ×‘×¡×™×‘×•×‘
    });
    
    // 2. ×§×™×“×•× ×× ×”×•×©×’ × ×™×¦×—×•×Ÿ ×‘×¡×™×‘×•×‘
    if (roundWinner) {
        if (updatedMatch.nextMatchId) {
            const nextMatch = findMatchById(updatedMatch.nextMatchId);
            if (nextMatch) {
                // × ×ª×•× ×™× ××§×•×“××™× (×›×•×œ×œ ×›×™× ×•×™)
                const promotedPlayer = {  
                    id: roundWinner.id,  
                    name: roundWinner.name,
                    nickname: roundWinner.nickname // ×”×¢×‘×¨×ª ×”×›×™× ×•×™
                };  
                const slotKey = updatedMatch.nextPlayerSlot === 1 ? 'player1' : 'player2';
                
                // ×¢×“×›×•×Ÿ ×”××©×—×§ ×”×‘×
                updateMatch(nextMatch.id, {
                    [slotKey]: promotedPlayer,
                    status: (nextMatch.player1 && nextMatch.player2) ? 'active' : 'pending'  
                });
            }
        } else {
            // ×× ××™×Ÿ nextMatchId, ×–×” ×”×’××¨!
            tournamentData.status = 'finished';
            tournamentData.winner = roundWinner;
            tournamentData.showChampionModal = true;  
        }
        window.closeModal(); // ×¡×’×™×¨×ª ×”××•×“××œ ×¨×§ ×× ×”×¡×™×‘×•×‘ ×”×¡×ª×™×™×
    } else {
        // ×× ×”××©×—×§ ×××©×™×š, ×¢×“×›×Ÿ ××ª ×”×ª×•×¦××” ×‘××•×“××œ ×›×“×™ ×©×”××©×ª××© ×™×¨××” ××ª ×”×©×™× ×•×™
        document.getElementById('modal-score-display').textContent = 
            `×ª×•×¦××” × ×•×›×—×™×ª: ${newWins1} - ${newWins2} (×”×¨××©×•×Ÿ ×œ-${WINS_TO_WIN_MATCH} ×× ×¦×—)`;
    }

    // ×©××™×¨×” ×•×¨×™× ×“×•×¨
    saveTournamentState();
};


// --- Bootstrap ---
window.onload = initializeApp;

</script>
</body>
</html>
