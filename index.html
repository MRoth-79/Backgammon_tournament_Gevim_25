<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>טורניר נוקאאוט לטיול גברים</title>
    <!-- טעינת Tailwind CSS דרך CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* הגדרות גובה בסיסיות לישור המשחקים */
        .match-card {
            width: 200px; /* רוחב קבוע לכרטיס המשחק */
            height: 80px; /* גובה h-20 */
            margin-bottom: 16px; /* מרווח mb-4 */
            box-sizing: border-box; /* חשוב לשמירת הרוחב */
            /* שינוי: רקע כחול עמוק, בורדר תכלת זוהר */
            background-color: #0c4a6e; /* dark cyan/blue */
            border: 3px solid #38bdf8; /* border-sky-400 */
            box-shadow: 0 4px 10px rgba(56, 189, 248, 0.4); /* Cyan shadow */
            padding: 4px;
        }

        .player-slot {
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 6px;
            background-color: #f3f4f6; /* bg-gray-100 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #1f2937; /* text-gray-800 */
            line-height: 1.25;
            min-height: 34px;
        }

        .player-slot-filled:hover {
            background-color: #d1d5db; /* bg-gray-300 */
        }
        
        .player-slot-winner {
            background-color: #34d399; /* bg-emerald-400 */
            color: #1f2937;
            font-weight: 700;
        }

        .player-slot-loser {
            background-color: #dc2626; /* bg-red-600 */
            color: #f3f4f6;
            opacity: 0.5;
        }

        /* שינוי: רקע תכלת לריקים */
        .player-slot-empty {
            background-color: #0e7490; /* bg-cyan-700 equivalent */
            color: #bae6fd; /* text-sky-200 equivalent */
            border: 1px dashed #67e8f9; /* border-cyan-300 equivalent */
        }

        .final-match {
            width: 250px; /* גמר קצת יותר רחב */
            border-width: 4px;
            border-color: #f59e0b; /* border-amber-500 */
            transform: scale(1.05); /* קצת יותר גדול */
        }
        
        /* התאמה למובייל */
        @media (max-width: 1024px) {
            .bracket-container {
                overflow-x: auto;
                justify-content: flex-start;
            }
            .round-column, .is-final-column {
                min-width: 240px;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 md:p-8 font-sans">
    
    <header class="text-center mb-10">
        <h1 class="text-5xl font-extrabold text-cyan-400 tracking-wider">🍻 טורניר הטיול הגדול 2025 🏆</h1>
        <p class="text-xl text-gray-400 mt-2">מערכת ניהול נוקאאוט ל-16 לוחמים</p>
    </header>

    <!-- הודעת סטטוס גלובלית -->
    <div id="status-message" class="text-center text-xl font-semibold mb-6 text-lime-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto transition">
        טוען נתונים...
    </div>

    <!-- סקציית רישום שחקנים (מוצגת רק ברישום) -->
    <section id="registration-section" class="max-w-4xl mx-auto p-6 bg-slate-800 rounded-2xl shadow-xl border-t-4 border-cyan-500/50">
        <h2 class="text-3xl font-bold mb-4 text-cyan-400">רישום שחקנים (<span id="team-count">0</span>/<span id="max-players-display">16</span>)</h2>
        
        <form id="add-team-form" class="flex space-x-2 space-x-reverse mb-6">
            <input type="text" id="team-name-input" placeholder="שם שחקן מלא (חובה)" required class="flex-1 p-3 rounded-xl bg-slate-700 text-white border-2 border-slate-600 focus:border-amber-400 focus:outline-none placeholder:text-gray-400 transition" />
            <button type="submit" id="add-team-button" disabled class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed">
                ➕ הוסף שחקן
            </button>
        </form>

        <ul id="teams-list" class="space-y-3 mb-6">
            <!-- רשימת השחקנים תירנדר כאן -->
        </ul>
        
        <div class="flex justify-between items-center pt-4 border-t border-slate-700">
            <button id="start-tournament" disabled class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-black py-4 px-8 rounded-xl shadow-2xl text-xl transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                🚀 התחל טורניר! יאללה בלאגן
            </button>
            <button onclick="resetTournament()" class="bg-red-700 hover:bg-red-800 text-white font-medium py-2 px-4 rounded-xl transition">
                🗑️ אפס טורניר
            </button>
        </div>
    </section>

    <!-- סקציית הטורניר (מוצגת רק לאחר התחלה) -->
    <section id="tournament-section" class="hidden mt-10 p-6 bg-slate-800 rounded-2xl shadow-2xl border-t-4 border-amber-500 max-w-full overflow-x-auto">
        
        <!-- כותרת וכפתור איפוס/חזרה מכל שלב -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold text-amber-400">מבנה הנוקאאוט</h2>
            <button onclick="resetTournament()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-150">
                🔄 חזרה לרישום / איפוס מלא
            </button>
        </div>
        
        <!-- מיכל הטורניר - Flexbox לטורים צמודים (שינוי: items-start ו-py-8) -->
        <div id="bracket-container" class="flex items-start py-8 bracket-container">
            <!-- טורי המשחקים יירנדרו כאן -->
        </div>
    </section>


    <!-- Modal לרישום תוצאות (החלון הקופץ המותאם אישית) -->
    <div id="result-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-slate-700 rounded-xl p-8 w-full max-w-lg shadow-2xl border-t-4 border-cyan-400">
            <h3 id="modal-match-title" class="text-3xl font-black mb-6 text-center text-cyan-400">עדכון תוצאה - שמינית גמר</h3>
            <div id="modal-match-players" class="space-y-4">
                <!-- נתוני המשחק יטענו כאן -->
            </div>
            <div id="modal-winner-select" class="mt-8 text-center">
                <p class="text-lg text-gray-300 mb-4">בחר את המנצח של המשחק (הראשון ל-<span id="modal-wins-to-win"></span>)</p>
                <div id="modal-win-buttons" class="flex justify-center space-x-4 space-x-reverse">
                    <!-- כפתורים לניצחון בסיבוב יטענו כאן -->
                </div>
            </div>
            <div id="modal-error-message" class="text-red-400 mt-4 text-center hidden"></div>

            <div class="mt-8 text-center">
                <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-xl transition">סגור</button>
            </div>
        </div>
    </div>
    
    <!-- Modal למנצח הטורניר -->
    <div id="champion-modal" class="hidden fixed inset-0 z-50 bg-indigo-900 bg-opacity-95 flex items-center justify-center p-4 transition-opacity">
        <div id="champion-card" class="bg-indigo-700 rounded-3xl p-12 w-full max-w-2xl shadow-[0_0_50px_rgba(165,180,252,0.8)] border-4 border-amber-400 text-center">
            <!-- נתוני המנצח יטענו כאן -->
        </div>
        <button onclick="window.closeChampionModal()" class="absolute top-4 right-4 text-white text-5xl opacity-80 hover:opacity-100 transition">&times;</button>
    </div>


<script>
// --- Constants and Global Variables ---
const STORAGE_KEY = 'mensTripTournamentData2025';
const MAX_PLAYERS = 16;
const WINS_TO_WIN_MATCH = 3; // הטוב מ-5 משחקי שש-בש / פוקר / אחר
const MATCH_HEIGHT_UNIT = 96; // 80px (h-20) + 16px (mb-4) for vertical alignment

// Helper for unique IDs (simple UUID-like)
const generateId = () => Math.random().toString(36).substring(2, 9);

// Mock data initialization
const initialTournamentData = {
    teams: [],
    status: 'registration', // 'registration', 'in_progress', 'finished'
    matches: {
        roundOf16: [], quarterfinals: [], semifinals: [], final: []
    },
    winner: null,
    showChampionModal: false
};

let tournamentData = { ...initialTournamentData };

// Element references (MUST MATCH HTML IDs)
const teamNameInput = document.getElementById('team-name-input');
const addTeamButton = document.getElementById('add-team-button');
const teamsListElement = document.getElementById('teams-list');
const teamCountElement = document.getElementById('team-count');
const startTournamentButton = document.getElementById('start-tournament');
const statusMessage = document.getElementById('status-message');
const registrationSection = document.getElementById('registration-section');
const tournamentSection = document.getElementById('tournament-section');
const bracketElement = document.getElementById('bracket-container');
const resultModal = document.getElementById('result-modal');
const championModal = document.getElementById('champion-modal');
const championCard = document.getElementById('champion-card');
document.getElementById('max-players-display').textContent = MAX_PLAYERS;
document.getElementById('modal-wins-to-win').textContent = WINS_TO_WIN_MATCH;


// --- Helper Functions ---

/**
 * פונקציה ליצירת כינויים ייחודיים ומצחיקים
 */
const NICKNAMES = [
    "המלך הבלתי מעורער", "הנוגס האלגנטי", "קוביות העיוורות", "שחקן הטיול",
    "הדאבל האולטימטיבי", "הצב הצולע", "הכי פחות גרוע", "ההייזנברג",
    "הדחפור", "נועם הבוגד", "הצ'יפמנק", "יונתן הטיגריס",
    "הנמר הזקן", "האלוף בהמתנה", "אביתר הבכיין", "הקילר השקט"
];

function getAvailableNickname(usedTeams) {
    const usedNicknames = new Set(usedTeams.map(t => t.nickname));
    return NICKNAMES.find(nick => !usedNicknames.has(nick)) || null;
}

/**
 * פונקציה לערבוב מערך (אלגוריתם Fisher-Yates)
 */
function shuffle(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
    }
    return array;
}

/**
 * פונקציה לשליפת משחק לפי ID מתוך כל הסיבובים
 */
function getMatchById(matchId) {
    const { roundOf16, quarterfinals, semifinals, final } = tournamentData.matches;
    const allMatches = [...roundOf16, ...quarterfinals, ...semifinals, ...final];
    return allMatches.find(m => m.id === matchId);
}

/**
 * פונקציה להצגת הודעות סטטוס קצרות (מחליף alert)
 */
function showRegistrationAlert(message, type = 'success') {
    console.log(`Alert (${type}): ${message}`);
    const color = type === 'error' ? 'text-red-400' : 'text-lime-400';
    statusMessage.textContent = message;
    statusMessage.className = `text-center text-xl font-semibold mb-6 ${color} bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto transition`;
}


// --- Modal Handling ---

window.openModal = (matchId) => {
    const match = getMatchById(matchId);
    if (!match || match.winnerId || !match.player1 || !match.player2) return;

    // כותרת המודאל
    let roundTitle = '';
    if (matchId.startsWith('r1')) roundTitle = 'שמינית גמר';
    else if (matchId.startsWith('r2')) roundTitle = 'רבע גמר';
    else if (matchId.startsWith('r3')) roundTitle = 'חצי גמר';
    else if (matchId.startsWith('r4')) roundTitle = 'הגמר הגדול';
    
    document.getElementById('modal-match-title').textContent = `עדכון תוצאה - ${roundTitle}`;
    
    // נתוני השחקנים והתוצאה הנוכחית
    const modalPlayersEl = document.getElementById('modal-match-players');
    modalPlayersEl.innerHTML = `
        <div class="flex justify-between items-center text-xl font-bold p-3 rounded-lg bg-slate-800 border-b border-cyan-500">
            <span class="text-white">${match.player1.nickname || match.player1.name}</span>
            <span class="text-amber-400">${match.gameWins1} - ${match.gameWins2}</span>
            <span class="text-white">${match.player2.nickname || match.player2.name}</span>
        </div>
    `;

    // כפתורי הניצחון
    const modalWinButtonsEl = document.getElementById('modal-win-buttons');
    modalWinButtonsEl.innerHTML = `
        <button onclick="window.handleGameWin('${matchId}', 1)" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105">
            🏆 ניצחון ל-${match.player1.nickname || match.player1.name}
        </button>
        <button onclick="window.handleGameWin('${matchId}', 2)" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105">
            🏆 ניצחון ל-${match.player2.nickname || match.player2.name}
        </button>
    `;

    resultModal.classList.remove('hidden');
}

window.closeModal = () => {
    resultModal.classList.add('hidden');
}

window.closeChampionModal = () => {
    tournamentData.showChampionModal = false;
    saveTournamentState();
}


// --- State Management (using Local Storage as provided) ---

function loadData() {
    try {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            tournamentData = JSON.parse(storedData);
        } else {
            tournamentData = { ...initialTournamentData };
        }
    } catch (e) {
        console.error("Local Storage: Error loading data:", e);
        tournamentData = { ...initialTournamentData };
    }
}

function saveTournamentState() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tournamentData));
        renderTournament(tournamentData); // רינדור מיידי לאחר שמירה
    } catch (e) {
        console.error("Local Storage: Error saving data:", e);
        showRegistrationAlert("שגיאה: לא ניתן לשמור את הנתונים בדפדפן.", 'error');
    }
}

// הפונקציה המבצעת איפוס מלא
window.resetTournament = () => {
    localStorage.removeItem(STORAGE_KEY);
    tournamentData = { ...initialTournamentData };
    initializeApp();
    statusMessage.textContent = '🧹 הטורניר אופס בהצלחה! ניתן להתחיל רישום מחדש.';
    statusMessage.className = "text-center text-xl font-semibold mb-4 text-amber-400 bg-slate-700/50 p-3 rounded-xl max-w-4xl mx-auto";
};

function initializeApp() {
    loadData();
    renderTournament(tournamentData);
    
    if (tournamentData.status !== 'registration') {
        statusMessage.textContent = tournamentData.status === 'finished' ? 
            '🎉 הטורניר הסתיים! לחץ "חזרה לרישום / איפוס מלא" כדי להתחיל חדש.' : 
            '🎲 הטורניר בעיצומו! נתונים נשמרים מקומית.';
        statusMessage.className = "text-center text-xl font-semibold mb-6 text-cyan-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
    } else {
        statusMessage.textContent = `✅ מצב מקומי (Local Storage) פעיל. הנתונים נשמרים בדפדפן זה. נדרשים ${MAX_PLAYERS} שחקנים, אך ניתן להתחיל עם 2 ומעלה (השלמה אוטומטית).`;
        statusMessage.className = "text-center text-xl font-semibold mb-6 text-lime-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
    }
}


// --- UI Rendering ---

function renderTournament(data) {
    const { teams, status, winner, showChampionModal } = data;

    // 1. עדכון רשימת השחקנים וכפתור ההתחלה
    teamsListElement.innerHTML = '';
    teamCountElement.textContent = teams.length;
    
    teams.forEach((team, index) => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center bg-slate-700 p-3 rounded-xl text-white font-medium shadow-md border border-cyan-500/30'; 
        // הצגת הכינוי כשם הראשי והשם המקורי בסוגריים
        const displayName = `${team.nickname || 'אין כינוי'} <span class="text-amber-300 font-normal">(${team.name})</span>`;
        li.innerHTML = `
            <span class="text-xl">${index + 1}. <span class="truncate">${displayName}</span></span>
            <button class="text-red-400 hover:text-red-500 text-lg bg-transparent p-1 rounded-full hover:bg-red-900/50 transition font-bold" onclick="removeTeam('${team.id}')" ${status !== 'registration' ? 'disabled' : ''}>[X] הסר</button>
        `;
        teamsListElement.appendChild(li);
    });

    if (teams.length === 0) {
        teamsListElement.innerHTML = `<li class="text-gray-400 text-center py-4 italic text-lg">🎲 נדרשים ${MAX_PLAYERS} שחקנים להתחלת הטורניר. הוסף שחקנים למעלה.</li>`;
    }

    // 2. ניהול מצב ההרשמה וכפתור ה'התחל טורניר'
    const teamCount = teams.length;
    const hasAvailableNicknames = getAvailableNickname(teams) !== null || teamCount === MAX_PLAYERS;
    
    addTeamButton.disabled = tournamentData.status !== 'registration' || teamCount >= MAX_PLAYERS || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
    
    // שינוי: מאפשר להתחיל עם 2 שחקנים ומעלה
    startTournamentButton.disabled = tournamentData.status !== 'registration' || teamCount < 2;
    if (teamCount >= 2 && teamCount < MAX_PLAYERS) {
        startTournamentButton.textContent = `🚀 התחל! (יושלם אוטומטית ל-${MAX_PLAYERS})`;
    } else if (teamCount === MAX_PLAYERS) {
        startTournamentButton.textContent = '🚀 התחל טורניר! יאללה בלאגן';
    } else {
        startTournamentButton.textContent = `צריך לפחות 2 שחקנים (${MAX_PLAYERS - teamCount} חסרים)`;
    }


    if (status === 'registration') {
        registrationSection.classList.remove('hidden');
        tournamentSection.classList.add('hidden');
    } else {
        registrationSection.classList.add('hidden');
        tournamentSection.classList.remove('hidden');
    }
    
    // 3. הצגת טבלת הנוקאאוט
    if (status !== 'registration') {
        renderSplitBracket(data.matches, winner, showChampionModal);
    }
}

// פונקציה מעודכנת להצגת מבנה הטורניר המפוצל ל-16 שחקנים עם יישור עליון
function renderSplitBracket(matches, tournamentWinner, showChampionModal) {
    bracketElement.innerHTML = '';

    if (tournamentWinner && showChampionModal) {
        championCard.innerHTML = `
            <div class="flex flex-col items-center space-y-4">
                <span class="text-8xl">👑</span>
                <span class="text-4xl font-extrabold text-white">המנצח של הטיול:</span>
                <span class="text-7xl font-black text-amber-300">${tournamentWinner.nickname || tournamentWinner.name}</span>
                <p class="text-3xl mt-4 text-cyan-200">(${tournamentWinner.name}) זכית בכבוד הנצחי!</p>
            </div>
            <div class="mt-8">
                   <button onclick="window.closeChampionModal()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl transition">סגור</button>
            </div>
        `;
        championModal.classList.remove('hidden');
    } else {
        championModal.classList.add('hidden');
    }

    // ריכוז כל המשחקים לפי מזהה לשליפה נוחה
    const allMatches = [...matches.roundOf16, ...matches.quarterfinals, ...matches.semifinals, ...matches.final].reduce((acc, m) => {
        acc[m.id] = m;
        return acc;
    }, {});

    // הגדרת מבנה הטורניר המפוצל ל-7 טורים
    const H = MATCH_HEIGHT_UNIT; // 96px (Match Card height + margin-bottom)

    // שינוי: התאמת הרווחים ליישור עליון (הזזה של SF ו-Final למעלה)
    const R16_Spacers = [H * 0.5, H, H, H]; // שומר על יחס המרחקים הפנימי
    const QF_Spacers = [H * 1.5, H * 3.0]; // שומר על יחס המרחקים הפנימי
    const SF_Spacers = [H * 1.5]; // היה 3.5H - הוזז למעלה
    const Final_Spacers = [H * 1.5]; // היה 3.5H - הוזז למעלה


    const columnStructure = [
        // 1. שמינית גמר - ימין (R16_R) - 4 משחקים (1, 2, 3, 4)
        { key: 'R16_R', title: 'שמינית גמר', matchIds: ['r1m1', 'r1m2', 'r1m3', 'r1m4'], spacerHeights: R16_Spacers, titleColor: 'text-cyan-400' },
        
        // 2. רבע גמר - ימין (QF_R) - 2 משחקים (1, 2)
        { key: 'QF_R', title: 'רבע גמר', matchIds: ['r2m1', 'r2m2'], spacerHeights: QF_Spacers, titleColor: 'text-cyan-400' },
        
        // 3. חצי גמר - ימין (SF_R) - 1 משחק (1)
        { key: 'SF_R', title: 'חצי גמר', matchIds: ['r3m1'], spacerHeights: SF_Spacers, titleColor: 'text-cyan-400' },
        
        // 4. גמר (Final) - 1 משחק - מרכז (גדול יותר)
        { key: 'Final', title: 'הגמר הגדול', matchIds: ['r4m1'], spacerHeights: Final_Spacers, isFinal: true, titleColor: 'text-amber-300' },
        
        // 5. חצי גמר - שמאל (SF_L) - 1 משחק (2)
        { key: 'SF_L', title: 'חצי גמר', matchIds: ['r3m2'], spacerHeights: SF_Spacers, titleColor: 'text-cyan-400' },
        
        // 6. רבע גמר - שמאל (QF_L) - 2 משחקים (3, 4)
        { key: 'QF_L', title: 'רבע גמר', matchIds: ['r2m3', 'r2m4'], spacerHeights: QF_Spacers, titleColor: 'text-cyan-400' },
        
        // 7. שמינית גמר - שמאל (R16_L) - 4 משחקים (5, 6, 7, 8)
        { key: 'R16_L', title: 'שמינית גמר', matchIds: ['r1m5', 'r1m6', 'r1m7', 'r1m8'], spacerHeights: R16_Spacers, titleColor: 'text-cyan-400' },
    ];


    columnStructure.forEach(col => {
        const roundColumn = document.createElement('div');
        roundColumn.className = `flex flex-col items-center p-2 mx-2 ${col.isFinal ? 'is-final-column' : 'round-column'}`;
        
        let preTitle = '';

        if (col.isFinal) {
            // שינוי הכוכב לגביע
            preTitle = '<div class="text-4xl text-amber-500 mb-2">🏆</div>'; 
        }
        
        // הוספת כותרת לכל טור
        roundColumn.innerHTML += `
            ${preTitle}
            <h3 class="text-2xl font-black ${col.titleColor} mb-6 text-center">${col.title}</h3>
        `;
        
        let spacerIndex = 0;

        col.matchIds.forEach((matchId) => {
            const match = allMatches[matchId];
            if (!match) return;
            
            // הוספת רווח לפני המשחק
            if (col.spacerHeights[spacerIndex] !== undefined) {
                const spacerHeight = col.spacerHeights[spacerIndex];
                const spacer = document.createElement('div');
                spacer.style.height = `${spacerHeight}px`;
                spacer.className = `w-full`;
                roundColumn.appendChild(spacer);
                spacerIndex++;
            }

            const matchContainer = document.createElement('div');
            matchContainer.id = match.id;
            
            let matchClass = 'match-card rounded-xl flex flex-col justify-center';
            
            // עיצוב מיוחד לגמר (הפיכה לגדול יותר)
            if (matchId === 'r4m1') {
                matchClass += ' final-match'; 
            }
            
            matchContainer.className = matchClass;

            const matchInfo = document.createElement('div');
            matchInfo.className = 'flex flex-col w-full';

            // שימוש בפונקציה createPlayerSlot המוגדרת
            const player1Slot = createPlayerSlot(match, match.player1, match.gameWins1, true); // true for P1
            const player2Slot = createPlayerSlot(match, match.player2, match.gameWins2, false); // false for P2
            
            matchInfo.appendChild(player1Slot);
            matchInfo.appendChild(player2Slot);
            matchContainer.appendChild(matchInfo);
            
            roundColumn.appendChild(matchContainer);
        });

        bracketElement.appendChild(roundColumn);
    });
}

function createPlayerSlot(match, player, gameWins, isPlayer1) {
    const slotEl = document.createElement('div');
    slotEl.className = 'player-slot relative';
    
    // הצגת השם הראשי (כינוי אם קיים)
    let playerName = player?.nickname || player?.name || (match.status === 'pending' ? 'ממתין לזוכה' : '---');
    let winsDisplay = gameWins > 0 ? `(${gameWins}/${WINS_TO_WIN_MATCH})` : ''; 
    let icon = '🎯'; // שינוי אייקון כללי לטורניר

    // שילוב שם וכינוי להצגה - עכשיו הכינוי הוא הראשי
    let displayNameHtml = playerName;
    if (player && player.nickname && player.name) {
        // הצגת הכינוי כשם הראשי והשם המקורי בסוגריים
        const nameColor = match.winnerId ? 'text-gray-900/80' : 'text-slate-900/80';
        displayNameHtml = `${player.nickname} <span class="text-sm font-normal ${nameColor}">(${player.name})</span>`;
    } else if (player && player.name) {
          displayNameHtml = player.name;
    }


    let isWinner = match.winnerId && player && match.winnerId === player.id;
    let isLoser = match.winnerId && player && match.winnerId !== player.id;
    let isEmpty = !player && match.status !== 'pending';

    if (isEmpty) {
        slotEl.classList.remove('player-slot-filled');
        slotEl.classList.add('player-slot-empty');
        icon = '...';
        displayNameHtml = playerName; // לא להציג סוגריים אם ריק
    } else if (isWinner) {
        slotEl.classList.add('player-slot-winner');
        winsDisplay = `(המנצח!)`; 
        icon = '👑';
        // בעת ניצחון, מוודאים שהכינוי מוצג בצורה ברורה
        displayNameHtml = player.nickname || player.name;
        if (player.nickname && player.name) {
             displayNameHtml = `${player.nickname} <span class="text-sm font-normal text-gray-900/80">(${player.name})</span>`;
        }
    } else if (isLoser) {
        slotEl.classList.add('player-slot-loser');
        icon = '❌';
    } else if (player) {
        slotEl.classList.add('player-slot-filled');
    }
    
    // התוכן של הסלוט
    slotEl.innerHTML = `
        <span class="text-base font-bold flex items-center gap-2">
            ${icon} <span class="truncate">${displayNameHtml}</span>
        </span>
        <span class="font-black text-sm text-right">${winsDisplay}</span>
    `;

    // הוספת יכולת לחיצה רק אם המשחק מוכן וטרם הסתיים
    if (!match.winnerId && match.player1 && match.player2) {
        // קריאה לפונקציה openModal שהוגדרה ב-window
        slotEl.onclick = () => window.openModal(match.id);
        slotEl.classList.add('cursor-pointer', 'transition', 'hover:shadow-lg', 'hover:shadow-cyan-400/30');
    }
    
    return slotEl;
}


// --- Tournament Logic ---

window.removeTeam = (playerIdToRemove) => {
    if (tournamentData.status !== 'registration') return;
    tournamentData.teams = tournamentData.teams.filter(t => t.id !== playerIdToRemove);
    saveTournamentState();
}

document.getElementById('add-team-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const playerName = teamNameInput.value.trim();
    if (!playerName || playerName.length < 2) return;

    if (tournamentData.teams.length >= MAX_PLAYERS || tournamentData.status !== 'registration') {
        showRegistrationAlert(`הגעת למגבלה (${MAX_PLAYERS} שחקנים) או הטורניר כבר החל.`, 'error');
        return;
    }
    
    if (tournamentData.teams.some(t => t.name.toLowerCase() === playerName.toLowerCase())) {
        showRegistrationAlert("השחקן הזה כבר רשום!", 'error');
        return;
    }

    // הוספת הכינוי המצחיק
    const nickname = getAvailableNickname(tournamentData.teams);

    if (!nickname) {
        showRegistrationAlert("שגיאה: הגעת למספר הכינויים המקסימלי (16). לא ניתן להוסיף שחקנים נוספים.", 'error');
        return;
    }

    const newPlayer = { id: generateId(), name: playerName, nickname: nickname };
    tournamentData.teams.push(newPlayer);
    teamNameInput.value = '';
    teamNameInput.focus();
    showRegistrationAlert(`השחקן ${playerName} (הכינוי: ${nickname}) נוסף בהצלחה!`);
    
    saveTournamentState(); 
});

teamNameInput.addEventListener('input', () => {
    const hasAvailableNicknames = getAvailableNickname(tournamentData.teams) !== null || tournamentData.teams.length === MAX_PLAYERS;
    addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= MAX_PLAYERS || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
});

/**
 * מפעיל את הטורניר ומייצר את המשחקים הראשוניים.
 */
function generateBracket() {
    const players = shuffle([...tournamentData.teams]); 
    const matches = {
        roundOf16: [], quarterfinals: [], semifinals: [], final: []
    };

    // 1. שמינית גמר (Round of 16 - 8 matches)
    for (let i = 0; i < 8; i++) {
        matches.roundOf16.push({
            id: `r1m${i + 1}`,
            player1: players[i * 2] || null, // יכול להיות null אם הוספנו משלים אוטומטי
            player2: players[i * 2 + 1] || null,
            gameWins1: 0,
            gameWins2: 0,
            winnerId: null,
            // r1m1, r1m2 -> r2m1 | r1m3, r1m4 -> r2m2 | r1m5, r1m6 -> r2m3 | r1m7, r1m8 -> r2m4
            nextMatchId: `r2m${Math.floor(i / 2) + 1}`, 
            nextPlayerSlot: (i % 2) === 0 ? 1 : 2, // 1st match feeds slot 1, 2nd feeds slot 2
            status: 'active'
        });
    }

    // 2. רבע גמר (Quarterfinals - 4 matches)
    for (let i = 0; i < 4; i++) {
        matches.quarterfinals.push({
            id: `r2m${i + 1}`,
            player1: null,
            player2: null,
            gameWins1: 0,
            gameWins2: 0,
            winnerId: null,
            // r2m1, r2m2 -> r3m1 | r2m3, r2m4 -> r3m2
            nextMatchId: `r3m${Math.floor(i / 2) + 1}`,
            nextPlayerSlot: (i % 2) === 0 ? 1 : 2,
            status: 'pending'
        });
    }

    // 3. חצי גמר (Semifinals - 2 matches)
    for (let i = 0; i < 2; i++) {
        matches.semifinals.push({
            id: `r3m${i + 1}`,
            player1: null,
            player2: null,
            gameWins1: 0,
            gameWins2: 0,
            winnerId: null,
            // r3m1, r3m2 -> r4m1 (Final)
            nextMatchId: `r4m1`,
            nextPlayerSlot: i === 0 ? 1 : 2,
            status: 'pending'
        });
    }

    // 4. גמר (Final - 1 match) - אין nextMatchId
    matches.final.push({
        id: `r4m1`,
        player1: null,
        player2: null,
        gameWins1: 0,
        gameWins2: 0,
        winnerId: null,
        nextMatchId: null, // הגמר הוא הסוף
        nextPlayerSlot: null,
        status: 'pending'
    });
    
    tournamentData.matches = matches;
    tournamentData.status = 'in_progress';
    tournamentData.winner = null;
    tournamentData.showChampionModal = false;
    saveTournamentState();
}

/**
 * פונקציה המקדמת את השחקן המנצח לסיבוב הבא
 */
function updateNextMatch(match, winner) {
    if (!match.nextMatchId) {
        tournamentData.winner = winner;
        tournamentData.status = 'finished';
        tournamentData.showChampionModal = true;
        return;
    }

    const nextMatch = getMatchById(match.nextMatchId);
    if (!nextMatch) return;

    if (match.nextPlayerSlot === 1) {
        nextMatch.player1 = winner;
    } else {
        nextMatch.player2 = winner;
    }

    if (nextMatch.player1 && nextMatch.player2) {
        nextMatch.status = 'active';
    }
}

/**
 * סיום משחק וקידום המנצח
 */
function advanceWinner(match) {
    if (!match.winner) return;
    updateNextMatch(match, match.winner);
    saveTournamentState();
}


document.getElementById('start-tournament').addEventListener('click', () => {
    const currentTeamsCount = tournamentData.teams.length;
    if (currentTeamsCount < 2 && tournamentData.status === 'registration') {
        showRegistrationAlert(`⚠️ נדרשים לפחות שני שחקנים כדי להתחיל.`, 'error');
        return;
    }

    // 1. השלמה אוטומטית אם חסר
    if (currentTeamsCount < MAX_PLAYERS && tournamentData.status === 'registration') {
        const requiredCount = MAX_PLAYERS - currentTeamsCount;
        for (let i = 0; i < requiredCount; i++) {
            const tempName = `משלים אוטומטי ${i + 1}`;
            const nickname = getAvailableNickname(tournamentData.teams);
            
            if (!nickname) break; // עצירה אם אין יותר כינויים

            const newPlayer = { 
                id: generateId(), 
                name: tempName, 
                nickname: nickname,
                isAuto: true 
            };
            tournamentData.teams.push(newPlayer);
        }
        showRegistrationAlert(`✅ הטורניר הושלם אוטומטית ל-${tournamentData.teams.length} שחקנים.`, 'success');
    }

    // 2. הפעלת הטורניר
    if (tournamentData.teams.length >= 2 && tournamentData.status === 'registration') {
        generateBracket();
        statusMessage.textContent = '⚔️ הטורניר החל! יאללה בלאגן! לחץ על משחק כדי לעדכן תוצאה.';
        statusMessage.className = "text-center text-xl font-semibold mb-6 text-cyan-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
    } else if (tournamentData.status !== 'registration') {
        renderTournament(tournamentData);
    }
});


/**
 * מקדם זוכה משחק בודד בתוך משחק הטוב מ-5.
 */
window.handleGameWin = (matchId, playerSlot) => {
    const match = getMatchById(matchId);
    if (!match || match.winnerId) return;

    if (playerSlot === 1) {
        match.gameWins1++;
    } else if (playerSlot === 2) {
        match.gameWins2++;
    }
    
    // בדיקה האם המשחק הסתיים (הראשון ל-3)
    if (match.gameWins1 === WINS_TO_WIN_MATCH) {
        match.winnerId = match.player1.id;
        match.winner = match.player1;
        closeModal();
        advanceWinner(match);
    } else if (match.gameWins2 === WINS_TO_WIN_MATCH) { // תיקון לוגיקה
        match.winnerId = match.player2.id;
        match.winner = match.player2;
        closeModal();
        advanceWinner(match);
    } else {
        // אם המשחק עדיין לא הסתיים, מעדכן את המודאל וממשיך
        saveTournamentState();
        window.openModal(matchId);
    }
};

// אתחול האפליקציה בטעינת הדף
window.onload = initializeApp;
</script>
</body>
</html>
