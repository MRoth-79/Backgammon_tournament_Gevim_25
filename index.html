<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>×˜×•×¨× ×™×¨ × ×•×§×××•×˜ ×œ×˜×™×•×œ ×’×‘×¨×™×</title>
Â  Â  <!-- ×˜×¢×™× ×ª Tailwind CSS ×“×¨×š CDN -->
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script>
Â  Â  Â  Â  tailwind.config = {
Â  Â  Â  Â  Â  Â  theme: {
Â  Â  Â  Â  Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fontFamily: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sans: ['Inter', 'system-ui', 'sans-serif'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
Â  Â  <style>
Â  Â  Â  Â  /* ×”×’×“×¨×•×ª ×’×•×‘×” ×‘×¡×™×¡×™×•×ª ×œ×™×©×•×¨ ×”××©×—×§×™× */
Â  Â  Â  Â  .match-card {
Â  Â  Â  Â  Â  Â  width: 200px; /* ×¨×•×—×‘ ×§×‘×•×¢ ×œ×›×¨×˜×™×¡ ×”××©×—×§ */
Â  Â  Â  Â  Â  Â  height: 80px; /* ×’×•×‘×” h-20 */
Â  Â  Â  Â  Â  Â  margin-bottom: 16px; /* ××¨×•×•×— mb-4 */
Â  Â  Â  Â  Â  Â  box-sizing: border-box; /* ×—×©×•×‘ ×œ×©××™×¨×ª ×”×¨×•×—×‘ */
Â  Â  Â  Â  Â  Â  /* ×©×™× ×•×™: ×¨×§×¢ ×›×—×•×œ ×¢××•×§, ×‘×•×¨×“×¨ ×ª×›×œ×ª ×–×•×”×¨ */
Â  Â  Â  Â  Â  Â  background-color: #0c4a6e; /* dark cyan/blue */
Â  Â  Â  Â  Â  Â  border: 3px solid #38bdf8; /* border-sky-400 */
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(56, 189, 248, 0.4); /* Cyan shadow */
Â  Â  Â  Â  Â  Â  padding: 4px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .player-slot {
Â  Â  Â  Â  Â  Â  padding: 4px 8px;
Â  Â  Â  Â  Â  Â  margin: 2px 0;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  background-color: #f3f4f6; /* bg-gray-100 */
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  color: #1f2937; /* text-gray-800 */
Â  Â  Â  Â  Â  Â  line-height: 1.25;
Â  Â  Â  Â  Â  Â  min-height: 34px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .player-slot-filled:hover {
Â  Â  Â  Â  Â  Â  background-color: #d1d5db; /* bg-gray-300 */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .player-slot-winner {
Â  Â  Â  Â  Â  Â  background-color: #34d399; /* bg-emerald-400 */
Â  Â  Â  Â  Â  Â  color: #1f2937;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  }

Â  Â  Â  Â  .player-slot-loser {
Â  Â  Â  Â  Â  Â  background-color: #dc2626; /* bg-red-600 */
Â  Â  Â  Â  Â  Â  color: #f3f4f6;
Â  Â  Â  Â  Â  Â  opacity: 0.5;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ×©×™× ×•×™: ×¨×§×¢ ×ª×›×œ×ª ×œ×¨×™×§×™× */
Â  Â  Â  Â  .player-slot-empty {
Â  Â  Â  Â  Â  Â  background-color: #0e7490; /* bg-cyan-700 equivalent */
Â  Â  Â  Â  Â  Â  color: #bae6fd; /* text-sky-200 equivalent */
Â  Â  Â  Â  Â  Â  border: 1px dashed #67e8f9; /* border-cyan-300 equivalent */
Â  Â  Â  Â  }

Â  Â  Â  Â  .final-match {
Â  Â  Â  Â  Â  Â  width: 250px; /* ×’××¨ ×§×¦×ª ×™×•×ª×¨ ×¨×—×‘ */
Â  Â  Â  Â  Â  Â  border-width: 4px;
Â  Â  Â  Â  Â  Â  border-color: #f59e0b; /* border-amber-500 */
Â  Â  Â  Â  Â  Â  transform: scale(1.05); /* ×§×¦×ª ×™×•×ª×¨ ×’×“×•×œ */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ×”×ª×××” ×œ××•×‘×™×™×œ */
Â  Â  Â  Â  @media (max-width: 1024px) {
Â  Â  Â  Â  Â  Â  .bracket-container {
Â  Â  Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  Â  Â  justify-content: flex-start;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .round-column, .is-final-column {
Â  Â  Â  Â  Â  Â  Â  Â  min-width: 240px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 md:p-8 font-sans">
Â  Â Â 
Â  Â  <header class="text-center mb-10">
Â  Â  Â  Â  <h1 class="text-5xl font-extrabold text-cyan-400 tracking-wider">ğŸ» ×˜×•×¨× ×™×¨ ×”×˜×™×•×œ ×”×’×“×•×œ 2025 ğŸ†</h1>
Â  Â  Â  Â  <p class="text-xl text-gray-400 mt-2">××¢×¨×›×ª × ×™×”×•×œ × ×•×§×××•×˜ ×œ-16 ×œ×•×—××™×</p>
Â  Â  </header>

Â  Â  <!-- ×”×•×“×¢×ª ×¡×˜×˜×•×¡ ×’×œ×•×‘×œ×™×ª -->
Â  Â  <div id="status-message" class="text-center text-xl font-semibold mb-6 text-lime-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto transition">
Â  Â  Â  Â  ×˜×•×¢×Ÿ × ×ª×•× ×™×...
Â  Â  </div>

Â  Â  <!-- ×¡×§×¦×™×™×ª ×¨×™×©×•× ×©×—×§× ×™× (××•×¦×’×ª ×¨×§ ×‘×¨×™×©×•×) -->
Â  Â  <section id="registration-section" class="max-w-4xl mx-auto p-6 bg-slate-800 rounded-2xl shadow-xl border-t-4 border-cyan-500/50">
Â  Â  Â  Â  <h2 class="text-3xl font-bold mb-4 text-cyan-400">×¨×™×©×•× ×©×—×§× ×™× (<span id="team-count">0</span>/<span id="max-players-display">16</span>)</h2>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <form id="add-team-form" class="flex space-x-2 space-x-reverse mb-6">
Â  Â  Â  Â  Â  Â  <input type="text" id="team-name-input" placeholder="×©× ×©×—×§×Ÿ ××œ× (×—×•×‘×”)" required class="flex-1 p-3 rounded-xl bg-slate-700 text-white border-2 border-slate-600 focus:border-amber-400 focus:outline-none placeholder:text-gray-400 transition" />
Â  Â  Â  Â  Â  Â  <button type="submit" id="add-team-button" disabled class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed">
Â  Â  Â  Â  Â  Â  Â  Â  â• ×”×•×¡×£ ×©×—×§×Ÿ
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </form>

Â  Â  Â  Â  <ul id="teams-list" class="space-y-3 mb-6">
Â  Â  Â  Â  Â  Â  <!-- ×¨×©×™××ª ×”×©×—×§× ×™× ×ª×™×¨× ×“×¨ ×›××Ÿ -->
Â  Â  Â  Â  </ul>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="flex justify-between items-center pt-4 border-t border-slate-700">
Â  Â  Â  Â  Â  Â  <button id="start-tournament" disabled class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-black py-4 px-8 rounded-xl shadow-2xl text-xl transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
Â  Â  Â  Â  Â  Â  Â  Â  ğŸš€ ×”×ª×—×œ ×˜×•×¨× ×™×¨! ×™××œ×œ×” ×‘×œ××’×Ÿ
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button onclick="resetTournament()" class="bg-red-700 hover:bg-red-800 text-white font-medium py-2 px-4 rounded-xl transition">
Â  Â  Â  Â  Â  Â  Â  Â  ğŸ—‘ï¸ ××¤×¡ ×˜×•×¨× ×™×¨
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </section>

Â  Â  <!-- ×¡×§×¦×™×™×ª ×”×˜×•×¨× ×™×¨ (××•×¦×’×ª ×¨×§ ×œ××—×¨ ×”×ª×—×œ×”) -->
Â  Â  <section id="tournament-section" class="hidden mt-10 p-6 bg-slate-800 rounded-2xl shadow-2xl border-t-4 border-amber-500 max-w-full overflow-x-auto">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <!-- ×›×•×ª×¨×ª ×•×›×¤×ª×•×¨ ××™×¤×•×¡/×—×–×¨×” ××›×œ ×©×œ×‘ -->
Â  Â  Â  Â  <div class="flex justify-between items-center mb-6">
Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold text-amber-400">××‘× ×” ×”× ×•×§×××•×˜</h2>
Â  Â  Â  Â  Â  Â  <button onclick="resetTournament()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl shadow-md transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”„ ×—×–×¨×” ×œ×¨×™×©×•× / ××™×¤×•×¡ ××œ×
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <!-- ××™×›×œ ×”×˜×•×¨× ×™×¨ - Flexbox ×œ×˜×•×¨×™× ×¦××•×“×™× (×©×™× ×•×™: items-start ×•-py-8) -->
Â  Â  Â  Â  <div id="bracket-container" class="flex items-start py-8 bracket-container">
Â  Â  Â  Â  Â  Â  <!-- ×˜×•×¨×™ ×”××©×—×§×™× ×™×™×¨× ×“×¨×• ×›××Ÿ -->
Â  Â  Â  Â  </div>
Â  Â  </section>


Â  Â  <!-- Modal ×œ×¨×™×©×•× ×ª×•×¦××•×ª (×”×—×œ×•×Ÿ ×”×§×•×¤×¥ ×”××•×ª×× ××™×©×™×ª) -->
Â  Â  <div id="result-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4 transition-opacity">
Â  Â  Â  Â  <div class="bg-slate-700 rounded-xl p-8 w-full max-w-lg shadow-2xl border-t-4 border-cyan-400">
Â  Â  Â  Â  Â  Â  <h3 id="modal-match-title" class="text-3xl font-black mb-6 text-center text-cyan-400">×¢×“×›×•×Ÿ ×ª×•×¦××” - ×©××™× ×™×ª ×’××¨</h3>
Â  Â  Â  Â  Â  Â  <div id="modal-match-players" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- × ×ª×•× ×™ ×”××©×—×§ ×™×˜×¢× ×• ×›××Ÿ -->
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="modal-winner-select" class="mt-8 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg text-gray-300 mb-4">×‘×—×¨ ××ª ×”×× ×¦×— ×©×œ ×”××©×—×§ (×”×¨××©×•×Ÿ ×œ-<span id="modal-wins-to-win"></span>)</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="modal-win-buttons" class="flex justify-center space-x-4 space-x-reverse">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- ×›×¤×ª×•×¨×™× ×œ× ×™×¦×—×•×Ÿ ×‘×¡×™×‘×•×‘ ×™×˜×¢× ×• ×›××Ÿ -->
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="modal-error-message" class="text-red-400 mt-4 text-center hidden"></div>

Â  Â  Â  Â  Â  Â  <div class="mt-8 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-xl transition">×¡×’×•×¨</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <!-- Modal ×œ×× ×¦×— ×”×˜×•×¨× ×™×¨ -->
Â  Â  <div id="champion-modal" class="hidden fixed inset-0 z-50 bg-indigo-900 bg-opacity-95 flex items-center justify-center p-4 transition-opacity">
Â  Â  Â  Â  <div id="champion-card" class="bg-indigo-700 rounded-3xl p-12 w-full max-w-2xl shadow-[0_0_50px_rgba(165,180,252,0.8)] border-4 border-amber-400 text-center">
Â  Â  Â  Â  Â  Â  <!-- × ×ª×•× ×™ ×”×× ×¦×— ×™×˜×¢× ×• ×›××Ÿ -->
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button onclick="window.closeChampionModal()" class="absolute top-4 right-4 text-white text-5xl opacity-80 hover:opacity-100 transition">&times;</button>
Â  Â  </div>


<script>
// --- Constants and Global Variables ---
const STORAGE_KEY = 'mensTripTournamentData2025';
const MAX_PLAYERS = 16;
const WINS_TO_WIN_MATCH = 3; // ×”×˜×•×‘ ×-5 ××©×—×§×™ ×©×©-×‘×© / ×¤×•×§×¨ / ××—×¨
const MATCH_HEIGHT_UNIT = 96; // 80px (h-20) + 16px (mb-4) for vertical alignment

// Helper for unique IDs (simple UUID-like)
const generateId = () => Math.random().toString(36).substring(2, 9);

// Mock data initialization
const initialTournamentData = {
Â  Â  teams: [],
Â  Â  status: 'registration', // 'registration', 'in_progress', 'finished'
Â  Â  matches: {
Â  Â  Â  Â  roundOf16: [], quarterfinals: [], semifinals: [], final: []
Â  Â  },
Â  Â  winner: null,
Â  Â  showChampionModal: false
};

let tournamentData = { ...initialTournamentData };

// Element references (MUST MATCH HTML IDs)
const teamNameInput = document.getElementById('team-name-input');
const addTeamButton = document.getElementById('add-team-button');
const teamsListElement = document.getElementById('teams-list');
const teamCountElement = document.getElementById('team-count');
const startTournamentButton = document.getElementById('start-tournament');
const statusMessage = document.getElementById('status-message');
const registrationSection = document.getElementById('registration-section');
const tournamentSection = document.getElementById('tournament-section');
const bracketElement = document.getElementById('bracket-container');
const resultModal = document.getElementById('result-modal');
const championModal = document.getElementById('champion-modal');
const championCard = document.getElementById('champion-card');
document.getElementById('max-players-display').textContent = MAX_PLAYERS;
document.getElementById('modal-wins-to-win').textContent = WINS_TO_WIN_MATCH;


// --- Helper Functions ---

/**
Â * ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×›×™× ×•×™×™× ×™×™×—×•×“×™×™× ×•××¦×—×™×§×™×
Â */
const NICKNAMES = [
Â  Â  "×”××œ×š ×”×‘×œ×ª×™ ××¢×•×¨×¢×¨", "×”× ×•×’×¡ ×”××œ×’× ×˜×™", "×§×•×‘×™×•×ª ×”×¢×™×•×•×¨×•×ª", "×©×—×§×Ÿ ×”×˜×™×•×œ",
Â  Â  "×”×“××‘×œ ×”××•×œ×˜×™××˜×™×‘×™", "×”×¦×‘ ×”×¦×•×œ×¢", "×”×›×™ ×¤×—×•×ª ×’×¨×•×¢", "×”×”×™×™×–× ×‘×¨×’",
Â  Â  "×”×“×—×¤×•×¨", "× ×•×¢× ×”×‘×•×’×“", "×”×¦'×™×¤×× ×§", "×™×•× ×ª×Ÿ ×”×˜×™×’×¨×™×¡",
Â  Â  "×”× ××¨ ×”×–×§×Ÿ", "×”××œ×•×£ ×‘×”××ª× ×”", "××‘×™×ª×¨ ×”×‘×›×™×™×Ÿ", "×”×§×™×œ×¨ ×”×©×§×˜"
];

function getAvailableNickname(usedTeams) {
Â  Â  const usedNicknames = new Set(usedTeams.map(t => t.nickname));
Â  Â  return NICKNAMES.find(nick => !usedNicknames.has(nick)) || null;
}

/**
Â * ×¤×•× ×§×¦×™×” ×œ×¢×¨×‘×•×‘ ××¢×¨×š (××œ×’×•×¨×™×ª× Fisher-Yates)
Â */
function shuffle(array) {
Â  Â  let currentIndex = array.length, randomIndex;
Â  Â  while (currentIndex !== 0) {
Â  Â  Â  Â  randomIndex = Math.floor(Math.random() * currentIndex);
Â  Â  Â  Â  currentIndex--;
Â  Â  Â  Â  [array[currentIndex], array[randomIndex]] = [
Â  Â  Â  Â  Â  Â  array[randomIndex], array[currentIndex]];
Â  Â  }
Â  Â  return array;
}

/**
Â * ×¤×•× ×§×¦×™×” ×œ×©×œ×™×¤×ª ××©×—×§ ×œ×¤×™ ID ××ª×•×š ×›×œ ×”×¡×™×‘×•×‘×™×
Â */
function getMatchById(matchId) {
Â  Â  const { roundOf16, quarterfinals, semifinals, final } = tournamentData.matches;
Â  Â  const allMatches = [...roundOf16, ...quarterfinals, ...semifinals, ...final];
Â  Â  return allMatches.find(m => m.id === matchId);
}

/**
Â * ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×•×ª ×¡×˜×˜×•×¡ ×§×¦×¨×•×ª (××—×œ×™×£ alert)
Â */
function showRegistrationAlert(message, type = 'success') {
Â  Â  console.log(`Alert (${type}): ${message}`);
Â  Â  const color = type === 'error' ? 'text-red-400' : 'text-lime-400';
Â  Â  statusMessage.textContent = message;
Â  Â  statusMessage.className = `text-center text-xl font-semibold mb-6 ${color} bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto transition`;
}


// --- Modal Handling ---

window.openModal = (matchId) => {
Â  Â  const match = getMatchById(matchId);
Â  Â  if (!match || match.winnerId || !match.player1 || !match.player2) return;

Â  Â  // ×›×•×ª×¨×ª ×”××•×“××œ
Â  Â  let roundTitle = '';
Â  Â  if (matchId.startsWith('r1')) roundTitle = '×©××™× ×™×ª ×’××¨';
Â  Â  else if (matchId.startsWith('r2')) roundTitle = '×¨×‘×¢ ×’××¨';
Â  Â  else if (matchId.startsWith('r3')) roundTitle = '×—×¦×™ ×’××¨';
Â  Â  else if (matchId.startsWith('r4')) roundTitle = '×”×’××¨ ×”×’×“×•×œ';
Â  Â Â 
Â  Â  document.getElementById('modal-match-title').textContent = `×¢×“×›×•×Ÿ ×ª×•×¦××” - ${roundTitle}`;
Â  Â Â 
Â  Â  // × ×ª×•× ×™ ×”×©×—×§× ×™× ×•×”×ª×•×¦××” ×”× ×•×›×—×™×ª
Â  Â  const modalPlayersEl = document.getElementById('modal-match-players');
Â  Â  modalPlayersEl.innerHTML = `
Â  Â  Â  Â  <div class="flex justify-between items-center text-xl font-bold p-3 rounded-lg bg-slate-800 border-b border-cyan-500">
Â  Â  Â  Â  Â  Â  <span class="text-white">${match.player1.nickname || match.player1.name}</span>
Â  Â  Â  Â  Â  Â  <span class="text-amber-400">${match.gameWins1} - ${match.gameWins2}</span>
Â  Â  Â  Â  Â  Â  <span class="text-white">${match.player2.nickname || match.player2.name}</span>
Â  Â  Â  Â  </div>
Â  Â  `;

Â  Â  // ×›×¤×ª×•×¨×™ ×”× ×™×¦×—×•×Ÿ
Â  Â  const modalWinButtonsEl = document.getElementById('modal-win-buttons');
Â  Â  modalWinButtonsEl.innerHTML = `
Â  Â  Â  Â  <button onclick="window.handleGameWin('${matchId}', 1)" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105">
Â  Â  Â  Â  Â  Â  ğŸ† × ×™×¦×—×•×Ÿ ×œ-${match.player1.nickname || match.player1.name}
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button onclick="window.handleGameWin('${matchId}', 2)" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105">
Â  Â  Â  Â  Â  Â  ğŸ† × ×™×¦×—×•×Ÿ ×œ-${match.player2.nickname || match.player2.name}
Â  Â  Â  Â  </button>
Â  Â  `;

Â  Â  resultModal.classList.remove('hidden');
}

window.closeModal = () => {
Â  Â  resultModal.classList.add('hidden');
}

window.closeChampionModal = () => {
Â  Â  tournamentData.showChampionModal = false;
Â  Â  saveTournamentState();
}


// --- State Management (using Local Storage as provided) ---

function loadData() {
Â  Â  try {
Â  Â  Â  Â  const storedData = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  if (storedData) {
Â  Â  Â  Â  Â  Â  tournamentData = JSON.parse(storedData);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  tournamentData = { ...initialTournamentData };
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Local Storage: Error loading data:", e);
Â  Â  Â  Â  tournamentData = { ...initialTournamentData };
Â  Â  }
}

function saveTournamentState() {
Â  Â  try {
Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(tournamentData));
Â  Â  Â  Â  renderTournament(tournamentData); // ×¨×™× ×“×•×¨ ××™×™×“×™ ×œ××—×¨ ×©××™×¨×”
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Local Storage: Error saving data:", e);
Â  Â  Â  Â  showRegistrationAlert("×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×‘×“×¤×“×¤×Ÿ.", 'error');
Â  Â  }
}

// ×”×¤×•× ×§×¦×™×” ×”××‘×¦×¢×ª ××™×¤×•×¡ ××œ×
window.resetTournament = () => {
Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  tournamentData = { ...initialTournamentData };
Â  Â  initializeApp();
Â  Â  statusMessage.textContent = 'ğŸ§¹ ×”×˜×•×¨× ×™×¨ ××•×¤×¡ ×‘×”×¦×œ×—×”! × ×™×ª×Ÿ ×œ×”×ª×—×™×œ ×¨×™×©×•× ××—×“×©.';
Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-4 text-amber-400 bg-slate-700/50 p-3 rounded-xl max-w-4xl mx-auto";
};

function initializeApp() {
Â  Â  loadData();
Â  Â  renderTournament(tournamentData);
Â  Â Â 
Â  Â  if (tournamentData.status !== 'registration') {
Â  Â  Â  Â  statusMessage.textContent = tournamentData.status === 'finished' ?Â 
Â  Â  Â  Â  Â  Â  'ğŸ‰ ×”×˜×•×¨× ×™×¨ ×”×¡×ª×™×™×! ×œ×—×¥ "×—×–×¨×” ×œ×¨×™×©×•× / ××™×¤×•×¡ ××œ×" ×›×“×™ ×œ×”×ª×—×™×œ ×—×“×©.' :Â 
Â  Â  Â  Â  Â  Â  'ğŸ² ×”×˜×•×¨× ×™×¨ ×‘×¢×™×¦×•××•! × ×ª×•× ×™× × ×©××¨×™× ××§×•××™×ª.';
Â  Â  Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-6 text-cyan-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
Â  Â  } else {
Â  Â  Â  Â  statusMessage.textContent = `âœ… ××¦×‘ ××§×•××™ (Local Storage) ×¤×¢×™×œ. ×”× ×ª×•× ×™× × ×©××¨×™× ×‘×“×¤×“×¤×Ÿ ×–×”. × ×“×¨×©×™× ${MAX_PLAYERS} ×©×—×§× ×™×, ××š × ×™×ª×Ÿ ×œ×”×ª×—×™×œ ×¢× 2 ×•××¢×œ×” (×”×©×œ××” ××•×˜×•××˜×™×ª).`;
Â  Â  Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-6 text-lime-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
Â  Â  }
}


// --- UI Rendering ---

function renderTournament(data) {
Â  Â  const { teams, status, winner, showChampionModal } = data;

Â  Â  // 1. ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×©×—×§× ×™× ×•×›×¤×ª×•×¨ ×”×”×ª×—×œ×”
Â  Â  teamsListElement.innerHTML = '';
Â  Â  teamCountElement.textContent = teams.length;
Â  Â Â 
Â  Â  teams.forEach((team, index) => {
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  li.className = 'flex justify-between items-center bg-slate-700 p-3 rounded-xl text-white font-medium shadow-md border border-cyan-500/30';Â 
Â  Â  Â  Â  // ×”×¦×’×ª ×”×›×™× ×•×™ ×›×©× ×”×¨××©×™ ×•×”×©× ×”××§×•×¨×™ ×‘×¡×•×’×¨×™×™×
Â  Â  Â  Â  const displayName = `${team.nickname || '××™×Ÿ ×›×™× ×•×™'} <span class="text-amber-300 font-normal">(${team.name})</span>`;
Â  Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  Â  Â  <span class="text-xl">${index + 1}. <span class="truncate">${displayName}</span></span>
Â  Â  Â  Â  Â  Â  <button class="text-red-400 hover:text-red-500 text-lg bg-transparent p-1 rounded-full hover:bg-red-900/50 transition font-bold" onclick="removeTeam('${team.id}')" ${status !== 'registration' ? 'disabled' : ''}>[X] ×”×¡×¨</button>
Â  Â  Â  Â  `;
Â  Â  Â  Â  teamsListElement.appendChild(li);
Â  Â  });

Â  Â  if (teams.length === 0) {
Â  Â  Â  Â  teamsListElement.innerHTML = `<li class="text-gray-400 text-center py-4 italic text-lg">ğŸ² × ×“×¨×©×™× ${MAX_PLAYERS} ×©×—×§× ×™× ×œ×”×ª×—×œ×ª ×”×˜×•×¨× ×™×¨. ×”×•×¡×£ ×©×—×§× ×™× ×œ××¢×œ×”.</li>`;
Â  Â  }

Â  Â  // 2. × ×™×”×•×œ ××¦×‘ ×”×”×¨×©××” ×•×›×¤×ª×•×¨ ×”'×”×ª×—×œ ×˜×•×¨× ×™×¨'
Â  Â  const teamCount = teams.length;
Â  Â  const hasAvailableNicknames = getAvailableNickname(teams) !== null || teamCount === MAX_PLAYERS;
Â  Â Â 
Â  Â  addTeamButton.disabled = tournamentData.status !== 'registration' || teamCount >= MAX_PLAYERS || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
Â  Â Â 
Â  Â  // ×©×™× ×•×™: ×××¤×©×¨ ×œ×”×ª×—×™×œ ×¢× 2 ×©×—×§× ×™× ×•××¢×œ×”
Â  Â  startTournamentButton.disabled = tournamentData.status !== 'registration' || teamCount < 2;
Â  Â  if (teamCount >= 2 && teamCount < MAX_PLAYERS) {
Â  Â  Â  Â  startTournamentButton.textContent = `ğŸš€ ×”×ª×—×œ! (×™×•×©×œ× ××•×˜×•××˜×™×ª ×œ-${MAX_PLAYERS})`;
Â  Â  } else if (teamCount === MAX_PLAYERS) {
Â  Â  Â  Â  startTournamentButton.textContent = 'ğŸš€ ×”×ª×—×œ ×˜×•×¨× ×™×¨! ×™××œ×œ×” ×‘×œ××’×Ÿ';
Â  Â  } else {
Â  Â  Â  Â  startTournamentButton.textContent = `×¦×¨×™×š ×œ×¤×—×•×ª 2 ×©×—×§× ×™× (${MAX_PLAYERS - teamCount} ×—×¡×¨×™×)`;
Â  Â  }


Â  Â  if (status === 'registration') {
Â  Â  Â  Â  registrationSection.classList.remove('hidden');
Â  Â  Â  Â  tournamentSection.classList.add('hidden');
Â  Â  } else {
Â  Â  Â  Â  registrationSection.classList.add('hidden');
Â  Â  Â  Â  tournamentSection.classList.remove('hidden');
Â  Â  }
Â  Â Â 
Â  Â  // 3. ×”×¦×’×ª ×˜×‘×œ×ª ×”× ×•×§×××•×˜
Â  Â  if (status !== 'registration') {
Â  Â  Â  Â  renderSplitBracket(data.matches, winner, showChampionModal);
Â  Â  }
}

// ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª ×œ×”×¦×’×ª ××‘× ×” ×”×˜×•×¨× ×™×¨ ×”××¤×•×¦×œ ×œ-16 ×©×—×§× ×™× ×¢× ×™×™×©×•×¨ ×¢×œ×™×•×Ÿ
function renderSplitBracket(matches, tournamentWinner, showChampionModal) {
Â  Â  bracketElement.innerHTML = '';

Â  Â  if (tournamentWinner && showChampionModal) {
Â  Â  Â  Â  championCard.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="flex flex-col items-center space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-8xl">ğŸ‘‘</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-4xl font-extrabold text-white">×”×× ×¦×— ×©×œ ×”×˜×™×•×œ:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-7xl font-black text-amber-300">${tournamentWinner.nickname || tournamentWinner.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-3xl mt-4 text-cyan-200">(${tournamentWinner.name}) ×–×›×™×ª ×‘×›×‘×•×“ ×”× ×¦×—×™!</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="window.closeChampionModal()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl transition">×¡×’×•×¨</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  championModal.classList.remove('hidden');
Â  Â  } else {
Â  Â  Â  Â  championModal.classList.add('hidden');
Â  Â  }

Â  Â  // ×¨×™×›×•×– ×›×œ ×”××©×—×§×™× ×œ×¤×™ ××–×”×” ×œ×©×œ×™×¤×” × ×•×—×”
Â  Â  const allMatches = [...matches.roundOf16, ...matches.quarterfinals, ...matches.semifinals, ...matches.final].reduce((acc, m) => {
Â  Â  Â  Â  acc[m.id] = m;
Â  Â  Â  Â  return acc;
Â  Â  }, {});

Â  Â  // ×”×’×“×¨×ª ××‘× ×” ×”×˜×•×¨× ×™×¨ ×”××¤×•×¦×œ ×œ-7 ×˜×•×¨×™×
Â  Â  const H = MATCH_HEIGHT_UNIT; // 96px (Match Card height + margin-bottom)

Â  Â  // ×©×™× ×•×™: ×”×ª×××ª ×”×¨×•×•×—×™× ×œ×™×™×©×•×¨ ×¢×œ×™×•×Ÿ (×”×–×–×” ×©×œ SF ×•-Final ×œ××¢×œ×”)
Â  Â  const R16_Spacers = [H * 0.5, H, H, H]; // ×©×•××¨ ×¢×œ ×™×—×¡ ×”××¨×—×§×™× ×”×¤× ×™××™
Â  Â  const QF_Spacers = [H * 1.5, H * 3.0]; // ×©×•××¨ ×¢×œ ×™×—×¡ ×”××¨×—×§×™× ×”×¤× ×™××™
Â  Â  const SF_Spacers = [H * 1.5]; // ×”×™×” 3.5H - ×”×•×–×– ×œ××¢×œ×”
Â  Â  const Final_Spacers = [H * 1.5]; // ×”×™×” 3.5H - ×”×•×–×– ×œ××¢×œ×”


Â  Â  const columnStructure = [
Â  Â  Â  Â  // 1. ×©××™× ×™×ª ×’××¨ - ×™××™×Ÿ (R16_R) - 4 ××©×—×§×™× (1, 2, 3, 4)
Â  Â  Â  Â  { key: 'R16_R', title: '×©××™× ×™×ª ×’××¨', matchIds: ['r1m1', 'r1m2', 'r1m3', 'r1m4'], spacerHeights: R16_Spacers, titleColor: 'text-cyan-400' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. ×¨×‘×¢ ×’××¨ - ×™××™×Ÿ (QF_R) - 2 ××©×—×§×™× (1, 2)
Â  Â  Â  Â  { key: 'QF_R', title: '×¨×‘×¢ ×’××¨', matchIds: ['r2m1', 'r2m2'], spacerHeights: QF_Spacers, titleColor: 'text-cyan-400' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 3. ×—×¦×™ ×’××¨ - ×™××™×Ÿ (SF_R) - 1 ××©×—×§ (1)
Â  Â  Â  Â  { key: 'SF_R', title: '×—×¦×™ ×’××¨', matchIds: ['r3m1'], spacerHeights: SF_Spacers, titleColor: 'text-cyan-400' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 4. ×’××¨ (Final) - 1 ××©×—×§ - ××¨×›×– (×’×“×•×œ ×™×•×ª×¨)
Â  Â  Â  Â  { key: 'Final', title: '×”×’××¨ ×”×’×“×•×œ', matchIds: ['r4m1'], spacerHeights: Final_Spacers, isFinal: true, titleColor: 'text-amber-300' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 5. ×—×¦×™ ×’××¨ - ×©×××œ (SF_L) - 1 ××©×—×§ (2)
Â  Â  Â  Â  { key: 'SF_L', title: '×—×¦×™ ×’××¨', matchIds: ['r3m2'], spacerHeights: SF_Spacers, titleColor: 'text-cyan-400' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 6. ×¨×‘×¢ ×’××¨ - ×©×××œ (QF_L) - 2 ××©×—×§×™× (3, 4)
Â  Â  Â  Â  { key: 'QF_L', title: '×¨×‘×¢ ×’××¨', matchIds: ['r2m3', 'r2m4'], spacerHeights: QF_Spacers, titleColor: 'text-cyan-400' },
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 7. ×©××™× ×™×ª ×’××¨ - ×©×××œ (R16_L) - 4 ××©×—×§×™× (5, 6, 7, 8)
Â  Â  Â  Â  { key: 'R16_L', title: '×©××™× ×™×ª ×’××¨', matchIds: ['r1m5', 'r1m6', 'r1m7', 'r1m8'], spacerHeights: R16_Spacers, titleColor: 'text-cyan-400' },
Â  Â  ];


Â  Â  columnStructure.forEach(col => {
Â  Â  Â  Â  const roundColumn = document.createElement('div');
Â  Â  Â  Â  roundColumn.className = `flex flex-col items-center p-2 mx-2 ${col.isFinal ? 'is-final-column' : 'round-column'}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let preTitle = '';

Â  Â  Â  Â  if (col.isFinal) {
Â  Â  Â  Â  Â  Â  // ×©×™× ×•×™ ×”×›×•×›×‘ ×œ×’×‘×™×¢
Â  Â  Â  Â  Â  Â  preTitle = '<div class="text-4xl text-amber-500 mb-2">ğŸ†</div>';Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ×”×•×¡×¤×ª ×›×•×ª×¨×ª ×œ×›×œ ×˜×•×¨
Â  Â  Â  Â  roundColumn.innerHTML += `
Â  Â  Â  Â  Â  Â  ${preTitle}
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-black ${col.titleColor} mb-6 text-center">${col.title}</h3>
Â  Â  Â  Â  `;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let spacerIndex = 0;

Â  Â  Â  Â  col.matchIds.forEach((matchId) => {
Â  Â  Â  Â  Â  Â  const match = allMatches[matchId];
Â  Â  Â  Â  Â  Â  if (!match) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ×”×•×¡×¤×ª ×¨×•×•×— ×œ×¤× ×™ ×”××©×—×§
Â  Â  Â  Â  Â  Â  if (col.spacerHeights[spacerIndex] !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  const spacerHeight = col.spacerHeights[spacerIndex];
Â  Â  Â  Â  Â  Â  Â  Â  const spacer = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  spacer.style.height = `${spacerHeight}px`;
Â  Â  Â  Â  Â  Â  Â  Â  spacer.className = `w-full`;
Â  Â  Â  Â  Â  Â  Â  Â  roundColumn.appendChild(spacer);
Â  Â  Â  Â  Â  Â  Â  Â  spacerIndex++;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const matchContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  matchContainer.id = match.id;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let matchClass = 'match-card rounded-xl flex flex-col justify-center';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ×¢×™×¦×•×‘ ××™×•×—×“ ×œ×’××¨ (×”×¤×™×›×” ×œ×’×“×•×œ ×™×•×ª×¨)
Â  Â  Â  Â  Â  Â  if (matchId === 'r4m1') {
Â  Â  Â  Â  Â  Â  Â  Â  matchClass += ' final-match';Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  matchContainer.className = matchClass;

Â  Â  Â  Â  Â  Â  const matchInfo = document.createElement('div');
Â  Â  Â  Â  Â  Â  matchInfo.className = 'flex flex-col w-full';

Â  Â  Â  Â  Â  Â  // ×©×™××•×© ×‘×¤×•× ×§×¦×™×” createPlayerSlot ×”××•×’×“×¨×ª
Â  Â  Â  Â  Â  Â  const player1Slot = createPlayerSlot(match, match.player1, match.gameWins1, true); // true for P1
Â  Â  Â  Â  Â  Â  const player2Slot = createPlayerSlot(match, match.player2, match.gameWins2, false); // false for P2
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  matchInfo.appendChild(player1Slot);
Â  Â  Â  Â  Â  Â  matchInfo.appendChild(player2Slot);
Â  Â  Â  Â  Â  Â  matchContainer.appendChild(matchInfo);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  roundColumn.appendChild(matchContainer);
Â  Â  Â  Â  });

Â  Â  Â  Â  bracketElement.appendChild(roundColumn);
Â  Â  });
}

function createPlayerSlot(match, player, gameWins, isPlayer1) {
Â  Â  const slotEl = document.createElement('div');
Â  Â  slotEl.className = 'player-slot relative';
Â  Â Â 
Â  Â  // ×”×¦×’×ª ×”×©× ×”×¨××©×™ (×›×™× ×•×™ ×× ×§×™×™×)
Â  Â  let playerName = player?.nickname || player?.name || (match.status === 'pending' ? '×××ª×™×Ÿ ×œ×–×•×›×”' : '---');
Â  Â  let winsDisplay = gameWins > 0 ? `(${gameWins}/${WINS_TO_WIN_MATCH})` : '';Â 
Â  Â  let icon = 'ğŸ¯'; // ×©×™× ×•×™ ××™×™×§×•×Ÿ ×›×œ×œ×™ ×œ×˜×•×¨× ×™×¨

Â  Â  // ×©×™×œ×•×‘ ×©× ×•×›×™× ×•×™ ×œ×”×¦×’×” - ×¢×›×©×™×• ×”×›×™× ×•×™ ×”×•× ×”×¨××©×™
Â  Â  let displayNameHtml = playerName;
Â  Â  if (player && player.nickname && player.name) {
Â  Â  Â  Â  // ×”×¦×’×ª ×”×›×™× ×•×™ ×›×©× ×”×¨××©×™ ×•×”×©× ×”××§×•×¨×™ ×‘×¡×•×’×¨×™×™×
Â  Â  Â  Â  const nameColor = match.winnerId ? 'text-gray-900/80' : 'text-slate-900/80';
Â  Â  Â  Â  displayNameHtml = `${player.nickname} <span class="text-sm font-normal ${nameColor}">(${player.name})</span>`;
Â  Â  } else if (player && player.name) {
Â  Â  Â  Â  Â  displayNameHtml = player.name;
Â  Â  }


Â  Â  let isWinner = match.winnerId && player && match.winnerId === player.id;
Â  Â  let isLoser = match.winnerId && player && match.winnerId !== player.id;
Â  Â  let isEmpty = !player && match.status !== 'pending';

Â  Â  if (isEmpty) {
Â  Â  Â  Â  slotEl.classList.remove('player-slot-filled');
Â  Â  Â  Â  slotEl.classList.add('player-slot-empty');
Â  Â  Â  Â  icon = '...';
Â  Â  Â  Â  displayNameHtml = playerName; // ×œ× ×œ×”×¦×™×’ ×¡×•×’×¨×™×™× ×× ×¨×™×§
Â  Â  } else if (isWinner) {
Â  Â  Â  Â  slotEl.classList.add('player-slot-winner');
Â  Â  Â  Â  winsDisplay = `(×”×× ×¦×—!)`;Â 
Â  Â  Â  Â  icon = 'ğŸ‘‘';
Â  Â  Â  Â  // ×‘×¢×ª × ×™×¦×—×•×Ÿ, ××•×•×“××™× ×©×”×›×™× ×•×™ ××•×¦×’ ×‘×¦×•×¨×” ×‘×¨×•×¨×”
Â  Â  Â  Â  displayNameHtml = player.nickname || player.name;
Â  Â  Â  Â  if (player.nickname && player.name) {
Â  Â  Â  Â  Â  Â  Â displayNameHtml = `${player.nickname} <span class="text-sm font-normal text-gray-900/80">(${player.name})</span>`;
Â  Â  Â  Â  }
Â  Â  } else if (isLoser) {
Â  Â  Â  Â  slotEl.classList.add('player-slot-loser');
Â  Â  Â  Â  icon = 'âŒ';
Â  Â  } else if (player) {
Â  Â  Â  Â  slotEl.classList.add('player-slot-filled');
Â  Â  }
Â  Â Â 
Â  Â  // ×”×ª×•×›×Ÿ ×©×œ ×”×¡×œ×•×˜
Â  Â  slotEl.innerHTML = `
Â  Â  Â  Â  <span class="text-base font-bold flex items-center gap-2">
Â  Â  Â  Â  Â  Â  ${icon} <span class="truncate">${displayNameHtml}</span>
Â  Â  Â  Â  </span>
Â  Â  Â  Â  <span class="font-black text-sm text-right">${winsDisplay}</span>
Â  Â  `;

Â  Â  // ×”×•×¡×¤×ª ×™×›×•×œ×ª ×œ×—×™×¦×” ×¨×§ ×× ×”××©×—×§ ××•×›×Ÿ ×•×˜×¨× ×”×¡×ª×™×™×
Â  Â  if (!match.winnerId && match.player1 && match.player2) {
Â  Â  Â  Â  // ×§×¨×™××” ×œ×¤×•× ×§×¦×™×” openModal ×©×”×•×’×“×¨×” ×‘-window
Â  Â  Â  Â  slotEl.onclick = () => window.openModal(match.id);
Â  Â  Â  Â  slotEl.classList.add('cursor-pointer', 'transition', 'hover:shadow-lg', 'hover:shadow-cyan-400/30');
Â  Â  }
Â  Â Â 
Â  Â  return slotEl;
}


// --- Tournament Logic ---

window.removeTeam = (playerIdToRemove) => {
Â  Â  if (tournamentData.status !== 'registration') return;
Â  Â  tournamentData.teams = tournamentData.teams.filter(t => t.id !== playerIdToRemove);
Â  Â  saveTournamentState();
}

document.getElementById('add-team-form').addEventListener('submit', (e) => {
Â  Â  e.preventDefault();
Â  Â  const playerName = teamNameInput.value.trim();
Â  Â  if (!playerName || playerName.length < 2) return;

Â  Â  if (tournamentData.teams.length >= MAX_PLAYERS || tournamentData.status !== 'registration') {
Â  Â  Â  Â  showRegistrationAlert(`×”×’×¢×ª ×œ××’×‘×œ×” (${MAX_PLAYERS} ×©×—×§× ×™×) ××• ×”×˜×•×¨× ×™×¨ ×›×‘×¨ ×”×—×œ.`, 'error');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if (tournamentData.teams.some(t => t.name.toLowerCase() === playerName.toLowerCase())) {
Â  Â  Â  Â  showRegistrationAlert("×”×©×—×§×Ÿ ×”×–×” ×›×‘×¨ ×¨×©×•×!", 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // ×”×•×¡×¤×ª ×”×›×™× ×•×™ ×”××¦×—×™×§
Â  Â  const nickname = getAvailableNickname(tournamentData.teams);

Â  Â  if (!nickname) {
Â  Â  Â  Â  showRegistrationAlert("×©×’×™××”: ×”×’×¢×ª ×œ××¡×¤×¨ ×”×›×™× ×•×™×™× ×”××§×¡×™××œ×™ (16). ×œ× × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×©×—×§× ×™× × ×•×¡×¤×™×.", 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const newPlayer = { id: generateId(), name: playerName, nickname: nickname };
Â  Â  tournamentData.teams.push(newPlayer);
Â  Â  teamNameInput.value = '';
Â  Â  teamNameInput.focus();
Â  Â  showRegistrationAlert(`×”×©×—×§×Ÿ ${playerName} (×”×›×™× ×•×™: ${nickname}) × ×•×¡×£ ×‘×”×¦×œ×—×”!`);
Â  Â Â 
Â  Â  saveTournamentState();Â 
});

teamNameInput.addEventListener('input', () => {
Â  Â  const hasAvailableNicknames = getAvailableNickname(tournamentData.teams) !== null || tournamentData.teams.length === MAX_PLAYERS;
Â  Â  addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= MAX_PLAYERS || teamNameInput.value.trim() === '' || !hasAvailableNicknames;
});

/**
Â * ××¤×¢×™×œ ××ª ×”×˜×•×¨× ×™×¨ ×•××™×™×¦×¨ ××ª ×”××©×—×§×™× ×”×¨××©×•× ×™×™×.
Â */
function generateBracket() {
Â  Â  const players = shuffle([...tournamentData.teams]);Â 
Â  Â  const matches = {
Â  Â  Â  Â  roundOf16: [], quarterfinals: [], semifinals: [], final: []
Â  Â  };

Â  Â  // 1. ×©××™× ×™×ª ×’××¨ (Round of 16 - 8 matches)
Â  Â  for (let i = 0; i < 8; i++) {
Â  Â  Â  Â  matches.roundOf16.push({
Â  Â  Â  Â  Â  Â  id: `r1m${i + 1}`,
Â  Â  Â  Â  Â  Â  player1: players[i * 2] || null, // ×™×›×•×œ ×œ×”×™×•×ª null ×× ×”×•×¡×¤× ×• ××©×œ×™× ××•×˜×•××˜×™
Â  Â  Â  Â  Â  Â  player2: players[i * 2 + 1] || null,
Â  Â  Â  Â  Â  Â  gameWins1: 0,
Â  Â  Â  Â  Â  Â  gameWins2: 0,
Â  Â  Â  Â  Â  Â  winnerId: null,
Â  Â  Â  Â  Â  Â  // r1m1, r1m2 -> r2m1 | r1m3, r1m4 -> r2m2 | r1m5, r1m6 -> r2m3 | r1m7, r1m8 -> r2m4
Â  Â  Â  Â  Â  Â  nextMatchId: `r2m${Math.floor(i / 2) + 1}`,Â 
Â  Â  Â  Â  Â  Â  nextPlayerSlot: (i % 2) === 0 ? 1 : 2, // 1st match feeds slot 1, 2nd feeds slot 2
Â  Â  Â  Â  Â  Â  status: 'active'
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // 2. ×¨×‘×¢ ×’××¨ (Quarterfinals - 4 matches)
Â  Â  for (let i = 0; i < 4; i++) {
Â  Â  Â  Â  matches.quarterfinals.push({
Â  Â  Â  Â  Â  Â  id: `r2m${i + 1}`,
Â  Â  Â  Â  Â  Â  player1: null,
Â  Â  Â  Â  Â  Â  player2: null,
Â  Â  Â  Â  Â  Â  gameWins1: 0,
Â  Â  Â  Â  Â  Â  gameWins2: 0,
Â  Â  Â  Â  Â  Â  winnerId: null,
Â  Â  Â  Â  Â  Â  // r2m1, r2m2 -> r3m1 | r2m3, r2m4 -> r3m2
Â  Â  Â  Â  Â  Â  nextMatchId: `r3m${Math.floor(i / 2) + 1}`,
Â  Â  Â  Â  Â  Â  nextPlayerSlot: (i % 2) === 0 ? 1 : 2,
Â  Â  Â  Â  Â  Â  status: 'pending'
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // 3. ×—×¦×™ ×’××¨ (Semifinals - 2 matches)
Â  Â  for (let i = 0; i < 2; i++) {
Â  Â  Â  Â  matches.semifinals.push({
Â  Â  Â  Â  Â  Â  id: `r3m${i + 1}`,
Â  Â  Â  Â  Â  Â  player1: null,
Â  Â  Â  Â  Â  Â  player2: null,
Â  Â  Â  Â  Â  Â  gameWins1: 0,
Â  Â  Â  Â  Â  Â  gameWins2: 0,
Â  Â  Â  Â  Â  Â  winnerId: null,
Â  Â  Â  Â  Â  Â  // r3m1, r3m2 -> r4m1 (Final)
Â  Â  Â  Â  Â  Â  nextMatchId: `r4m1`,
Â  Â  Â  Â  Â  Â  nextPlayerSlot: i === 0 ? 1 : 2,
Â  Â  Â  Â  Â  Â  status: 'pending'
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // 4. ×’××¨ (Final - 1 match) - ××™×Ÿ nextMatchId
Â  Â  matches.final.push({
Â  Â  Â  Â  id: `r4m1`,
Â  Â  Â  Â  player1: null,
Â  Â  Â  Â  player2: null,
Â  Â  Â  Â  gameWins1: 0,
Â  Â  Â  Â  gameWins2: 0,
Â  Â  Â  Â  winnerId: null,
Â  Â  Â  Â  nextMatchId: null, // ×”×’××¨ ×”×•× ×”×¡×•×£
Â  Â  Â  Â  nextPlayerSlot: null,
Â  Â  Â  Â  status: 'pending'
Â  Â  });
Â  Â Â 
Â  Â  tournamentData.matches = matches;
Â  Â  tournamentData.status = 'in_progress';
Â  Â  tournamentData.winner = null;
Â  Â  tournamentData.showChampionModal = false;
Â  Â  saveTournamentState();
}

/**
 * ×¤×•× ×§×¦×™×” ×”××§×“××ª ××ª ×”×©×—×§×Ÿ ×”×× ×¦×— ×œ×¡×™×‘×•×‘ ×”×‘×
 */
function updateNextMatch(match, winner) {
    if (!match.nextMatchId) {
        tournamentData.winner = winner;
        tournamentData.status = 'finished';
        tournamentData.showChampionModal = true;
        return;
    }

    const nextMatch = getMatchById(match.nextMatchId);
    if (!nextMatch) return;

    if (match.nextPlayerSlot === 1) {
        nextMatch.player1 = winner;
    } else {
        nextMatch.player2 = winner;
    }

    if (nextMatch.player1 && nextMatch.player2) {
        nextMatch.status = 'active';
    }
}

/**
 * ×¡×™×•× ××©×—×§ ×•×§×™×“×•× ×”×× ×¦×—
 */
function advanceWinner(match) {
    if (!match.winner) return;
    updateNextMatch(match, match.winner);
    saveTournamentState();
}


document.getElementById('start-tournament').addEventListener('click', () => {
Â  Â  const currentTeamsCount = tournamentData.teams.length;
Â  Â  if (currentTeamsCount < 2 && tournamentData.status === 'registration') {
Â  Â  Â  Â  showRegistrationAlert(`âš ï¸ × ×“×¨×©×™× ×œ×¤×—×•×ª ×©× ×™ ×©×—×§× ×™× ×›×“×™ ×œ×”×ª×—×™×œ.`, 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // 1. ×”×©×œ××” ××•×˜×•××˜×™×ª ×× ×—×¡×¨
Â  Â  if (currentTeamsCount < MAX_PLAYERS && tournamentData.status === 'registration') {
Â  Â  Â  Â  const requiredCount = MAX_PLAYERS - currentTeamsCount;
Â  Â  Â  Â  for (let i = 0; i < requiredCount; i++) {
Â  Â  Â  Â  Â  Â  const tempName = `××©×œ×™× ××•×˜×•××˜×™ ${i + 1}`;
Â  Â  Â  Â  Â  Â  const nickname = getAvailableNickname(tournamentData.teams);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!nickname) break; // ×¢×¦×™×¨×” ×× ××™×Ÿ ×™×•×ª×¨ ×›×™× ×•×™×™×

Â  Â  Â  Â  Â  Â  const newPlayer = { 
Â  Â  Â  Â  Â  Â  Â  Â  id: generateId(), 
Â  Â  Â  Â  Â  Â  Â  Â  name: tempName, 
Â  Â  Â  Â  Â  Â  Â  Â  nickname: nickname,
Â  Â  Â  Â  Â  Â  Â  Â  isAuto: true 
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  tournamentData.teams.push(newPlayer);
Â  Â  Â  Â  }
Â  Â  Â  Â  showRegistrationAlert(`âœ… ×”×˜×•×¨× ×™×¨ ×”×•×©×œ× ××•×˜×•××˜×™×ª ×œ-${tournamentData.teams.length} ×©×—×§× ×™×.`, 'success');
Â  Â  }

Â  Â  // 2. ×”×¤×¢×œ×ª ×”×˜×•×¨× ×™×¨
Â  Â  if (tournamentData.teams.length >= 2 && tournamentData.status === 'registration') {
Â  Â  Â  Â  generateBracket();
Â  Â  Â  Â  statusMessage.textContent = 'âš”ï¸ ×”×˜×•×¨× ×™×¨ ×”×—×œ! ×™××œ×œ×” ×‘×œ××’×Ÿ! ×œ×—×¥ ×¢×œ ××©×—×§ ×›×“×™ ×œ×¢×“×›×Ÿ ×ª×•×¦××”.';
Â  Â  Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-6 text-cyan-400 bg-slate-800/70 p-3 rounded-xl max-w-4xl mx-auto";
Â  Â  } else if (tournamentData.status !== 'registration') {
Â  Â  Â  Â  renderTournament(tournamentData);
Â  Â  }
});


/**
Â * ××§×“× ×–×•×›×” ××©×—×§ ×‘×•×“×“ ×‘×ª×•×š ××©×—×§ ×”×˜×•×‘ ×-5.
Â */
window.handleGameWin = (matchId, playerSlot) => {
Â  Â  const match = getMatchById(matchId);
Â  Â  if (!match || match.winnerId) return;

Â  Â  if (playerSlot === 1) {
Â  Â  Â  Â  match.gameWins1++;
Â  Â  } else if (playerSlot === 2) {
Â  Â  Â  Â  match.gameWins2++;
Â  Â  }
Â  Â Â 
Â  Â  // ×‘×“×™×§×” ×”×× ×”××©×—×§ ×”×¡×ª×™×™× (×”×¨××©×•×Ÿ ×œ-3)
Â  Â  if (match.gameWins1 === WINS_TO_WIN_MATCH) {
Â  Â  Â  Â  match.winnerId = match.player1.id;
Â  Â  Â  Â  match.winner = match.player1;
Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  advanceWinner(match);
Â  Â  } else if (match.gameWins2 === WINS_TO_WIN_MATCH) { // ×ª×™×§×•×Ÿ ×œ×•×’×™×§×”
Â  Â  Â  Â  match.winnerId = match.player2.id;
Â  Â  Â  Â  match.winner = match.player2;
Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  advanceWinner(match);
Â  Â  } else {
Â  Â  Â  Â  // ×× ×”××©×—×§ ×¢×“×™×™×Ÿ ×œ× ×”×¡×ª×™×™×, ××¢×“×›×Ÿ ××ª ×”××•×“××œ ×•×××©×™×š
Â  Â  Â  Â  saveTournamentState();
Â  Â  Â  Â  window.openModal(matchId);
Â  Â  }
};

// ××ª×—×•×œ ×”××¤×œ×™×§×¦×™×” ×‘×˜×¢×™× ×ª ×”×“×£
window.onload = initializeApp;
</script>
</body>
</html>
