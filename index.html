<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>××¢×¨×›×ª × ×™×”×•×œ ×˜×•×¨× ×™×¨ ×©×©-×‘×© (×”×¨××©×•×Ÿ ×œ-3)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ×”×’×“×¨×•×ª ×’×•×¤×Ÿ ×•×¨×§×¢ ×›×œ×œ×™ */
body {
Â  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
Â  background-color: #1f2937; /* ×¨×§×¢ ×›×”×” */
Â  color: #d1d5db;
Â  padding: 1rem;
}

/* ×¡×’× ×•×Ÿ ×›×¤×ª×•×¨×™× ××™×•×—×“ ×œ××©×—×§×™×•×ª */
button {
Â  Â  transition: all 0.15s ease-in-out;
Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
}
button:hover {
Â  Â  transform: translateY(-1px);
Â  Â  box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.2);
}

/* ×¡×’× ×•×Ÿ ×œ××‘× ×” ×”×˜×•×¨× ×™×¨ */
.match-card {
Â  Â  min-width: 150px;
Â  Â  border-right: 2px solid #374151; /* ×§×• ×”×¤×¨×“×” ×‘×™×Ÿ ××©×—×§×™× */
Â  Â  margin-bottom: 8px;
}
.player-slot {
Â  Â  padding: 6px 10px;
Â  Â  margin: 2px 0;
Â  Â  border-radius: 6px;
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  font-weight: 500;
Â  Â  font-size: 0.9rem;
}
.player-slot-empty {
Â  Â  background-color: #374151;
Â  Â  color: #9ca3af;
Â  Â  font-style: italic;
}
.player-slot-filled {
Â  Â  background-color: #4b5563;
Â  Â  cursor: pointer;
}
.player-slot-winner {
Â  Â  background-color: #10b981; /* ×™×¨×•×§ */
Â  Â  color: #1f2937;
Â  Â  font-weight: 700;
}
.player-slot-loser {
Â  Â  background-color: #ef4444; /* ××“×•× */
Â  Â  color: #1f2937;
Â  Â  text-decoration: line-through;
Â  Â  opacity: 0.7;
}

/* ×¡×’× ×•×Ÿ ××™×•×—×“ ×œ×›×¨×˜×™×¡ ×”× ×™×¦×—×•×Ÿ */
#champion-card {
Â  Â  background: linear-gradient(135deg, #f59e0b, #ef4444);
Â  Â  color: #fff;
Â  Â  padding: 2rem;
Â  Â  border-radius: 12px;
Â  Â  text-align: center;
Â  Â  font-size: 2.5rem;
Â  Â  font-weight: 900;
Â  Â  box-shadow: 0 10px 15px rgba(245, 158, 11, 0.4);
Â  Â  animation: pulse 1.5s infinite;
}

@keyframes pulse {
Â  0% { transform: scale(1); }
Â  50% { transform: scale(1.02); }
Â  100% { transform: scale(1); }
}

</style>
</head>
<body class="rtl text-right">

<div class="text-center py-6 bg-gray-800 rounded-b-xl mb-6 shadow-xl">
Â  <h1 class="text-4xl font-black text-red-500">ğŸ† ××¢×¨×›×ª × ×™×”×•×œ ×˜×•×¨× ×™×¨ ×©×©-×‘×© ğŸ²</h1>
Â  <p class="text-xl text-yellow-400 mt-2">×¤×•×¨××˜: **×”×¨××©×•×Ÿ ×œ-3 × ×™×¦×—×•× ×•×ª ××©×—×§** (×”×˜×•×‘ ×-5)</p>
</div>

<!-- ×›×¤×ª×•×¨×™ ×‘×§×¨×” -->
<div class="flex justify-center mb-4 space-x-4 space-x-reverse">
Â  <button id="start-tournament" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold text-lg hover:bg-green-700 transition duration-150" disabled>×”×ª×—×œ ×˜×•×¨× ×™×¨ (×¦×¨×™×š 8 ×©×—×§× ×™×)</button>
Â Â 
Â  <button id="reset-tournament" onclick="window.resetTournament()" class="bg-gray-600 text-white px-6 py-3 rounded-xl font-bold text-lg hover:bg-red-500 transition duration-150">××¤×¡ ×˜×•×¨× ×™×¨</button>
</div>

<!-- ×”×•×“×¢×•×ª ×¡×˜×˜×•×¡ -->
<div id="status-message" class="text-center text-xl font-semibold mb-4 text-yellow-500"></div>


<!-- ×˜×•×¤×¡ ×¨×™×©×•× ×©×—×§× ×™× -->
<div id="registration-section" class="bg-gray-800 p-6 rounded-xl mb-6 shadow-lg">
Â  <h2 class="text-2xl font-bold text-red-400 mb-4">×¨×™×©×•× ×©×—×§× ×™× (<span id="team-count">0</span>/8)</h2>
Â  <form id="add-team-form" class="flex gap-2 mb-4">
Â  Â  <input id="team-name" class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:ring-red-500 focus:border-red-500" placeholder="×”×›× ×¡ ×©× ×©×—×§×Ÿ..." required />
Â  Â  <button id="add-team" class="bg-blue-600 p-3 rounded-lg hover:bg-blue-700 text-white font-bold" disabled>×”×•×¡×£ ×©×—×§×Ÿ</button>
Â  </form>
Â  <div id="registration-alert" class="text-sm h-4 mb-2 text-center"></div>

Â  <ul id="teams-list" class="mt-4 text-gray-300 space-y-2">
Â  Â  <!-- ×¨×©×™××ª ×”×©×—×§× ×™× ×ª×•×¦×’ ×›××Ÿ -->
Â  </ul>
</div>

<!-- ×ª×¦×•×’×ª ×˜×•×¨× ×™×¨ -->
<div id="tournament-section" class="bg-gray-800 p-6 rounded-xl shadow-lg hidden">
Â  <h2 class="text-2xl font-bold text-red-400 mb-4">×˜×‘×œ×ª × ×•×§×××•×˜</h2>
Â  <div id="bracket" class="flex flex-row-reverse justify-start overflow-x-auto p-2">
Â  Â  <!-- ××‘× ×” ×”×˜×•×¨× ×™×¨ ×™×•×˜×¢×Ÿ ×›××Ÿ -->
Â  </div>
</div>

<!-- ××•×“××œ ×œ×¢×“×›×•×Ÿ ×ª×•×¦××•×ª - ×”×˜×•×‘ ×-5 -->
<div id="result-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
Â  <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md shadow-2xl border border-red-500/50">
Â  Â  <h3 id="modal-title" class="text-2xl font-bold text-yellow-400 mb-2">×¢×“×›×•×Ÿ ×ª×•×¦××ª ××©×—×§</h3>
Â  Â Â 
Â  Â  <div id="modal-score-display" class="text-2xl text-center mb-4 font-extrabold text-white"></div>
Â  Â Â 
Â  Â  <input type="hidden" id="match-id" />

Â  Â  <div class="space-y-4">
Â  Â  Â  Â  <button type="button" id="btn-p1-win" onclick="window.handleGameWin(document.getElementById('match-id').value, 1)" class="w-full bg-blue-600 hover:bg-blue-700 p-3 rounded-lg text-white font-bold transition duration-150 flex justify-between items-center" data-slot="1">
Â  Â  Â  Â  Â  Â  <span id="name-player1" class="text-lg"></span>
Â  Â  Â  Â  Â  Â  <span class="text-lg">× ×™×¦×—×•×Ÿ ×‘××©×—×§</span>
Â  Â  Â  Â  </button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="text-center text-xl font-bold text-red-500">××•</div>

Â  Â  Â  Â  <button type="button" id="btn-p2-win" onclick="window.handleGameWin(document.getElementById('match-id').value, 2)" class="w-full bg-blue-600 hover:bg-blue-700 p-3 rounded-lg text-white font-bold transition duration-150 flex justify-between items-center" data-slot="2">
Â  Â  Â  Â  Â  Â  <span id="name-player2" class="text-lg"></span>
Â  Â  Â  Â  Â  Â  <span class="text-lg">× ×™×¦×—×•×Ÿ ×‘××©×—×§</span>
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <div class="flex justify-end space-x-2 pt-6">
Â  Â  Â  <button type="button" onclick="window.closeModal()" class="bg-gray-600 hover:bg-gray-700 p-3 rounded-lg text-white font-semibold transition duration-150">×‘×™×˜×•×œ / ×—×–×•×¨</button>
Â  Â  </div>
Â  </div>
</div>

<!-- ×”×•×“×¢×ª ×¡×™××•×Ÿ -->
<div id="modal-placeholder" class="fixed inset-0 flex items-center justify-center hidden bg-black bg-opacity-50 z-50">
Â  Â  <div id="champion-card-container" class="max-w-xl bg-gray-800 p-1 rounded-xl">
Â  Â  Â  Â  <div id="champion-card">
Â  Â  Â  Â  Â  Â  <!-- ×”×•×“×¢×ª ×”× ×™×¦×—×•×Ÿ ×ª×•×˜×¢×Ÿ ×›××Ÿ -->
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="text-center p-4">
Â  Â  Â  Â  Â  Â  Â <button onclick="window.closeChampionModal()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition duration-150 shadow-lg">×¡×’×•×¨ ×•×—×–×•×¨ ×œ×œ×•×—</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script type="module">
// --- ×”×’×“×¨×•×ª ×’×œ×•×‘×œ×™×•×ª ---
// ×©× ××¤×ª×— ×”-localStorage ×œ×©××™×¨×ª × ×ª×•× ×™ ×”×˜×•×¨× ×™×¨
const STORAGE_KEY = 'backgammon_tournament_data_v1';
const WINS_TO_WIN_MATCH = 3; // *** ×”×©×™× ×•×™ ×”××‘×•×§×©: ×”×¨××©×•×Ÿ ×œ-3 × ×™×¦×—×•× ×•×ª ××©×—×§ (×”×˜×•×‘ ×-5) ***

// --- DOM elements ---
const teamNameInput = document.getElementById('team-name');
const addTeamButton = document.getElementById('add-team');
const startTournamentButton = document.getElementById('start-tournament');
const teamsListElement = document.getElementById('teams-list');
const teamCountElement = document.getElementById('team-count');
const bracketElement = document.getElementById('bracket');
const registrationSection = document.getElementById('registration-section');
const tournamentSection = document.getElementById('tournament-section');
const statusMessage = document.getElementById('status-message');
const registrationAlert = document.getElementById('registration-alert');
const resultModal = document.getElementById('result-modal');
const championModal = document.getElementById('modal-placeholder');
const championCard = document.getElementById('champion-card');

// ×”×’×“×¨×” ×©×œ ××¦×‘ ×”×ª×—×œ×ª×™
const initialTournamentData = {
Â  Â  teams: [],Â 
Â  Â  status: 'registration', // 'registration', 'in_progress', 'finished'
Â  Â  matches: {
Â  Â  Â  Â  round1: [],
Â  Â  Â  Â  semifinals: [],
Â  Â  Â  Â  final: []
Â  Â  },
Â  Â  winner: null,
Â  Â  showChampionModal: falseÂ 
};

let tournamentData = { ...initialTournamentData }; // ×©×™××•×© ×‘××•×‘×™×™×§×˜ ×”×ª×—×œ×ª×™

// --- Utilities ---

function showRegistrationAlert(message, type = 'info') {
Â  Â  registrationAlert.textContent = message;
Â  Â  registrationAlert.className = `text-sm h-4 mb-2 text-center ${type === 'error' ? 'text-red-400' : 'text-green-400'}`;
Â  Â  setTimeout(() => {
Â  Â  Â  Â  registrationAlert.textContent = '';
Â  Â  Â  Â  registrationAlert.className = 'text-sm h-4 mb-2 text-center';
Â  Â  }, 3000);
}

function shuffle(array) {
Â  for (let i = array.length - 1; i > 0; i--) {
Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  [array[i], array[j]] = [array[j], array[i]];
Â  }
Â  return array;
}

function generateId() {
Â  Â  return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
}

window.closeModal = () => {
Â  Â  resultModal.classList.add('hidden');
};

window.closeChampionModal = () => {
Â  Â  tournamentData.showChampionModal = false;
Â  Â  saveTournamentState(); // ×©××™×¨×” ×•×¨×™× ×“×•×¨ ××—×“×©
}


// --- Local Storage Functions ---

function loadData() {
Â  Â  try {
Â  Â  Â  Â  const storedData = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  if (storedData) {
Â  Â  Â  Â  Â  Â  const parsedData = JSON.parse(storedData);
Â  Â  Â  Â  Â  Â  if (parsedData && Array.isArray(parsedData.teams) && typeof parsedData.status === 'string') {
Â  Â  Â  Â  Â  Â  Â  Â  tournamentData = { ...initialTournamentData, ...parsedData };
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Local Storage: Stored data is corrupted or invalid. Starting fresh.");
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  tournamentData = { ...initialTournamentData };Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  tournamentData = { ...initialTournamentData };Â 
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Local Storage: Error loading data:", e);
Â  Â  Â  Â  tournamentData = { ...initialTournamentData };
Â  Â  }
}

function saveTournamentState() {
Â  Â  try {
Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(tournamentData));
Â  Â  Â  Â  renderTournament(tournamentData); // ×¨×™× ×“×•×¨ ××™×™×“×™ ×œ××—×¨ ×©××™×¨×”
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Local Storage: Error saving data:", e);
Â  Â  Â  Â  showRegistrationAlert("×©×’×™××”: ×œ× × ×™×ª×Ÿ ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™× ×‘×“×¤×“×¤×Ÿ.", 'error');
Â  Â  }
}

window.resetTournament = () => {
Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  tournamentData = { ...initialTournamentData };
Â  Â  initializeApp();
Â  Â  statusMessage.textContent = 'ğŸ§¹ ×”×˜×•×¨× ×™×¨ ××•×¤×¡ ×‘×”×¦×œ×—×”! × ×™×ª×Ÿ ×œ×”×ª×—×™×œ ×¨×™×©×•× ××—×“×©.';
Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-4 text-orange-400 bg-gray-700/50 p-2 rounded-lg";
};


// ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×•×¨×™× ×“×•×¨
function initializeApp() {
Â  Â  loadData();
Â  Â  renderTournament(tournamentData);
Â  Â Â 
Â  Â  addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= 8 || teamNameInput.value.trim() === '';
Â  Â Â 
Â  Â  if (tournamentData.status !== 'registration') {
Â  Â  Â  Â  Â statusMessage.textContent = tournamentData.status === 'finished' ?Â 
Â  Â  Â  Â  Â  Â  '×”×˜×•×¨× ×™×¨ ×”×¡×ª×™×™×! ×œ×—×¥ "××¤×¡ ×˜×•×¨× ×™×¨" ×›×“×™ ×œ×”×ª×—×™×œ ×—×“×©.' :Â 
Â  Â  Â  Â  Â  Â  '×”×˜×•×¨× ×™×¨ ×‘×¢×™×¦×•××•! × ×ª×•× ×™× × ×©××¨×™× ××§×•××™×ª.';
Â  Â  Â  Â  Â statusMessage.className = "text-center text-xl font-semibold mb-4 text-orange-400 bg-gray-700/50 p-2 rounded-lg";
Â  Â  } else {
Â  Â  Â  Â  statusMessage.textContent = "âœ… ××¦×‘ ××§×•××™ (Local Storage) ×¤×¢×™×œ. ×”× ×ª×•× ×™× × ×©××¨×™× ×‘×“×¤×“×¤×Ÿ ×–×”.";
Â  Â  Â  Â  statusMessage.className = "text-center text-xl font-semibold mb-4 text-green-400 bg-gray-700/50 p-2 rounded-lg";
Â  Â  }
}


// --- UI Rendering ---

function renderTournament(data) {
Â  Â  const { teams, status, winner, showChampionModal } = data;

Â  Â  // 1. ×¢×“×›×•×Ÿ ×¨×©×™××ª ×”×©×—×§× ×™× ×•×›×¤×ª×•×¨ ×”×”×ª×—×œ×”
Â  Â  teamsListElement.innerHTML = '';
Â  Â  teamCountElement.textContent = teams.length;
Â  Â Â 
Â  Â  teams.forEach((team, index) => {
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-lg text-white font-medium';Â 
Â  Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  Â  Â  <span>${index + 1}. ${team.name}</span>
Â  Â  Â  Â  Â  Â  <button class="text-red-400 hover:text-red-500 text-sm" onclick="removeTeam('${team.id}')" ${status !== 'registration' ? 'disabled' : ''}>[X] ×”×¡×¨</button>
Â  Â  Â  Â  `;
Â  Â  Â  Â  teamsListElement.appendChild(li);
Â  Â  });

Â  Â  if (teams.length === 0) {
Â  Â  Â  Â  teamsListElement.innerHTML = '<li class="text-gray-500 text-center py-2">×¢×“×™×™×Ÿ ×œ× × ×¨×©××• ×©×—×§× ×™×.</li>';
Â  Â  }

Â  Â  // 2. × ×™×”×•×œ ××¦×‘ ×”×”×¨×©××” ×•×›×¤×ª×•×¨ ×”'×”×ª×—×œ ×˜×•×¨× ×™×¨'
Â  Â  const teamCount = teams.length;
Â  Â  addTeamButton.disabled = tournamentData.status !== 'registration' || teamCount >= 8 || teamNameInput.value.trim() === '';
Â  Â Â 
Â  Â  startTournamentButton.disabled = tournamentData.status !== 'registration' || teamCount !== 8;
Â  Â  startTournamentButton.textContent = teamCount === 8 ? '×”×ª×—×œ ×˜×•×¨× ×™×¨!' : `×”×ª×—×œ ×˜×•×¨× ×™×¨ (×¦×¨×™×š 8 ×©×—×§× ×™×)`;

Â  Â  if (status === 'registration') {
Â  Â  Â  Â  registrationSection.classList.remove('hidden');
Â  Â  Â  Â  tournamentSection.classList.add('hidden');
Â  Â  } else {
Â  Â  Â  Â  registrationSection.classList.add('hidden');
Â  Â  Â  Â  tournamentSection.classList.remove('hidden');
Â  Â  }
Â  Â Â 
Â  Â  // 3. ×”×¦×’×ª ×˜×‘×œ×ª ×”× ×•×§×××•×˜
Â  Â  renderBracket(data.matches, winner, showChampionModal);
}

function renderBracket(matches, tournamentWinner, showChampionModal) {
Â  Â  bracketElement.innerHTML = '';

Â  Â  if (tournamentWinner && showChampionModal) {
Â  Â  Â  Â  championCard.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="flex flex-col items-center space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-6xl">ğŸ‘‘</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-3xl font-extrabold">×”×× ×¦×— ×”×’×“×•×œ:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-6xl font-black">${tournamentWinner.name}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-2xl mt-4">×›×œ ×”×›×‘×•×“ ×¢×œ ×”×–×›×™×™×” ×‘×˜×•×¨× ×™×¨ ×”×©×©-×‘×©!</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  championModal.classList.remove('hidden');
Â  Â  } else {
Â  Â  Â  Â  championModal.classList.add('hidden');
Â  Â  }

Â  Â  const rounds = ['round1', 'semifinals', 'final'];

Â  Â  rounds.forEach((roundKey) => {
Â  Â  Â  Â  const roundMatches = matches[roundKey] || [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  const roundColumn = document.createElement('div');
Â  Â  Â  Â  roundColumn.className = `flex flex-col items-center p-4 min-w-[200px] border-l border-gray-700 mx-1`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const roundTitleMap = { 'round1': '×¡×™×‘×•×‘ 1 (×¨×‘×¢ ×’××¨)', 'semifinals': '×—×¦×™ ×’××¨', 'final': '×’××¨' };
Â  Â  Â  Â  roundColumn.innerHTML = `<h3 class="text-xl font-bold text-yellow-400 mb-4">${roundTitleMap[roundKey]}</h3>`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  roundMatches.forEach(match => {
Â  Â  Â  Â  Â  Â  const matchContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  matchContainer.id = match.id;
Â  Â  Â  Â  Â  Â  matchContainer.className = 'match-card mb-4 p-2 rounded-lg bg-gray-700/50';

Â  Â  Â  Â  Â  Â  const matchInfo = document.createElement('div');
Â  Â  Â  Â  Â  Â  matchInfo.className = 'flex flex-col';

Â  Â  Â  Â  Â  Â  const player1Slot = createPlayerSlot(match, match.player1, match.gameWins1);
Â  Â  Â  Â  Â  Â  const player2Slot = createPlayerSlot(match, match.player2, match.gameWins2);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  matchInfo.appendChild(player1Slot);
Â  Â  Â  Â  Â  Â  matchInfo.appendChild(player2Slot);
Â  Â  Â  Â  Â  Â  matchContainer.appendChild(matchInfo);
Â  Â  Â  Â  Â  Â  roundColumn.appendChild(matchContainer);
Â  Â  Â  Â  });

Â  Â  Â  Â  bracketElement.appendChild(roundColumn);
Â  Â  });
}

function createPlayerSlot(match, player, gameWins) {
Â  Â  const slotEl = document.createElement('div');
Â  Â  slotEl.className = 'player-slot relative';
Â  Â Â 
Â  Â  let playerName = player?.name || (match.status === 'pending' ? '×××ª×™×Ÿ ×œ×–×•×›×”' : '---');
Â  Â  // ×”×¦×’×ª × ×™×¦×—×•× ×•×ª ××©×—×§: × ×¦×™×’ (X/3) ×× ×–×” ×œ× × ×’××¨, ××• ×× ×–×” ×”×× ×¦×— ×”×›×œ×œ×™ (×‘×¡×™×‘×•×‘)
Â  Â  let winsDisplay = gameWins > 0 ? `(${gameWins}/${WINS_TO_WIN_MATCH})` : ''; 
Â  Â Â 
Â  Â  let isWinner = match.winnerId && player && match.winnerId === player.id;
Â  Â  let isLoser = match.winnerId && player && match.winnerId !== player.id;
Â  Â  let isEmpty = !player && match.status !== 'pending';

Â  Â  if (isEmpty) {
Â  Â  Â  Â  slotEl.classList.add('player-slot-empty');
Â  Â  } else if (isWinner) {
Â  Â  Â  Â  slotEl.classList.add('player-slot-winner');
Â  Â  Â  Â  winsDisplay = `(× ×™×¦×—×•×Ÿ ×‘×¡×™×‘×•×‘)`; // ×©×™× ×•×™ ×”×ª×¦×•×’×” ×›××©×¨ ×”×•× ×”×× ×¦×— ×”×›×œ×œ×™
Â  Â  } else if (isLoser) {
Â  Â  Â  Â  slotEl.classList.add('player-slot-loser');
Â  Â  } else if (player) {
Â  Â  Â  Â  slotEl.classList.add('player-slot-filled');
Â  Â  }
Â  Â Â 
Â  Â  // ×”×ª×•×›×Ÿ ×©×œ ×”×¡×œ×•×˜
Â  Â  slotEl.innerHTML = `
Â  Â  Â  Â  <span class="text-base">${playerName}</span>
Â  Â  Â  Â  <span class="font-bold text-sm">${winsDisplay}</span>
Â  Â  `;

Â  Â  // ×”×•×¡×¤×ª ×™×›×•×œ×ª ×œ×—×™×¦×” ×¨×§ ×× ×”××©×—×§ ××•×›×Ÿ ×•×˜×¨× ×”×¡×ª×™×™×
Â  Â  if (!match.winnerId && match.player1 && match.player2) {
Â  Â  Â  Â  slotEl.onclick = () => window.openModal(match.id);
Â  Â  Â  Â  slotEl.classList.add('cursor-pointer', 'hover:bg-red-500/50', 'transition');
Â  Â  }
Â  Â Â 
Â  Â  return slotEl;
}


// --- Tournament Logic ---

window.removeTeam = (playerIdToRemove) => {
Â  Â  if (tournamentData.status !== 'registration') return;
Â  Â  tournamentData.teams = tournamentData.teams.filter(t => t.id !== playerIdToRemove);
Â  Â  saveTournamentState();
}

document.getElementById('add-team-form').addEventListener('submit', (e) => {
Â  Â  e.preventDefault();
Â  Â  const playerName = teamNameInput.value.trim();
Â  Â  if (!playerName || playerName.length < 2) return;

Â  Â  if (tournamentData.teams.length >= 8 || tournamentData.status !== 'registration') {
Â  Â  Â  Â  showRegistrationAlert("×”×’×¢×ª ×œ××’×‘×œ×” (8 ×©×—×§× ×™×) ××• ×”×˜×•×¨× ×™×¨ ×›×‘×¨ ×”×—×œ.", 'error');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if (tournamentData.teams.some(t => t.name === playerName)) {
Â  Â  Â  Â  showRegistrationAlert("×”×©×—×§×Ÿ ×”×–×” ×›×‘×¨ ×¨×©×•×!", 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const newPlayer = { id: generateId(), name: playerName };
Â  Â  tournamentData.teams.push(newPlayer);
Â  Â  teamNameInput.value = '';
Â  Â  teamNameInput.focus();
Â  Â  showRegistrationAlert("×”×©×—×§×Ÿ × ×•×¡×£ ×‘×”×¦×œ×—×”!");
Â  Â Â 
Â  Â  saveTournamentState();Â 
});

teamNameInput.addEventListener('input', () => {
Â  Â  addTeamButton.disabled = tournamentData.status !== 'registration' || tournamentData.teams.length >= 8 || teamNameInput.value.trim() === '';
});


function generateBracket() {
Â  Â  const players = shuffle([...tournamentData.teams]);Â 

Â  Â  const structure = [
Â  Â  Â  Â  { id: 'r1m1', round: 'round1', nextMatchId: 'r2m1', nextPlayerSlot: 1 },
Â  Â  Â  Â  { id: 'r1m2', round: 'round1', nextMatchId: 'r2m1', nextPlayerSlot: 2 },
Â  Â  Â  Â  { id: 'r1m3', round: 'round1', nextMatchId: 'r2m2', nextPlayerSlot: 1 },
Â  Â  Â  Â  { id: 'r1m4', round: 'round1', nextMatchId: 'r2m2', nextPlayerSlot: 2 },
Â  Â  Â  Â  { id: 'r2m1', round: 'semifinals', nextMatchId: 'r3m1', nextPlayerSlot: 1 },
Â  Â  Â  Â  { id: 'r2m2', round: 'semifinals', nextMatchId: 'r3m1', nextPlayerSlot: 2 },
Â  Â  Â  Â  { id: 'r3m1', round: 'final', nextMatchId: null, nextPlayerSlot: null }
Â  Â  ];

Â  Â  const allMatches = structure.map(s => ({
Â  Â  Â  Â  id: s.id,
Â  Â  Â  Â  player1: null,
Â  Â  Â  Â  player2: null,
Â  Â  Â  Â  gameWins1: 0, // NEW: Game wins for Player 1
Â  Â  Â  Â  gameWins2: 0, // NEW: Game wins for Player 2
Â  Â  Â  Â  winnerId: null,
Â  Â  Â  Â  nextMatchId: s.nextMatchId,
Â  Â  Â  Â  nextPlayerSlot: s.nextPlayerSlot,
Â  Â  Â  Â  status: (s.round === 'round1' ? 'active' : 'pending'),
Â  Â  }));

Â  Â  for (let i = 0; i < 4; i++) {
Â  Â  Â  Â  const matchIndex = i;
Â  Â  Â  Â  allMatches[matchIndex].player1 = players[i * 2];
Â  Â  Â  Â  allMatches[matchIndex].player2 = players[i * 2 + 1];
Â  Â  }

Â  Â  const matchesByRound = allMatches.reduce((acc, match) => {
Â  Â  Â  Â  const roundKey = structure.find(s => s.id === match.id).round;
Â  Â  Â  Â  acc[roundKey].push(match);
Â  Â  Â  Â  return acc;
Â  Â  }, { round1: [], semifinals: [], final: [] });

Â  Â  return matchesByRound;
}

startTournamentButton.addEventListener('click', () => {
Â  Â  if (tournamentData.status === 'registration' && tournamentData.teams.length === 8) {
Â  Â  Â  Â Â 
Â  Â  Â  Â  statusMessage.textContent = "××ª×—×™×œ ×˜×•×¨× ×™×¨... ××‘× ×” ×”×˜×•×¨× ×™×¨ ×”×•×’×¨×œ.";
Â  Â  Â  Â  statusMessage.className = 'text-center text-xl font-semibold mb-4 text-green-500';

Â  Â  Â  Â  tournamentData.matches = generateBracket();
Â  Â  Â  Â  tournamentData.status = 'in_progress';
Â  Â  Â  Â  saveTournamentState();Â 
Â  Â  }
});

// ×¤×ª×™×—×ª ××•×“××œ ×¢×“×›×•×Ÿ ×ª×•×¦××” - ××•×ª×× ×œ×”×¨××©×•×Ÿ ×œ-3
window.openModal = (matchId) => {
Â  Â  const match = findMatchById(matchId);
Â  Â  if (!match || match.winnerId) return;

Â  Â  document.getElementById('match-id').value = matchId;
Â  Â Â 
Â  Â  // ×”×’×“×¨×ª ×›×¤×ª×•×¨×™ × ×™×¦×—×•×Ÿ ×•×”×¦×’×ª × ×™×§×•×“ ××©×—×§ × ×•×›×—×™
Â  Â  document.getElementById('name-player1').textContent = match.player1.name;
Â  Â  document.getElementById('name-player2').textContent = match.player2.name;

Â  Â  document.getElementById('modal-score-display').textContent =Â 
Â  Â  Â  Â  `×ª×•×¦××” × ×•×›×—×™×ª: ${match.gameWins1} - ${match.gameWins2} (×”×¨××©×•×Ÿ ×œ-${WINS_TO_WIN_MATCH})`;
Â  Â Â 
Â  Â  resultModal.classList.remove('hidden');
};

function findMatchById(matchId) {
Â  Â  for (const roundKey in tournamentData.matches) {
Â  Â  Â  Â  const match = tournamentData.matches[roundKey].find(m => m.id === matchId);
Â  Â  Â  Â  if (match) return match;
Â  Â  }
Â  Â  return null;
}

function updateMatch(matchId, newMatchData) {
Â  Â  for (const roundKey in tournamentData.matches) {
Â  Â  Â  Â  const index = tournamentData.matches[roundKey].findIndex(m => m.id === matchId);
Â  Â  Â  Â  if (index !== -1) {
Â  Â  Â  Â  Â  Â  tournamentData.matches[roundKey][index] = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  ...tournamentData.matches[roundKey][index],Â 
Â  Â  Â  Â  Â  Â  Â  Â  ...newMatchDataÂ 
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  return tournamentData.matches[roundKey][index];
Â  Â  Â  Â  }
Â  Â  }
Â  Â  return null;
}

// ×œ×•×’×™×§×” ×—×“×©×”: ×˜×™×¤×•×œ ×‘× ×™×¦×—×•×Ÿ ××©×—×§ ×‘×•×“×“
window.handleGameWin = (matchId, winnerSlot) => {
Â  Â  const currentMatch = findMatchById(matchId);
Â  Â  if (!currentMatch || currentMatch.winnerId) return;

Â  Â  let newWins1 = currentMatch.gameWins1;
Â  Â  let newWins2 = currentMatch.gameWins2;
Â  Â  let roundWinner = null;

Â  Â  if (winnerSlot === 1) {
Â  Â  Â  Â  newWins1++;
Â  Â  Â  Â  if (newWins1 === WINS_TO_WIN_MATCH) {
Â  Â  Â  Â  Â  Â  roundWinner = currentMatch.player1;
Â  Â  Â  Â  }
Â  Â  } else if (winnerSlot === 2) {
Â  Â  Â  Â  newWins2++;
Â  Â  Â  Â  if (newWins2 === WINS_TO_WIN_MATCH) {
Â  Â  Â  Â  Â  Â  roundWinner = currentMatch.player2;
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  return; // ×©×’×™××”
Â  Â  }

Â  Â  // 1. ×¢×“×›×•×Ÿ ×”××©×—×§ ×”× ×•×›×—×™ ×¢× × ×™×¦×—×•× ×•×ª ××©×—×§
Â  Â  const updatedMatch = updateMatch(matchId, {
Â  Â  Â  Â  gameWins1: newWins1,
Â  Â  Â  Â  gameWins2: newWins2,
Â  Â  Â  Â  winnerId: roundWinner ? roundWinner.id : null, // ×× ×™×© ×–×•×›×” ×‘×¡×™×‘×•×‘
Â  Â  });
Â  Â Â 
Â  Â  // 2. ×§×™×“×•× ×× ×”×•×©×’ × ×™×¦×—×•×Ÿ ×‘×¡×™×‘×•×‘
Â  Â  if (roundWinner) {
Â  Â  Â  Â  if (updatedMatch.nextMatchId) {
Â  Â  Â  Â  Â  Â  const nextMatch = findMatchById(updatedMatch.nextMatchId);
Â  Â  Â  Â  Â  Â  if (nextMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  // × ×ª×•× ×™× ××§×•×“××™× (×¨×§ ×”-ID ×•×”×©×)
Â  Â  Â  Â  Â  Â  Â  Â  const promotedPlayer = { id: roundWinner.id, name: roundWinner.name };
Â  Â  Â  Â  Â  Â  Â  Â  const slotKey = updatedMatch.nextPlayerSlot === 1 ? 'player1' : 'player2';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ×¢×“×›×•×Ÿ ×”××©×—×§ ×”×‘×
Â  Â  Â  Â  Â  Â  Â  Â  updateMatch(nextMatch.id, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [slotKey]: promotedPlayer,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: (nextMatch.player1 && nextMatch.player2) ? 'active' : 'pending'Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // ×× ××™×Ÿ nextMatchId, ×–×” ×”×’××¨!
Â  Â  Â  Â  Â  Â  tournamentData.status = 'finished';
Â  Â  Â  Â  Â  Â  tournamentData.winner = roundWinner;
Â  Â  Â  Â  Â  Â  tournamentData.showChampionModal = true;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  window.closeModal(); // ×¡×’×™×¨×ª ×”××•×“××œ ×¨×§ ×× ×”×¡×™×‘×•×‘ ×”×¡×ª×™×™×
Â  Â  } else {
Â  Â  Â  Â  // ×× ×”××©×—×§ ×××©×™×š, ×¡×’×•×¨ ××ª ×”××•×“××œ ×•×¨× ×“×¨ ××—×“×© ×œ×”×¦×’×ª ×”× ×™×§×•×“ ×”××¢×•×“×›×Ÿ
Â  Â  Â  Â  window.closeModal();
Â  Â  }

Â  Â  // ×©××™×¨×” ×•×¨×™× ×“×•×¨
Â  Â  saveTournamentState();
};


// --- Bootstrap ---
window.onload = initializeApp;

</script>
</body>
</html>
